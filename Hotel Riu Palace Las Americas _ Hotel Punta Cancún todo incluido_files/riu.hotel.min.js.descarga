app.factory('serviceSlideHome', function($http, $q, riuService, constantes){
	return  {
		getABT: function(nombre) {
			var url = constantes.serverS + "/json-utils!checkAbTesting.action?formato=json&v=web2017&params.modo=normal&"+
									   "params.test="+nombre+"&params.variante=nada&request.aspect=desk&modo=noCache";
			var defer = $q.defer();
			$http.get(url, {withCredentials: true}).success(function(data)
			{
				defer.resolve(data);
    			}).error(function(data, status, headers, config) 
			{
			});
			return defer.promise;
		},
		getOfeMacro: function() {
			var url = constantes.serverS + "/ofertas!getOfertasMacro.action?formato=json&v=web2017&tipo=movil&idioma="+constantes.idioma+"&request.aspect=desk&conPromociones=true&request.aspect=desk";
			var defer = $q.defer();
			$http.get(url, {withCredentials: true}).success(function(data)
			{
				defer.resolve(data);
    			}).error(function(data, status, headers, config) 
			{
			});
			return defer.promise;
		},
		getSlides: function(idHotel) {
			var hotel = "";
			var config ="solo-promociones";
			if (angular.isDefined(idHotel)){
				hotel = "&idHotel="+idHotel;
			}else{
				config ="solo-promociones-all"
			}
			var url = constantes.serverS + "/ofertas!getOfertasHome.action?formato=json&v=web2017&configuracion="+ config +"&request.aspect=desk&idioma="+constantes.idioma + hotel ;
			var defer = $q.defer();
			$http.get(url, {withCredentials: true}).success(function(data)
			{
				defer.resolve(data);
			}).error(function(data, status, headers, config) 
			{
			});
			return defer.promise;
		}
	}
});
app.directive('onLastSlide', function() {
	return function(scope, element, attrs) {
		if (scope.$last){ 
			$('#promo-slide-carousel').carousel({interval: 10000});
		  } ;
        };
});
app.component("slideHome", {
	templateUrl: function(constantes) { return "/"+constantes.idioma+constantes.templateFolder+"/cmp-slide-home.jsp?request.aspect=desk"; },
	controller: ctrlSlideHome
});
app.component("slideHotel", {
	templateUrl: function(constantes) { return "/"+constantes.idioma+constantes.templateFolder+"/cmp-slide-home.jsp?request.aspect=desk"; },
	bindings : { idhotel:'@', hotel : '@', modulo: '@'},
	controller: ctrlSlideHome
});
ctrlSlideHome.$inject = ['$scope', 'serviceSlideHome', '$q', '$rootScope', '$window'];
function ctrlSlideHome($scope, serviceSlideHome, $q, $rootScope, $window) {
	$scope.slides = [];
	//var C_BF = "BOXINGDAY2017";
	$scope.v_cache =  window.v_cache_fotos;	
	$scope.setBanner = function(tipo, oferta) {
		if(tipo == 'max') {
			$("#header").css("background-image", "url('"+oferta.urlImg+"?v="+$scope.v_cache+"'), linear-gradient(to right, #171717 50%,#ffffff 50%,#ffffff 100%)");  
			$('.link-promo').attr('href', oferta.urlLink);
			$("body").addClass("header-promo");
			var vh_title = $('.ico-vuelo-hotel').parent().attr('title');
			var vh_href = $('.ico-vuelo-hotel').parent().attr('href');
			if (vh_title)
				$('#search-form').find('.container').append('<div class="vuelo-hotel-box"><a href="'+vh_href+'" aria-controls="buscador-vuelo-hotel" class="vuelo-hotel-link">'+vh_title+'</a></div>');
		}
		if(tipo == 'min') {
			$('.banner-promo-home').find("img").attr('src', oferta.macro.urlImg+"?v="+$scope.v_cache); 
			$('.banner-promo-home').attr('href', oferta.macro.urlLink);
			$("body").addClass("header-promo-banner");
		}
	}
	$q.all([serviceSlideHome.getOfeMacro(), serviceSlideHome.getSlides($scope.$ctrl.idhotel)]).then(function(d) {
			var baner = [];
			if(d[0].recomendadas) {baner=d[0].recomendadas;}
			angular.forEach( d[1], function(oferta) {
				if (oferta.tipo=="promocion") {
					oferta.urlLink = oferta.urlLink.replace(/amp;/g,'');
					if(window.innerWidth <= 480 && oferta.urlImgMacro && oferta.ordenMacro < 100)
						oferta.urlImg = oferta.urlImgMacro
					angular.forEach(baner, function(rec) { 
						for(var i = 0; i < rec.length; i++)
							if (rec[i].nombre == oferta.nombre) {
								oferta['macro'] = rec[i];
							}
					});
					if (oferta.macro && oferta.macro.orden > 99) {
						switch(oferta.macro.orden) {
							case 100 : $scope.setBanner( "min", oferta ); break;
							case 200 : $scope.setBanner( "max", oferta ); break;
							default : serviceSlideHome.getABT(oferta.nombre).then(function(data) { if (data.varianteFinal) $scope.setBanner( data.varianteFinal, oferta )});
						}
					}
					if (angular.isUndefined($scope.$ctrl.idhotel) && oferta.orden == 100){
						// Home y promoción sólo para la ficha del hotel
						oferta = null;
					}
					/*
					if (oferta.nombre.indexOf(C_BF) == 0 ) {
						// Llamar al abtesting
						$q.all([serviceSlideHome.getOfeMacro(), serviceSlideHome.getABT()]).then(function(data) {
							var ab = data[1];
							var baner = [];
							var baner_BF;
							if(data[0].recomendadas) {baner=data[0].recomendadas;}
							angular.forEach(baner, function(rec) { 
								for(var i = 0; i < rec.length; i++)
									if (rec[i].nombre == oferta.nombre) {
										baner_BF = rec[i];
									}
							});
							if(ab.varianteFinal && ab.varianteFinal == 'max') {
								$("#header").css("background-image", "url('"+oferta.urlImg+"?v="+$scope.v_cache+"'), linear-gradient(to right, #171717 50%,#ffffff 50%,#ffffff 100%)");  
								$('.link-promo').attr('href', oferta.urlLink);
								$("body").addClass("header-promo");
								var vh_title = $('.ico-vuelo-hotel').parent().attr('title');
								var vh_href = $('.ico-vuelo-hotel').parent().attr('href');
								if (vh_title)
									$('#search-form').find('.container').append('<div class="vuelo-hotel-box"><a href="'+vh_href+'" aria-controls="buscador-vuelo-hotel" class="vuelo-hotel-link">'+vh_title+'</a></div>');
							}
							if(ab.varianteFinal && ab.varianteFinal == 'min' && baner_BF) {
								$('.banner-promo-home').find("img").attr('src', baner_BF.urlImg+"?v="+$scope.v_cache); 
								$('.banner-promo-home').attr('href', baner_BF.urlLink);
								$("body").addClass("header-promo-banner");
							}
						});
					}*/
					if (oferta && oferta.urlImg) $scope.slides.push(oferta);
				}
			});
                        // Datos para DY
                       var data = $scope;
                       var id = data.$parent.hotelActual.ID_RUMBO;
                       if(DY.recommendationContext){
                          DY.recommendationContext.data = [];
                          DY.recommendationContext.data.push(id)
                       }
	});
}


app.factory('serviceFichaHot', function($http, $q, riuService, constantes, $timeout, $rootScope){
	var infoHot = "";
	var infoPai = "";
	var fotos;
	var video;
	var servicios;
	var infoDest;
        var hotelsVideoHeader = [
		{'id': '5801', 'startAt': 0}, // Riu Plaza NewYork
        	{'id': '2801', 'startAt': 20}, // Riu Cancun
       		{'id': '3104', 'startAt': 8}, // Riu Palace Aruba
        	{'id': '7201', 'startAt': 7}, // Riu Atoll
        	{'id': '7202', 'startAt': 7}, // Riu Palace Maldivas
        	{'id': '581', 'startAt': 0} // Riu Plaza Madrid
	];
	return  {
		getInfoHot : function(){ return infoHot; },
		setInfoHot : function(f){
			infoHot = f;
			$timeout(function(){ 
				$rootScope.$broadcast('end_fotos_load'); },2000
				);
		},
		getVideo : function(){
			if(video.indexOf("https") >= 0){
				return video;	
			}else{
				return video.replace('http', 'https');	
			}
		},
		setVideo : function(v){	video = v; },
		getFotosHotel : function(){	return fotos; },
		setFotosHotel : function(v){ fotos = v;	},		
		getServiciosHotel : function(){	return servicios; },
		setServiciosHotel : function(s){ servicios = s;	},			
		getInfoPai : function(){return infoPai;},
		setInfoPai : function(v){infoPai = v;},
		getInfoDest : function(){ return infoDest; },
		setInfoDest : function(d){ infoDest = d; },
		getDatosJSON: function(url){
			var defer = $q.defer();
			$http.get(url, {withCredentials: true, headers: {"Content-Type": "application/json"} } )
				.success(function(data){ defer.resolve(data); })
				.error(function(data, status, headers, config){ defer.resolve(status); });
			return defer.promise;
		},
		getConfig: function(pagina) {
			var url = constantes.idioma + "/json/modulos_hotel.json";
			if (pagina=="grupos") url = constantes.idioma + "/json/modulos_hotel_grupos.json";
			if (pagina=="bodas")  url = constantes.idioma + "/json/modulos_hotel_bodas.json";
			var defer = $q.defer();
			var servicio = constantes.serverS +  "/json-utils!getUrl.action?formato=json&params.refresh=1&v=web2017&params.url=/"+url;
			$http.get(servicio, {withCredentials: true } )
				.success(function(data){ defer.resolve(data); })
				.error(function(data, status, headers, config){ defer.resolve(status); });		
			return defer.promise;
		},
		getServiciosJSON: function(idHotel) {
			var url = constantes.serverS +  "/destinos-hoteles!temporada.action?idRumboHotel="+idHotel+"&formato=json&v=web2017&idioma="+constantes.idioma;
			var defer = $q.defer();
			$http.get(url, {withCredentials: true} )
				.success(function(data){ defer.resolve(data); })
				.error(function(data, status, headers, config){ defer.resolve(status); });
			return defer.promise;
		},
		getAB: function(test) {
			var url = constantes.serverS + "/json-utils!checkAbTesting.action?formato=json&v=web2017&params.modo=Cookies&"+
										   "params.test="+test+"&params.variante=true&request.aspect=desk";
			var defer = $q.defer();
			$http.get(url, {withCredentials: true}).success(function(data)
				{
					defer.resolve(data);
				}).error(function(data, status, headers, config) 
				{
				});
				return defer.promise;
			},
		reindexarMenu: function() {
			var i = 0;
			angular.forEach( $rootScope.rootModulos, function(m) {	
				if (m.caption!='' && m.visible) {
					//console.log("["+m.index+" --> "+ (i + 1)+"] mostrando " + m.caption);
					i = i + 1;
					m.index = i;
					var sizeMobile = $(window).width() < 753 ? true : false;
					if(sizeMobile) {
						m.hideTemplate = false;
					}
					else {
						m.hideTemplate = (m.index > 5)&&($rootScope.ab.okTest=="true");
					}
				} else {
					//console.log("["+m.index+" --> 999] ocultando " + m.caption);
					m.index = 999;
				}
			});
			$rootScope.numMenuOption = i;
		},
		getHotelsVideoHeader: function() { return hotelsVideoHeader; }
	}
});
app.component("fcGw", {
	templateUrl: function($attrs) { return $attrs.template ; },
	bindings : { idhotel:'@', hotel : '@'}
});
app.component("fcCrownLevel", {
	templateUrl: function($attrs) { return $attrs.template ; },
	bindings : { idhotel:'@', hotel : '@'}
});
/***********************************************************************************/
/***********************************************************************************/
app.component("fcRe", {
	templateUrl: function($attrs) { return $attrs.template ; },
	bindings : { idhotel:'@', hotel : '@'},
	controller : ctrlReunionesEventos
});
function ctrlReunionesEventos($scope, serviceFichaHot, ngDialog){
	$scope.showPopupReuniones= function() {
		$scope.popup = ngDialog.open({ template: 'popup_r_e'});
	}
}
/***********************************************************************************/
/***********************************************************************************/
app.component("fcBodas", {
	templateUrl: function($attrs) { return $attrs.template ; },
	bindings : { idempresa:'@', idhotel:'@', hotel : '@'},
	controller: ctrlBodas
});
function ctrlBodas($scope, serviceFichaHot, $q, $http, constantes){
	$scope.idhotel =$scope.$ctrl.idhotel;
	$scope.nombre =$scope.$ctrl.hotel;
	$scope.infoBoda = null;
	$scope.urlBoda = constantes.serverS + '/' + constantes.idioma + '/bodas/' ; 	
}
/***********************************************************************************/
/***********************************************************************************/
//smoothscroll
function setSmoothscroll() {
    $('#menu-hotel a[href^="#"]').on('click', function (e) {
        e.preventDefault();
        $(document).off("scroll");
        $('a').each(function () {
            $(this).parent().removeClass('current');
        })
        $(this).parent().addClass('current');
        var target = this.hash,
            menu = target;
        $target = $(target);
        $('html, body').stop().animate({
            'scrollTop': $target.offset().top+2
        }, 500, 'swing', function () {
            window.location.hash = target;
            $(document).on("scroll", onScroll);
        });
    });
}
app.directive('onLastOpcionMenu', function() {
	return function(scope, element, attrs) {
		if (scope.$last){ 
			setTimeout(setSmoothscroll, 500);
		  } ;
        };
});
app.controller("ctrlFichaHotel", ["$location", "$anchorScroll", "serviceTC", "serviceGTM", "$templateCache", "$window", "$filter", "$rootScope", "$timeout", "$scope",'serviceFichaHot', "$compile", "riuclassService", "riuService", "ngDialog", "$sce", "constantes", "$q", "$http", ctrlFichaHotel]);
ctrlFichaHotel.$inject = ['$location', '$anchorScroll', 'serviceTC', 'serviceGTM', '$templateCache', '$window', '$filter', '$rootScope', '$timeout', '$scope', 'serviceFichaHot' , '$compile', 'riuclassService', 'riuService', 'ngDialog', '$sce', 'constantes', '$q', '$http'];
	app.controller('ctrlModulo', function($rootScope, $scope, serviceFichaHot) {
		this.getModule = function() {
			return $rootScope.rootModulos[$scope.$ctrl.modulo];
		};
		this.show = function() {
			if ($scope.$ctrl.modulo) {
				$rootScope.rootModulos[$scope.$ctrl.modulo].visible = true;
				serviceFichaHot.reindexarMenu();
			}
		};
		this.hide = function() {
			if  ($scope.$ctrl.modulo) {
				$rootScope.rootModulos[$scope.$ctrl.modulo].visible = false;
				serviceFichaHot.reindexarMenu();
			}
		}
	})
function ctrlFichaHotel( $location, $anchorScroll, serviceTC, serviceGTM, $templateCache, $window, $filter, $rootScope, $timeout, $scope, serviceFichaHot, $compile, riuclassService, riuService, ngDialog, $sce, constantes, $q, $http ) {
	$scope.fccontenido = '';
	$scope.idRumboHotel = ''; //VAR JSP
	//$scope.hotelActual = [];
	$scope.modulos;
	$scope.servicios;
	//$scope.paisActual = [];
	//$scope.destinoActual = [];
	$scope.tieneBodas = false;
	$scope.showPopupImg = function() {
		$('.galeria-magnific').magnificPopup('open');
	}
	var js = "";
        $scope.backgroundImage = function(img) {
		return {'background-image': 'url(' + img + ')'};
	}
    $scope.clickMapaManu = function(){
        $('#idBtnMap').click();
    }
	$scope.setModulosHtml = function(a){
		var strHtml = "";
		$scope.modulos = a;
		if(a && a.length > 1){
			for (var i = 0; i < a.length; i++){
				var tmp = a[i].template;
				if (tmp != '') 
					a[i].visible = a[i].visible && (angular.isDefined($templateCache.get(tmp)));
				if(a[i].visible == true){
					if(window.location.href.indexOf('#') > 0){
                        var vAncla = window.location.href.substr(window.location.href.indexOf('#')+1,window.location.href.length);
                        if(a[i].ancla == vAncla)
                            strHtml = '<'+a[i].modulo +' ng-hide="false"  modulo="'+i+'" iddestino="'+$scope.destinoActual.ID_UNICO +'" template="'+tmp+'" idempresa="'+$scope.hotelActual.ID+'" idhotel="'+ $scope.hotelActual.ID_RUMBO +'" hotel="'+ $scope.hotelActual.NOMBRE + '"></' + a[i].modulo +'>';
                        else
                            strHtml = '<'+a[i].modulo +' ng-hide="$root.rootModulos['+i+'].hideTemplate"  modulo="'+i+'" iddestino="'+$scope.destinoActual.ID_UNICO +'" template="'+tmp+'" idempresa="'+$scope.hotelActual.ID+'" idhotel="'+ $scope.hotelActual.ID_RUMBO +'" hotel="'+ $scope.hotelActual.NOMBRE + '"></' + a[i].modulo +'>';                     
                    }else{
                        strHtml = '<'+a[i].modulo +' ng-hide="$root.rootModulos['+i+'].hideTemplate"  modulo="'+i+'" iddestino="'+$scope.destinoActual.ID_UNICO +'" template="'+tmp+'" idempresa="'+$scope.hotelActual.ID+'" idhotel="'+ $scope.hotelActual.ID_RUMBO +'" hotel="'+ $scope.hotelActual.NOMBRE + '"></' + a[i].modulo +'>';
                    }
					var content = $compile(strHtml)($scope);
					$('#fc-contenedor').append(content);
				}
			}
		}
		$timeout(function(){ 
			$rootScope.$broadcast('end_load_data_hotel'); }, 500
		);
	}
	$scope.showPDF= function(){
		return (constantes.idioma!='ru' && constantes.idioma!='zh');
	}
	$scope.setParams = function(idRumboHotel, video, pagina, geoIp) {
		$scope.geoIp = geoIp;
		$scope.idRumboHotel = idRumboHotel;
		serviceFichaHot.setVideo(video);
		var js = constantes.serverS + constantes.idioma + "/_JS/angular-1.5.8/" + "riu-app-angular-hotel-habitaciones.js";
		var json = "fotos.json";
		if(pagina == 'bodas'){ json = ''; }	
		if (pagina=="grupos") json = "fotos_grupos.json";
                $scope.showVideoIcon = false;
		$q.all([riuService.getDestinosHoteles(), riuService.getFotosHotelJSON($scope.idRumboHotel, json), serviceFichaHot.getAB("HIDE_TEMPLATE_HOTEL") ]).then(function(data){
			var paisIt = null;
			$scope.fotos_hotel = data[1];
			$rootScope.ab = data[2];
			serviceFichaHot.setFotosHotel($scope.fotos_hotel);
			$rootScope.rootFotos = $scope.fotos_hotel;
			angular.forEach(data[0].PAIS, function(pais) {
				paisIt = pais;
				angular.forEach(pais.DESTINO, function(destino) {
					angular.forEach(destino.HOTEL, function(hotel) {
						destino["NOMBRE"] = destino.NAME;
						if (angular.isDefined(destino.AREA) && destino.AREA != destino.NAME)
							destino["NOMBRE"] = destino.AREA + " - " + destino["NOMBRE"];
						if(hotel.ID_RUMBO == $scope.idRumboHotel){
							$scope.hotelActual = hotel;
							$scope.paisActual = paisIt;
							$window.dataLayer.push({"tipoHotel " : hotel.CIUDAD == 'Si'?'plaza':'vacacional'});
							$scope.destinoActual = destino;
							serviceFichaHot.setInfoHot(hotel);
							serviceFichaHot.setInfoPai(paisIt);
							serviceFichaHot.setInfoDest(destino);
							$rootScope.rootHotel = hotel;
							$rootScope.rootPais = paisIt;
							$rootScope.rootDestino = destino;
							$scope.tieneBodas = $filter('isBoda')(hotel);
							$scope.tieneGolf = $filter('isGolf')(hotel);
							$scope.tieneWellness = $filter('isWellness')(hotel);							
							$q.all([serviceFichaHot.getConfig(pagina), serviceFichaHot.getServiciosJSON(hotel.ID) ] ).then(function(config) {
								serviceFichaHot.setServiciosHotel(config[1]);
								$rootScope.rootServicios = config[1];
								$scope.servicios = config[1];
								$scope.config = config[0];
								angular.forEach($scope.config, function(c) {
									if(c.modulo=="fc-bodas" && !$scope.tieneBodas) {c.visible = false;}
									if(c.modulo=="fc-tripadvisor" && $scope.hotelActual.ID_TRIPADV == '') {c.visible = false;}
									// OCULTAMOS VIDEO PARA MAURICIO
									if(c.modulo=="fc-video" && $scope.geoIp=="MU" && $rootScope.rootDestino.ID_UNICO == "130290" ) {c.visible = false;}
                                                                        // SHOW-HIDE ICONO VIDEO EN CABECERA (MÓVIL)
                                                                        if(c.modulo=="fc-video" && c.visible && video !== '') {
										$scope.showVideoIcon = true;
									}
									if(c.modulo=="fc-gw") {
										if ($scope.tieneGolf && $scope.tieneWellness) c.caption = "Golf & Wellness";
										else if ($scope.tieneGolf) c.caption = "Golf";
										else if ($scope.tieneWellness) c.caption = "Wellness";
										c.visible = c.visible & ($scope.tieneGolf || $scope.tieneWellness);
									}
									if (c.hoteles!="" && c.visible) {
										var hoteles = c.hoteles.replace('-','').split(',');
										var existe = _.indexOf(hoteles, hotel.ID_RUMBO) > -1;
										var excluir = c.hoteles.indexOf('-') > -1;
										c.visible = (!excluir&&existe)||(excluir&&!existe);
									}
								});
								$rootScope.rootModulos = $scope.config;
								serviceFichaHot.reindexarMenu();
								$scope.setModulosHtml($scope.config);
								// Si hay un ancla en la URL
								var a = $location.hash();
								if (a!="") {
									setTimeout(function(){
										$location.hash(a);
										$anchorScroll();
									}, 2000);
								}
							});
							//----------------------------------------------
							riuService.setDestinoVisto(destino.ID_UNICO, paisIt.ISO, hotel.ID_RUMBO);
							//----------------------------------------------
							serviceTC['hotel'] = hotel;
							serviceTC['pais'] = paisIt;
							serviceTC['destino'] = destino;
							serviceTC['foto'] = $scope.fotos_hotel && $scope.fotos_hotel[0]? constantes.serverS +"/"+ $scope.fotos_hotel[0].url.substring(1):'';
							serviceTC.setTC('hotel');
							var data = {};
							data['tipoPagina'] = 'HOTEL';
							data['idHotel'] = hotel.ID_RUMBO;
							data['nombrePais'] = paisIt.NAME;
							data['nombreDestino'] = destino.NAME;
							data['timestamp'] = Math.floor(Date.now() / 1000);
							data['nombreHotel'] = hotel.NOMBRE;
							data['urlHotel'] = document.URL;
							data['imgHotel'] = $scope.fotos_hotel && $scope.fotos_hotel[0]? constantes.serverS +"/"+ $scope.fotos_hotel[0].url.substring(1):'';
							data['imgHotel2'] = constantes.serverS +"/images/hotels/"+ hotel.ID_RUMBO + ".jpg";
							data['event'] = 'gtm.hotel';
							serviceGTM.setGTM(data);
						}
					});
				}); 
			});
		});
}
	}


(function() {
	'use strict'
	app.factory('serviceHotelFotos', function($http, $q, riuService, constantes){
		return  {
		}
	});
	app.component("fcFotos", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder+"/cmp-fc-fotos.jsp"; },
		bindings : { idhotel:'@', hotel : '@', modulo: '@'},
		controller: ctrlGaleriaFotos
	});
	app.component("fcFotosGrupos", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder+"/cmp-fc-fotos.jsp"; },
		bindings : { idhotel:'@', hotel : '@', modulo: '@'},
		controller: ctrlGaleriaFotos
	});
	ctrlGaleriaFotos.$inject = ['$rootScope', '$scope', 'riuService', 'serviceHotelFotos', 'serviceFichaHot', '$controller'];
	function ctrlGaleriaFotos($rootScope, $scope, riuService, serviceHotelFotos, serviceFichaHot, $controller) {
		angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
		$scope.imagenesOcultas = 0;
		$scope.max = 0;
		$scope.tipImg = 'NORMAL';
		$scope.urlIframe = '';
		$scope.idhotelParams = $scope.$ctrl.idhotel;
		$scope.arr360FotHot = [
			{img:'/fcs_images/riu2017/lobby-riu-plaza-espana-360.jpg', label: 'Lobby', type:'COMMON_AREAS' , iframe:"https://my.matterport.com/show/?m=a3edLu3ubye&lp=1&ts=1&hl=0&mf=1"},
			{img:'/fcs_images/riu2017/terraza-21-riu-plaza-espana-360-v2.jpg', label: 'Planta 21 Terrace', type:'COMMON_AREAS' , iframe:"https://my.matterport.com/show/?m=dU5BHABLv75&lp=1&ts=1&hl=0&mf=1"},
			{img:'/fcs_images/riu2017/pool-riu-plaza-espana-360.jpg', label: 'Rooftop Pool', type:'COMMON_AREAS' , iframe:'https://my.matterport.com/show/?m=ziwJctdnwBs&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/lobbybar-riu-plaza-espana-360.jpg', label: 'Lobby Bar', type:'COMMON_AREAS' , iframe:'https://my.matterport.com/show/?m=mJHKjpeaMnF&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/colon-riu-plaza-espana-360.jpg', label: 'Colón', type:'MICE' , iframe:'https://my.matterport.com/show/?m=AdHDzFhetK8&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/foyer-riu-plaza-espana-360.jpg', label: 'Foyer Area', type:'MICE' , iframe:'https://my.matterport.com/show/?m=NZWWfJUVruB&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/madrid-1-riu-plaza-espana-360.jpg', label: 'Madrid 1', type:'MICE' , iframe:'https://my.matterport.com/show/?m=qHMncf2Kkt4&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/madrid-15-riu-plaza-espana-360.jpg', label: 'Madrid 1-5 + terraza', type:'MICE' , iframe:'https://my.matterport.com/show/?m=yuSt5hYY4eo&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/madrid-23-riu-plaza-espana-360.jpg', label: 'Madrid 2-3', type:'MICE' , iframe:'https://my.matterport.com/show/?m=PfCRSABaib2&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/360-bar-riu-plaza-espana-360.jpg', label: '360 Rooftop Bar', type:'RESTAURANT' , iframe:'https://my.matterport.com/show/?m=1tUo3Tndogr&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/cervantes-riu-plaza-espana-360.jpg', label: 'Buffet Cervantes', type:'RESTAURANT' , iframe:'https://my.matterport.com/show/?m=HyvriMtamsc&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/skybar-riu-plaza-espana-360.jpg', label: 'Sky Bar', type:'RESTAURANT' , iframe:'https://my.matterport.com/show/?m=LrDySRfVwZ2&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/vip-rooftop-riu-plaza-espana-360.jpg', label: 'Vip Rooftop', type:'RESTAURANT' , iframe:'https://my.matterport.com/show/?m=gj9JenAR3tv&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/latina-riu-plaza-espana-360.jpg', label: 'La Latina', type:'RESTAURANT' , iframe:'https://my.matterport.com/show/?m=rkJfAAJkXRU&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/superior-twin-riu-plaza-espana-360.jpg', label: 'Deluxe Superior twin', type:'ROOM' , iframe:'https://my.matterport.com/show/?m=NF36bbbrsSc&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/junior-suite-riu-plaza-espana-360.jpg', label: 'Jr. Suite con terraza', type:'ROOM' , iframe:'https://my.matterport.com/show/?m=nm219T3pTTc&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/king-riu-plaza-espana-360.jpg', label: 'Deluxe King', type:'ROOM' , iframe:'https://my.matterport.com/show/?m=pmjrwsCdqdc&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/presidential-riu-plaza-espana-360.jpg', label: 'Presidential Suite', type:'ROOM' , iframe:'https://my.matterport.com/show/?m=ZBcFmvDsDej&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/familiar-riu-plaza-espana-360.jpg', label: 'Deluxe Familiar', type:'ROOM' , iframe:'https://my.matterport.com/show/?m=8xz4tQZav2T&lp=1&ts=1&hl=0&mf=1'}
		];
		$scope.arr360FotEven = [
			{img:'/fcs_images/riu2017/colon-riu-plaza-espana-360.jpg', label: 'Colón', type:'MICE' , iframe:'https://my.matterport.com/show/?m=AdHDzFhetK8&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/foyer-riu-plaza-espana-360.jpg', label: 'Foyer Area', type:'MICE' , iframe:'https://my.matterport.com/show/?m=NZWWfJUVruB&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/madrid-1-riu-plaza-espana-360.jpg', label: 'Madrid 1', type:'MICE' , iframe:'https://my.matterport.com/show/?m=qHMncf2Kkt4&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/madrid-15-riu-plaza-espana-360.jpg', label: 'Madrid 1-5 + terraza', type:'MICE' , iframe:'https://my.matterport.com/show/?m=yuSt5hYY4eo&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/madrid-23-riu-plaza-espana-360.jpg', label: 'Madrid 2-3', type:'MICE' , iframe:'https://my.matterport.com/show/?m=PfCRSABaib2&lp=1&ts=1&hl=0&mf=1'},
			{img:'/fcs_images/riu2017/latina-riu-plaza-espana-360.jpg', label: 'La Latina', type:'RESTAURANT' , iframe:'https://my.matterport.com/show/?m=rkJfAAJkXRU&lp=1&ts=1&hl=0&mf=1'}
		];
                if(window.location.href.indexOf('grupos.jsp') > 0)
			$scope.arr360Fot = $scope.arr360FotEven;
		else
			$scope.arr360Fot = $scope.arr360FotHot;
		//console.log(this.getModule());
		//this.getModule().visible = false;
		$scope.showNum = 6;
		$scope.showNum360 = 6;
		$scope.showMore = function() {
			$scope.showNum = $scope.showNum + 6;
		}
		$scope.showMore360 = function() {
			$scope.showNum360 = $scope.showNum360 + 6;
		}
		$scope.getUrlIframe = function(i){
			$scope.urlIframe = $scope.arr360Fot[i].iframe;
			document.getElementById('iframe360').src = $scope.urlIframe;
		}
		$scope.changeNormal360 = function() {
			$scope.tipImg = $scope.tipImg == 'NORMAL'? 'IMG360': 'NORMAL';
		}
		$scope.imagenes = $rootScope.rootFotos;
		if ($scope.imagenes.length >= 7 )
			$scope.imagenesOcultas = $scope.imagenes.length - 7;
		else if ($scope.imagenes.length >= 6 )
			$scope.imagenesOcultas = $scope.imagenes.length - 6;	
		$scope.max = $scope.imagenes.length - $scope.imagenesOcultas;
	}
}());


(function() {
	'use strict'
	app.factory('serviceHotelServicios', function($http, $q, riuService, constantes, $rootScope){
		return  {
			getServiciosJSON: function(idHotel) {
				var url = constantes.serverS +  "/destinos-hoteles!temporada.action?idRumboHotel="+idHotel+"&formato=json&v=web2017&idioma="+constantes.idioma;
				var defer = $q.defer();
				$http.get(url, 
				{withCredentials: true} ).success(function(data)
				{
					//console.log(data);
					defer.resolve(data);
				}).error(function(data, status, headers, config) 
				{
					defer.resolve(status);
				});
				return defer.promise;
			}
		}
	});
	app.component("fcServicios", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder+ "/cmp-fc-servicios.jsp"; }, 
		bindings : { idhotel:'@', hotel : '@', modulo: '@'},
		controller: ctrlServiciosHotel
	});
	ctrlServiciosHotel.$inject = ['$scope', '$rootScope', 'riuService', 'serviceHotelServicios', 'serviceFichaHot', 'ngDialog', '$controller'];
	function ctrlServiciosHotel($scope, $rootScope, riuService, serviceHotelServicios, serviceFichaHot, ngDialog, $controller) {
		/*serviceHotelServicios.getServiciosJSON($scope.$ctrl.idhotel).then(function(d) {
			$scope.servicios = d;
		});*/
		angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
		$scope.v_cache=window.v_cache_fotos;		
		//$scope.$on('end_load_data_hotel', function(event, args) {
		//	$scope.servicios = serviceFichaHot.getServiciosHotel();
		//});
		$scope.modulo = this;
		$scope.servicios = $rootScope.rootServicios;
		if (!$scope.servicios) $scope.modulo.hide();
		$scope.showInfo = function(info, title){
			ngDialog.open({
				template: '	<div class="hotel-services"><div class="modal-title"><h4>{{ngDialogData.title}}</h4></div><div class="info-servicios"><span ng-bind-html="ngDialogData.info"></span></div></div>'	,
				plain : true,
				data: {info : info, title :  title}
			});
		}
	}
}());

(function() {
	'use strict'
	app.factory('serviceHotelDestino', function($http, $q, riuService, constantes){
		return  {
			getDestinoJSON: function(u) {
				var url = u.replace("index.jsp", "") + "destino.json";
				var defer = $q.defer();
				$http.get(url, 
				{withCredentials: true, headers: {"Content-Type": "application/json"} } ).success(function(data)
				{
					defer.resolve(data);
				}).error(function(data, status, headers, config) 
				{
					defer.resolve(status);
				});
				return defer.promise;
			},
			getDestinosPreferidosJSP: function() {
	/* Servicio para la personalización (en construcción)
				var url = constantes.serverS + "/json-utils!getDestinosByMercado.action?formato=json&v=web2017&idioma="+constantes.idioma;
				var defer = $q.defer();
				$http.get(url, {withCredentials: true } ).success(function(data)
				{
					defer.resolve(data);
				}).error(function(data, status, headers, config) 
				{
					defer.resolve(status);
				});
				return defer.promise;
*/
				var defer = $q.defer();
				var url = constantes.idioma + "/json/destinos.json";
				var servicio = constantes.serverS +  "/json-utils!getUrl.action?formato=json&v=web2017&params.url=/"+url;
				$http.get(servicio, {withCredentials: true } ).success(function(data)
				{
					defer.resolve(data);
				}).error(function(data, status, headers, config) 
				{
					defer.resolve(status);
				});
				return defer.promise;
			},
			getDestinoUriUrlJSON: function(idRumbo) {
				var url = constantes.serverS + "/destinos-hoteles!infoCodigosDestino.action?formato=json&v=web2017&idioma="+constantes.idioma+"&idUnicoDestino="+idRumbo+"&request.aspect=desk";
				var defer = $q.defer();
				$http.get(url, 
				{withCredentials: true, headers: {"Content-Type": "application/json"} } ).success(function(data)
				{
					defer.resolve(data);
				}).error(function(data, status, headers, config) 
				{
					defer.resolve(status);
				});
				return defer.promise;
			}
		}
	});
	app.component("fcInfoDestino", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder+ "/cmp-fc-info-destino.jsp"; },
		bindings : { idhotel:'@', hotel : '@'},
		controller: ctrlDestinoHotel
	});
	ctrlDestinoHotel.$inject = ['$q', '$scope', '$rootScope', 'riuService', 'serviceHotelDestino', 'serviceFichaHot', 'ngDialog'];
	function ctrlDestinoHotel($q, $scope, $rootScope, riuService, serviceHotelDestino, serviceFichaHot, ngDialog) {
		$scope.info_destino;
		$scope.v_cache=window.v_cache_fotos;
		//$scope.$on('end_load_data_hotel', function(event, args) {
			$scope.servicios = $rootScope.rootServicios;
			$scope.pais =$rootScope.rootPais;
			$scope.pais_foto = "/fcs_images/guia-destinos/guia_"+$scope.pais.ISO+"_G.jpg?v="+$scope.v_cache;
			//delete $scope.pais.DESTINO;
			//$scope.pais['ISO']="ES";
			$scope.destino = $rootScope.rootDestino;
			$scope.destino_foto = "/fcs_images/guia-destinos/guia_"+$scope.pais.ISO+"_"+$scope.destino.ID_UNICO+"_2x1.jpg?v="+$scope.v_cache;
			//delete $scope.destino.HOTEL;
			$q.all([serviceHotelDestino.getDestinoJSON($scope.destino.URL), serviceHotelDestino.getDestinoUriUrlJSON($scope.destino.ID_UNICO), serviceHotelDestino.getDestinosPreferidosJSP()]) .then(function(d) {
				console.log(d[0]);
				$scope.info_destino = d[0];
				$scope.fotos_destino = d[1].IMAGENES;
				$scope.destinos_mercado = d[2];
			});
		//});
		/*
		$scope.showInfo = function(info, title){
			ngDialog.open({
				template: '\
				<div class="contentModal">\
					<h4>{{ngDialogData.title}}</h4>\
					<div class="ifo-servicios">\
						<span ng-bind-html="ngDialogData.info"></span>\
					</div>\
				</div>'	,
				plain : true,
				data: {info : info, title :  title}
			});
		}
		*/
	}
}());


(function() {
	'use strict'
	app.factory('serviceHotelOfertas', function($http, $q, riuService, constantes){
		return  {
			getOfertasJSON: function(idHotel, codOfe) {
				var parametros = '';
				if(codOfe){
					parametros = "request.aspect=desk&tipo=destacadaMacro&idOferta="+codOfe+"&configuracion=ratingTA&formato=json&v=web2017&idioma="+constantes.idioma;
				}
				else
					parametros = "request.aspect=desk&tipo=activa&idHotel="+idHotel+"&configuracion=ratingTA&formato=json&v=web2017&idioma="+constantes.idioma;
				var url = constantes.serverS +  "/ofertas!getOferta.action?" + parametros;
				var defer = $q.defer();
				$http.get(url, 
				{withCredentials: true} ).success(function(data)
				{
					defer.resolve(data);
				}).error(function(data, status, headers, config) 
				{
					defer.resolve(status);
				});
				return defer.promise;
			}
		}
	});
	app.component("fcOfertasDest", {
		templateUrl:  function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder+"/cmp-hotel-ofertas.jsp"; },
		bindings : { idhotel:'@', hotel : '@', modulo : '@'},
		controller: ctrlOfertasHotel
	});
	ctrlOfertasHotel.$inject = ['$location', "$anchorScroll", '$scope', 'constantes', 'serviceHotelOfertas','serviceFichaHot', '$controller', '$cookies', '$http', '$timeout'];
	function ctrlOfertasHotel($location,$anchorScroll, $scope, constantes, serviceHotelOfertas, serviceFichaHot, $controller, $cookies, $http, $timeout){
		angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
		$scope.idhotel =$scope.$ctrl.idhotel;
		$scope.ofertasHotel = null
		$scope.hotelActual = serviceFichaHot.getInfoHot();
		//console.info('hotelActual');
		//console.info($scope.hotelActual);
		$scope.nombre =$scope.$ctrl.hotel;
		$scope.modulo = this;
		$scope.codOfe = $location.search().codOferta;
		$scope.modulo.hide();
		$scope.templateDetalle = "/"+constantes.idioma+ constantes.templateFolder+"/cmp-detalle-oferta.jsp";
		$scope.swiABTest = false;
		$scope.adsBlocked = function (callback){
          let cookie = $cookies.get('mt.v'); 
            var url = "https://api.monetate.net/api/engine/v1/decide/riu.com";
            let obj = {
                    "channel": "a-c3db960f/p/riu.com",
                    "events": [
                        {
                            "eventType": "monetate:decision:DecisionRequest",
                            "requestId": Math.floor((Math.random() * 10000) + 1).toString()
                        },
                        {
                           "eventType": "monetate:context:UserAgent",
                           "userAgent": navigator.userAgent
                        },
                        {
                            "eventType": "monetate:context:PageView",
                            "url": window.location.host + window.location.pathname
                        }
                    ]
                };
            if(cookie)
                obj["monetateId"] = cookie;
            var paramStr =  JSON.stringify(obj);
            var transform = function(data){
					return $.param(data);
				}
            return $http.post(url, JSON.stringify(obj));
        }
        $scope.SetDatalayerMoneteInfo = function(obj){
			for(var i = 0; i < obj.length; i++){
				var resp = obj[i];
				if(resp.actions && resp.actions.length > 0){
					for(var j = 0; j < resp.actions.length; j++){
						var act = resp.actions[j];
						if(act.json && act.json.swiGA && act.json.swiGA == true){
							window.dataLayer.push({
							'event':'GAEvent',
							'eventCategory':'Monetate',
							'eventAction':act.json.exp,
							'eventLabel': act.json.variante
							});
						}
					}
				}
			}
		}
		$scope.adsBlocked().then(function (res) {
			$scope.swiABTest = false;
			if (res.data && res.data.data && res.data.data.responses && res.data.data.responses.length > 0){
				$scope.SetDatalayerMoneteInfo(res.data.data.responses);
				var r = res.data.data.responses;
				for(var i = 0; i < r.length; i++){
					var resp = r[i];
					if(resp.actions && resp.actions.length > 0){
						for(var j = 0; j < resp.actions.length; j++){
							var act = resp.actions[j];
							if(act.json && act.json.exp && act.json.exp == 'OfertasHomeToFichaHot' && act.json.variante == 'Experiment'){
								$scope.swiABTest = true;
								break;
							}
						}
					}
				}
			}
			});
		$scope.openFecha = function(){
			//$( "#divCalendario1" ).trigger( "click" );
			if(document.querySelector('.buscador-movil-wrap.ng-scope')){
				$( ".form-group.modal-busc-trigger" ).trigger( "click" );
				    var calendarTrigger = document.querySelector('#divCalendario1');
					var wrappedCalendarTrigger = angular.element(calendarTrigger);
					$timeout(function () {
				        angular.element(wrappedCalendarTrigger).triggerHandler('click');
				    }, 500);
			}else{
				var calendarTrigger = document.querySelector('#divCalendario1');
				var wrappedCalendarTrigger = angular.element(calendarTrigger);
				$timeout(function () {
			        angular.element(wrappedCalendarTrigger).triggerHandler('click');
			    }, 500);
			}
		}
		//$scope.modulo = this.getModule();
		serviceHotelOfertas.getOfertasJSON($scope.idhotel, "").then(function(data) {
			angular.forEach( data, function(oferta) {
				oferta["impfinal"] = parseFloat(oferta.impfinal);
				oferta["imptarifa"]= parseFloat(oferta.imptarifa);	
			});
			if ($scope.codOfe != "") {
				data = _.sortBy(data, function(item){return item.id_ws === $scope.codOfe ? 0 : 1} )
			}
			$scope.ofertasHotel = data;
			//console.info('$scope.ofertasHotel');
			//console.info($scope.ofertasHotel);
			//if (data.length==0)
			//	$scope.modulo.hide();
			if (data.length!=0)
				$scope.modulo.show();
		});		
	}
}());


(function() {
	'use strict'
	app.factory('serviceHotelGrupos', function($http, $q, riuService, constantes){
		return  {
			/*getXMLgrupos: function(idHotel) {
				var url = constantes.serverS +  "/json-utils!getDestinosHotelesGrupos.action?formato=json&v=web2017&idioma="+constantes.idioma;
				var defer = $q.defer();
				$http.get(url, 
				{withCredentials: true} ).success(function(data)
				{
					//console.log(data);
					defer.resolve(data);
				}).error(function(data, status, headers, config) 
				{
					defer.resolve(status);
				});
				return defer.promise;
			}*/
		}
	});
	app.component("fcEventosSociales", {
		templateUrl: function($attrs) { return $attrs.template ; },
		bindings : { idhotel:'@', hotel : '@'}
	});
	app.component("fcEventosCorporativos", {
		templateUrl: function($attrs) { return $attrs.template ; },
		bindings : { idhotel:'@', hotel : '@'}
	});
	app.component("fcGruposIncentivos", {
		templateUrl: function($attrs) { return $attrs.template ; },
		bindings : { idhotel:'@', hotel : '@'}
	});	
	app.component("fcBuscadorGrupos", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder+ "/cmp-buscador-grupos.jsp"; },
		bindings : { idhotel:'@', hotel : '@'},
		controller : ctrlBuscadorGrupos		
	});	
	ctrlGaleriaFotos.$inject = ['$scope', 'riuService', 'serviceHotelGrupos'];
	function ctrlGaleriaFotos($scope, riuService, serviceHotelGrupos) {
	}
	ctrlBuscadorGrupos.$inject = ['$scope', 'riuService', 'serviceHotelGrupos'];
	function ctrlBuscadorGrupos($scope, riuService, serviceHotelGrupos) {
		$scope.grupos = [];
		$scope.comboGrupos = [];
		$scope.hoteles = [];
		$scope.selector = "radioD";
		$scope.hotelesfilter = [];
		$scope.criteriaMatch = function() {
			return function( item ) {
				if ( $scope.selector == 'radioD' && $scope.sDestino )
					return item.DESTINO === $scope.sDestino.DESTINO;
				if ( $scope.selector == 'radioH' && $scope.sHotel )
					return item.IDRUMBO === $scope.sHotel.IDRUMBO;
				if ( $scope.selector == 'radioG' && $scope.sTipo ) {
					var index = _.indexOf(item.TIPOSGRUPO.TIPOGRUPO, $scope.sTipo );
					console.log(item.TIPOSGRUPO.TIPOGRUPO + ' ' + index);
					return index > -1;
					//angular.forEach( item.TIPOSGRUPO.TIPOGRUPO, function(tipo) {
					//	if (tipo === $scope.sTipo) return true;
					//});
					//return false;
				}
			};
		};
		$scope.filtraHoteles = function() {
			$scope.hotelesfilter = [];
			angular.forEach($scope.hoteles, function(item) {
				var ok = false;
				if ( $scope.selector == 'radioD' && $scope.sDestino )
					ok = item.DESTINO === $scope.sDestino.DESTINO;
				if ( $scope.selector == 'radioH' && $scope.sHotel )
					ok =item.IDRUMBO === $scope.sHotel.IDRUMBO;
				if ( $scope.selector == 'radioG' && $scope.sTipo ) {
					var index = _.indexOf(item.TIPOSGRUPO.TIPOGRUPO, $scope.sTipo );
					ok =index > -1;
				}
				if (ok) $scope.hotelesfilter.push(item);
			});
		};	
		riuService.getDestinosURIURL().then(function(uri) {
			$scope.URIURL = uri.HOTEL;
			console.log(uri);
			riuService.getXMLgrupos().then(function(g) {
					$scope.grupos = g;
					console.log($scope.grupos);
					angular.forEach($scope.grupos.PAIS, function(pais) {
						angular.forEach(pais.DESTINO, function(d) {
							console.log(d.AREA);
							angular.forEach(d.HOTEL, function(h) {
								//console.log(h);
								//$scope.hoteles.push({ "ID":h.IDRUMBO, "NAME":h.NOMBRE, "PAIS":pais.NAME });
								var index = _.findIndex($scope.URIURL, {'ID_RUMBO' : h.IDRUMBO.toString()} );
								if (index >= 0)
									h.THUMBNAIL = $scope.URIURL[index].IMAGEN_503;
								h["PAIS"] = pais.NAME;
								h["DESTINO"] = d.NAME;
								if (d.ZONA) h["DESTINO"] = d.ZONA;
								$scope.hoteles.push(h);
								angular.forEach(h.TIPOSGRUPO.TIPOGRUPO,function(grupo){
								  if (!_.includes($scope.comboGrupos, grupo) && typeof grupo != 'undefined') {
									$scope.comboGrupos.push(grupo);
								  }
								});
							});
						});
					});
					console.log($scope.hoteles);
			});
		});
	}
}());

(function() {
	'use strict'
	app.component("fcReqDoc", {
		templateUrl: function($attrs) { return $attrs.template ; },
		bindings : { idempresa:'@', idhotel:'@', hotel : '@'}
	});
	app.component("fcFaqs2017", {
		templateUrl: function($attrs) { return $attrs.template ; },
		bindings : { idempresa:'@', idhotel:'@', hotel : '@'}
	});	
	app.component("fcPaqBoda", {
		templateUrl: function($attrs) { return $attrs.template ; },
		bindings : { idempresa:'@', idhotel:'@', hotel : '@', },
		controller : ctrlPaqBoda
	});
	app.component("bodaDesde", {
		template: '<span ng-if="min!=0"> {{$ctrl.desde}} {{ min }} <span>',
		bindings : { idempresa:'@', desde : '@' },
		controller : ctrlPaqBoda
	});
	app.component("fcBuscadorBodas", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder +"/cmp-fc-buscador-bodas.jsp";},
		bindings : { idempresa:'@', selecteddate : '@' },
		controller : ctrlBusBoda
	});
	app.controller("ctrlBusBoda", ["$scope", "$rootScope", "serviceFichaHot", "$q", "$http", "constantes", "riuService",ctrlBusBoda]);
	function ctrlBusBoda($scope, $rootScope, serviceFichaHot, $q, $http, constantes, riuService){
		$scope.idEmpresa = $scope.$ctrl.idempresa; //$rootScope.rootHotel.ID;
		$scope.idioma = 'en';
		if(constantes.idioma == 'es')
			$scope.idioma = 'es';
		$scope.$on('end_load_data_hotel', function(event, args) {
			$scope.hotelActual = $rootScope.rootHotel;
		});
		$scope.paises_json = null;
		$scope.paiSelected = null;
		$scope.tipoCere = null; 
		$scope.destinoSelected = null;
		$scope.destinations = null;
		$scope.verHotel = 'N';
		$scope.cereSelect = '7';
		$scope.getURLPageForWeddingsSearch = function(){
			$scope.tipoCere = null;
			var parametros ={
					call : 'getURLPageForWeddingsSearch',
					ctx : 'information',
					hotel_id : $scope.idEmpresa,
					lang : $scope.idioma
			};
			$.getJSON('/' + $scope.idioma +'/bodas/CallManager', 
					parametros, function(data){
					$.ajax({
						type: "GET",
						url: data.url+"&auxId=aux",
						dataType: "html",
						success: function( contents ){
							if(contents){
								contents = contents.replace('name="tipo_ceremonia"', 'name="tipo_ceremonia" id="tipo_ceremonia"');
								var select = $(contents).find("#tipo_ceremonia");
								$scope.tipoCere = new Array();
								if(select[0].options && select[0].options.length){
									for(var i = 0; i < select[0].options.length; i++){
										$scope.tipoCere.push({
											'value': select[0].options[i].value,
											'text': select[0].options[i].textContent
										});
									}
								}
							}
						}
					});
				});	
			}
		$scope.refreshCountriesDestinationsJSON = function(){
			var parametros = {
					call : 'getComboCountriesDestinations',
					ctx : 'combos'
				};
				$.ajaxSetup( {
					cache : false
				});
				$.getJSON('/' + $scope.idioma +'/bodas/CallManager', parametros, function(data) {
					$scope.paises_json = data;
				});
			}	
		$scope.validateSearch = function(){
			if($scope.verHotel == 'N')
				$scope.validateSearchInputsHotel();
			else
				$scope.validateSearchInputs();
		}
		$scope.validateSearchInputsHotel = function(){
			var inForm = $('#fBusqBoda');
			if( inForm[0].elements["dia_boda"].value == "dd/mm/yyyy" || inForm[0].elements["dia_boda"].value == "" ){
					//alert( "Selecciona una fecha" );
					riuService.showErrorMsg(etiquetas_bodas["selectFecha"]);
			}else{
				if( $scope.cereSelect == '7'){
					//alert( "Selecciona un tipo de ceremonia" );
					riuService.showErrorMsg(etiquetas_bodas["selectCeremonia"]);
				}else {	
					inForm[0].action ='/' + $scope.idioma +'/bodas/CallManager';
                                        inForm[0].elements["hotel"].value  = $scope.$ctrl.idempresa;
					inForm[0].elements["tipo_ceremonia"].value = parseInt($scope.cereSelect);
					inForm[0].submit();
				}
			}
		}
		$scope.validateSearchInputs = function(){
			var inForm = $('#fBusqBoda');
			inForm[0].elements["hotel"].value = null;
			if( inForm[0].elements["dia_boda"].value == "dd/mm/yyyy" || inForm[0].elements["dia_boda"].value == "" ){
				if( inForm[0].elements["pais"].value == -1 ){			
					inForm[0].action ='/' + constantes.idioma +'bodas/destinos/paises_destinos.jsp';
					inForm[0].submit();
				}else {	
					riuService.showErrorMsg(etiquetas_bodas["selectFecha"]);
				}
			}else{
				if(  parseInt($scope.paiSelected) == -1 ){
					riuService.showErrorMsg(etiquetas_bodas["selectPais"]);
				} else if( inForm[0].elements["destino"].value == -1 ){
					riuService.showErrorMsg(etiquetas_bodas["selectDestino"]);
				} else if( inForm[0].elements["tipo_ceremonia"].value == '7'){
					riuService.showErrorMsg(etiquetas_bodas["selectCeremonia"]);
				}else {	
					inForm[0].elements["pais"].value = $scope.paiSelected;
					inForm[0].elements["destino"].value = $scope.destinoSelected;
					inForm[0].elements["tipo_ceremonia"].value = parseInt($scope.cereSelect);
					inForm[0].action ='/' + $scope.idioma +'/bodas/CallManager';
					inForm[0].submit();
				}
			}
		}
		$scope.cambiohotel2 = function(id){
			$('#preservaGratuita'+id).show();
			$('#preservaGratuita'+id+'_3').hide();
		}
		$scope.populateCountryJSON = function() {
			var destinations = "";
			$scope.destinations = null;
			$scope.destinoSelected = null;
			for (var i=0; i < $scope.paises_json.countries.length; i++) {
				if( $scope.paises_json.countries[i].code == $scope.paiSelected ){
					$scope.destinations = $scope.paises_json.countries[i].destinations;
					if($scope.destinations && $scope.destinations.length == 1)
						$scope.destinoSelected = $scope.destinations[0].code;
					break;	
				}
			}
		}
		angular.element(document).ready(function () {
			$scope.infoHot = serviceFichaHot.getInfoHot();
			$scope.calendario = $scope.$ctrl.selecteddate;
			$scope.refreshCountriesDestinationsJSON();
			$scope.getURLPageForWeddingsSearch();
			var cal = $('input[name="dia_boda"]');
			cal.daterangepicker({
				autoUpdateInput: true,
				opens: "center",
				singleDatePicker: true,
				minDate: moment(), //hoy
				autoApply: true,
				locale: {
					firstDay: $scope.idioma == 'es' ?1 : 0,
					format: 'DD/MM/YYYY',
					customRangeLabel: 'Otra fecha',
					daysOfWeek: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi','Sa'],
					monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
				}
			});
		});
	}
	function ctrlPaqBoda($scope, serviceFichaHot, $q, $http, constantes){
		$scope.idhotel =$scope.$ctrl.idhotel;
		$scope.nombre = $scope.$ctrl.hotel;
		$scope.idEmpresa =  $scope.$ctrl.idempresa;
		$scope.infoPaq = null;
		$scope.temp1 = null;
		$scope.temp2 = null;
		$scope.catalogos = null;
		$scope.tempActiva = null;
		$scope.min = 0;
		$scope.idioma = 'en';
		if(constantes.idioma == 'es')
			$scope.idioma = 'es';
		$scope.getURLPageForHotelExtraServicesGroups = function (){
			var parametros ={	
					call : 'getURLPageForHotelExtraServicesGroups',
					ctx : 'information',						
					hotel_id : $scope.idEmpresa,					
					lang : $scope.idioma					
				};					
				$.getJSON('/' + $scope.idioma +'/bodas/CallManager', parametros, function(data){
					if (data.url!="") {
						$.ajax({
							type: "GET",
							url: data.url,
							dataType: "html",
							success: function( contents ){
								if(contents && contents.trim()){
									$(".servicesContainer").html( contents );
								}else{
									$(".otros-servicios-bodas").parent().addClass('hide');
									$(".info-catalogos").parent().addClass('col-sm-12');
									$(".info-catalogos").parent().removeClass('col-sm-7');
								}
							}						
						});					
					}
				});			
		}
		$scope.getPackageInfoForHotel = function(temp) {
			var arr = new Array();
			for(var i = 0; i < temp.paquetes.length; i++){
				arr.push(temp.paquetes[i].id);
			}
			var parametros = {
					call : 'getPackageInfoForHotel',
					package_backcode_ids :arr,
					ctx : 'information',
					hotel_id : $scope.idEmpresa,
					lang : $scope.idioma
				};
				$.getJSON('/' + $scope.idioma +'/bodas/CallManager', parametros, function(data){
					var temp;
					var minPrice = 999999999;
					var minPriceCompact;
					var nombretemp='';
					var precio='';
					for (var i=0; i < data.packages.length; i++) {
						temp = data.packages[i].backcode;
						if (parseInt(data.packages[i].price) < parseInt(minPrice) ) {
							minPrice = parseInt(data.packages[i].price);
							minPriceCompact = data.packages[i].compactprice;
						}							
						nombretemp = ".bodas" + temp;
						precio = data.packages[i].compactprice;	
						$(nombretemp).html( precio);						
					}						
					$("#precio_minimo").html( minPriceCompact);
					$("#precio_minimo1").html( minPriceCompact);
					$scope.min = minPriceCompact;
				});
		}
		$scope.getinfoBodJSON = function(url) {
			return serviceFichaHot.getDatosJSON(url);
		}
		$scope.getinfoBodJSON('paquetesBoda.json').then(function(d) {
			$scope.infoPaq = new Array()
			$scope.infoPaq.push(d[0]);
			if (d.length >2 ) $scope.infoPaq.push(d[1]);
			$scope.catalogos = new Array();
			$scope.temp1= $scope.infoPaq[0];
			$scope.temp2= $scope.infoPaq[1];
			$scope.literales =d[d.length-1] && d[d.length-1].etiquetas && d[d.length-1].etiquetas[0]?d[d.length-1].etiquetas[0]:null;
			$scope.tempActiva = 1;
			for(var i = 0; i <  d.length; i ++){
				if(d[i].documentos){
					for(var j = 0; j <d[i].documentos.length; j++){
						$scope.catalogos.push(d[i].documentos[j]);
					}	
				}
			}
			angular.element(document).ready(function () {
				 setTimeout(function(){
						$('.paq0').addClass('active');
						$('.tmp0').removeClass('hide');
						$('input[type=radio][name=temporadas]').on('change', function() {
							if ($(this).val() == $scope.temp1.temporada){
								$('.tmp0').removeClass('hide');
								$('.tmp1').addClass('hide');
								$scope.tempActiva = 1;
							} 
							else{
								$('.tmp1').removeClass('hide');
								$('.tmp0').addClass('hide');
								$scope.tempActiva = 2;
							}
				        });
				 });
			 });
			$scope.getPackageInfoForHotel($scope.temp1);
			$scope.getPackageInfoForHotel($scope.temp2);
			$scope.getURLPageForHotelExtraServicesGroups();	
			//$scope.buscadorBodas();
		});	
	}
}());	


(function() {
	'use strict'
	app.factory('serviceHotelMapa', function($http, $q, riuService, constantes){
		return  {
			strToCoor : function(strCoor){
				var objCoor = null;
				if(strCoor && strCoor.length > 0){
					var GPS = strCoor.replace(' ', '').trim();
					var coor1 = GPS.substring(0, GPS.indexOf(",")); 
					var coor2 = GPS.substring(GPS.indexOf(",")+1); 
					objCoor=[{
						'coor1': coor1,
						'coor2': coor2
					}];
				}
				return objCoor;
			}
		}
	});
	app.component("fcMapas", {
		templateUrl:  function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder+"/cmp-fc-mapas.jsp"; },
		bindings : { idhotel:'@', hotel : '@'},
		controller: ctrlMapas
	});
	app.component("fcMapaLink", {
		template: "",
		bindings : { idhotel:'@', hotel : '@'},
		controller: function (constantes, serviceFichaHot, serviceHotelMapa, ngDialog) {
			$('#verMapCab').on('click', function(e) {
				this.infoHot = serviceFichaHot.getInfoHot();
				this.servHot = serviceFichaHot.getServiciosHotel();
				if (this.servHot) this.infoHot.SITUACION = this.servHot.SITUACION;
				else this.servHot = [];
				serviceHotelMapa.strToCoor(this.infoHot.GPS);
				ngDialog.open({
					template: "/"+constantes.idioma+ constantes.templateFolder+"/cmp-fc-popup-mapa.jsp",
					data : [this.infoHot, this.servHot],
					showClose: false,
					className: 'ngdialog-theme-default'
				});
			});
		}
	});
	ctrlMapas.$inject = [ '$scope', '$rootScope', 'constantes',  'serviceHotelMapa', 'serviceFichaHot', '$controller'];
	function ctrlMapas( $scope, $rootScope, constantes, serviceHotelMapa, serviceFichaHot, $controller) {
		angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
		$scope.obtenerFotos= function(numLlamada) {
			var fotos = serviceFichaHot.getFotosHotel();
			if(fotos){
				$scope.posAleatoria = Math.floor((Math.random() * fotos.length ));
				$scope.fotos = fotos[$scope.posAleatoria];
			}else if(numLlamada < 3){
				setTimeout(function(){ $scope.obtenerFotos(numLlamada+1); }, 500);
			}
		}
		$scope.templateDetalle = "/"+constantes.idioma+ constantes.templateFolder+"/cmp-fc-popup-mapa.jsp"; 
		$scope.idhotel =$scope.$ctrl.idhotel;
		$scope.nombre =$scope.$ctrl.hotel;
		$scope.infoHot = serviceFichaHot.getInfoHot();
		$scope.infoPai = serviceFichaHot.getInfoPai();
		$scope.servHot = serviceFichaHot.getServiciosHotel();
		if ($scope.servHot) $scope.infoHot.SITUACION = $scope.servHot.SITUACION;
		else $scope.servHot = [];
		$scope.configMap = null;
		$scope.directionsDisplay = null;
		$scope.directionsService = null;
		$scope.cargaJsMap = false;
		var coorAer = null;
		serviceFichaHot.getDatosJSON('infoMapa.json').then(function(d) {
			$scope.configMap = d && d[0]?d[0]:null;
		});	
		var coorHot = serviceHotelMapa.strToCoor($scope.infoHot.GPS);
		$('#verMapCab').on('click', function(e) {
			$('#verMap').click();
		});
		$scope.showinfoHotel = function(id) {
			if ( $('.box-info-hotel-location').hasClass( "open" ) ) {
				$('.box-info-hotel-location').removeClass('open');
			} else {
				$('.box-info-hotel-location').addClass('open');
			}
		};
		$('#close-box-info').click(function(){
			$('.box-info-hotel-location').toggleClass('open');
		});
		$scope.setFocusMapCenter = function(mark) {
			var mapObj = $('#hotel-map').vectorMap('get', 'mapObject'),
				center = mapObj.pointToLatLng(mapObj.width / 2, mapObj.height / 2);
			var config = {
				animate: true,
				lat: mark.latLng[0],
				lng: mark.latLng[1],
				scale: 4
			}
			mapObj.setFocus(config);
			if((parseFloat(center.lng)+3) < parseFloat(mark.latLng[1]) && ($rootScope.rootPais.ISO == 'ES' || $scope.infoPai.ID_REGION == 'EU'))
				$('.box-info-hotel-location').css('right', '70%').css('left', 'inherit').css('margin-left', '0px');
		}
		$scope.generarVectorMap = function(){
			$('#hotel-map').vectorMap({
			map: tipoMap,
			scaleColors: ['#C8EEFF', '#0071A4'],
			normalizeFunction: 'polynomial',
			zoomOnScroll: false,
			zoomMax: 20,
			hoverOpacity: 1,
			hoverColor: false,
			regionsSelectable: false,
			regionStyle : {
				initial: {
					fill: '#f3f1ed',
					"fill-opacity": 1,
					stroke: 'none',
					"stroke-width": 0,
					"stroke-opacity": 1
				},
				hover: {
					"fill-opacity": .7,
					cursor: 'default'
				},
			},
			regionLabelStyle: {
				initial: {
					"fill-opacity": 0
				},
				hover: {
					"fill-opacity": 0,
				},
			},
			markerStyle: {
				initial: {
					fill: '#8A4043',
					stroke: '#ca5c5c',
					"stroke-width": 2,
				},
				hover: {
					stroke: '#ffffff'
				}
			},
			//backgroundColor: '#31333e',
			backgroundColor: 'transparent',
			markers: markers,
			onRegionLabelShow: function(e, el, code){
				e.preventDefault();
			},
			onMarkerClick: function(event, index) {
				$scope.showinfoHotel(markers[index].id);
			$scope.setFocusMapCenter(markers[index]);
					// alter the weburl
				}
			}).ready(function() {
				$scope.setFocusMapCenter(markers[0]);
				$scope.obtenerFotos(0);
			});
		}
		var tipoMap = $rootScope.rootPais.ISO == 'ES'?'es_mill':$scope.infoPai.ID_REGION == 'EU' && $rootScope.rootPais.ISO !='TR'?'europe_mill':'world_mill';
		var markers = [{latLng: [coorHot[0].coor1, coorHot[0].coor2], name: $scope.nombre, id : $scope.infoHot}];
		if($scope.infoPai.ID_REGION == "EU" && $rootScope.rootPais.ISO !='TR'){
			if($scope.infoPai.ISO != 'ES'){
				$.getScript(constantes.serverS + '/' +constantes.idioma  + "/_JS/riu2017/jquery-jvectormap-europe-mill.js").then(function() {
					$scope.generarVectorMap();
				});
			}else{
				$.getScript(constantes.serverS + '/' +constantes.idioma  + "/_JS/riu2017/jquery-jvectormap-es-mill.js").then(function() {
					$scope.generarVectorMap();
				});
			}
		}else{
			$.getScript(constantes.serverS + '/' +constantes.idioma  + "/_JS/riu2017/jquery-jvectormap-world-mill.js").then(function() {
				$scope.generarVectorMap();
			});
		}
	}
}());

(function() {
	'use strict'
	app.factory('serviceHotelVideo', function($http, $q, riuService, constantes){
		return  {
		}
	});
	app.component("fcVideo", {
		templateUrl:  function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder+ "/cmp-fc-video.jsp"; },
		bindings : { idhotel:'@', hotel : '@'},
		controller: ctrlVideo
	});
	ctrlVideo.$inject = [ '$scope',  'constantes', 'serviceHotelVideo', 'serviceFichaHot', '$controller'];
	function ctrlVideo( $scope, constantes, serviceHotelVideo, serviceFichaHot, $controller) {
		angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
		$scope.idhotel =$scope.$ctrl.idhotel;
		$scope.nombre =$scope.$ctrl.hotel;
		$scope.myPlayer = null; 
		$scope.myPlayerHeader = null; 
		$scope.video = serviceFichaHot.getVideo();
		$scope.urlVideo = null;
		if($scope.video && $scope.video.length > 0){
			$scope.video = $scope.video.substring( $scope.video.indexOf(".com") + 4, $scope.video.length).replace("/v/", "/");
			if($scope.video.indexOf("&") >= 0)
				$scope.video = $scope.video.substring(0,$scope.video.indexOf("&"));
			$scope.urlVideo = $scope.video && $scope.video.length > 0?'https://youtu.be' + $scope.video:'';
			$('#descubre-video').append('<div id="bgndVideo" class="player" data-property="{videoURL:\''+ $scope.urlVideo +'\',containment:\'#descubre-video\', showControls:true ,autoPlay:false, loop:true, vol:0, mute:true, startAt:0,  stopAt:30, opacity:1, addRaster:false, quality:\'large\', optimizeDisplay:true}">Aruba</div>');
			 angular.element(document).ready(function () {
				 setTimeout(function(){
					 $scope.myPlayer = $("#bgndVideo").YTPlayer({align:"center,left" });
				 });
			 });
		 	$scope.hotelsVideoHeader = serviceFichaHot.getHotelsVideoHeader().map(function(elem) {
			 	if(elem.id === $scope.idhotel) {
					$('.header-video').append('<div id="bg-header-video" class="player" data-property="{videoURL:\''+ $scope.urlVideo +'\',containment:\'.header-video\', showControls:false ,autoPlay:true, loop:true, vol:0, mute:true, startAt:'+elem.startAt+', opacity:1, addRaster:true, quality:\'hd720\', optimizeDisplay:true}"></div>');
					 angular.element(document).ready(function () {
						 setTimeout(function(){
							 $scope.myPlayer = $("#bg-header-video").YTPlayer({align:"center,center" });
						 });
					 });
				}
			 })
			 $scope.play = function(){
				 if($scope.myPlayer)
					 $scope.myPlayer.YTPPlay();
			 }
			 $scope.pause = function(){
				 if($scope.myPlayer)
					 $scope.myPlayer.YTPPause();
			 }
		}
		$('#play-video, #play-video-mov').on('click', function(e) {
			// $("#descubre-video .cover").toggleClass('video-on');
			if($scope.myPlayer){
				//$scope.myPlayer.YTPPause();
				$('#videoModal iframe').attr('src', serviceFichaHot.getVideo());
				e.preventDefault();	
			}
		}); 
		$('#videoModal button').click(function () {
			$('#videoModal iframe').removeAttr('src');
		});	
		$('#videoModal').on('hidden.bs.modal', function () {
		  $('#videoModal iframe').removeAttr('src');
		});
	}
}());


(function() {
	'use strict'
	app.factory('serviceHotelPremios', function($http, $q, riuService, constantes){
		return  {
			getPremiosFichaHotJSON : function() {
				var url = "premiosHotel.json";
				var defer = $q.defer();
				$http.get(url, 
				{withCredentials: true, headers: {"Content-Type": "application/json"} } ).success(function(data)
				{
					defer.resolve(data);
				}).error(function(data, status, headers, config) 
				{
					defer.resolve(status);
				});
				return defer.promise;
			}
		}
	});
	app.component("fcPremios", {
		templateUrl:  function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder+ "/cmp-fc-premios.jsp"; },
		bindings : { idhotel:'@', hotel : '@'},
		controller: ctrlPremios
	});
	ctrlPremios.$inject = [ '$scope',  'ngDialog', 'serviceHotelPremios', '$controller'];
	function ctrlPremios( $scope, ngDialog, serviceHotelPremios, $controller) {
		angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
		$scope.v_cache=window.v_cache_fotos;	
		$scope.idhotel =$scope.$ctrl.idhotel;
		$scope.nombre =$scope.$ctrl.hotel;
		$scope.listaPremios = [];
		$scope.listaComletaPremios = [];
		$scope.showPopupPremios = function() {
			$scope.popup = ngDialog.openConfirm({ template: '<popup-premios></popup-premios>', plain : true, scope: $scope	});
		}
		serviceHotelPremios.getPremiosFichaHotJSON().then(function(d) {
			$scope.listaComletaPremios = d;
			if($scope.listaComletaPremios && $scope.listaComletaPremios.length > 3){
				for(var i = 0; i < 3; i++){
					$scope.listaPremios.push($scope.listaComletaPremios[i]);
				}
			}else
				$scope.listaPremios = $scope.listaComletaPremios;
			$scope.listaPremiosView = $scope.listaPremios;
			$scope.listaComletaPremiosView = $scope.listaComletaPremios;
		});	
	}
}());

(function() {
	'use strict'
	app.factory('serviceHotelHabitaciones', function($http, $q){
		return  {
		}
	});
	app.component("fcHabHot", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder+ "/cmp-fc-hab-hot.jsp?request.aspect=desk"; }, 
		bindings : { idhotel:'@', hotel : '@', modulo : '@'},
		controller: ctrlHabHot
	});
	ctrlHabHot.$inject = [ '$scope', '$http', 'serviceHotelHabitaciones', '$controller', 'constantes','ngDialog'];
	function ctrlHabHot($scope, $http, serviceHotelHabitaciones, $controller, constantes,ngDialog) {
		angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
		$scope.idhotel =$scope.$ctrl.idhotel;
		$scope.nombre =$scope.$ctrl.hotel;
		$scope.habsHot = null;
		$scope.modulo = this;
		$scope.showHabsHot = false;
		$scope.numHabsHot = null;
		$scope.showAllRooms = function (){
			$('.room-wrap').removeClass('hide');
			$scope.numHabsHot = 0;
		}
		var url = constantes.serverS + '/json-utils!getHabitacionesHotel.action?request.aspect=desk&formato=json&v=web2017&params.idHotel=' +$scope.idhotel+'&idioma='+constantes.idioma;
		$http.get(url, {withCredentials: true}).success(function(data)
		{
			// Eliminamos las DPRO
			delete data.DPRO;
			var i = 1;
			//data.forEach((el)=>{el["ORDEN"] = i++;});
			var r = _.reject(data, function(o) { return o.OCULTAR=="true"; });
			$scope.showHabsHot = false;
			$scope.habsHot = _.orderBy(r, ['ORDEN']);
			$scope.numHabsHot = Object.keys($scope.habsHot).length;
			if ($scope.numHabsHot==0)
				$scope.modulo.hide();
			else
				$scope.showHabsHot = true;
		}).error(function(data, status, headers, config) 
		{
		});
        	$scope.transformDataPackageVip = function(dataServer){
			const dataFormat = []
			if(dataServer && dataServer.length > 0){
				dataServer.forEach(itemJson=>{
					var habitacion = {
						codigo: itemJson.rooms[0],
						labels: itemJson.labels
					};
					let searchCurrent = dataFormat.find(x=>x.idHotel == itemJson.idhotel);
					if(searchCurrent){
						var searchCurrentIndex = dataFormat.indexOf(searchCurrent);
						dataFormat[searchCurrentIndex].rooms.push(habitacion);
					}else{
						dataFormat.push({
							idHotel: itemJson.idhotel,
							rooms: [habitacion]
						});
					}
				})            
			}    
			return dataFormat;    			
		}
        var urlPkg = constantes.serverS + "/json-utils!getUrl.action?formato=json&v=web2017&params.url=/es/json/package_vip.json";
		$http.get(urlPkg, {withCredentials: true}).success(function(data)
		{
			$scope.habPkgVip = $scope.transformDataPackageVip(data);
			$scope.showHabsPkg = true;
			console.log("Package VIP: ",data);
		}).error(function(data, status, headers, config) 
		{
		});
		$scope.fotosHab = function(fotos) {
			console.log(fotos);
			$scope.selectedRoom = fotos.FOTOS;
			var imgs = [];
			angular.forEach( $scope.selectedRoom.FOTO, function(f) {
				imgs.push({'src':f.HREF, 'title': fotos.DESCRIPCION + ' - ' + window.img_ori});
			});
			$.magnificPopup.open({
			  items: imgs,
			  gallery: {
				  enabled: true
				},
			  type: 'image'
			});
		}
                $scope.showPackageVip = function(value){
			var lbls = $scope.getLabel(value); 
			$scope.habitacionPackagePopUp = {
				title : lbls.popup_title,
				subtitle : lbls.popup_description,
				details: lbls.items
			};
			$scope.dialog = ngDialog.open({
				template: "/" + constantes.idioma + constantes.templateFolder + "/cmp-dialog-package-vip.jsp",
				className: 'ngdialog-theme-default modal-pkg-vip',
				showClose: false,
				scope: $scope
			});
		}
$scope.closePopUpPackageVip = function(){
			$scope.dialog.close();
		}
		$scope.getEtiquetaButton = function(value){
			if($scope.habPkgVip){
				var lbl = this.getLabel(value);
				return lbl ? lbl.button_tittle : "";				
			}
		}
		$scope.getLabel = function(value){
			var idHot = Number($scope.idhotel);
			var idiom = constantes.idioma ? constantes.idioma : 'en'
			var lbs;	
			var hotel = $scope.habPkgVip.find(x=>x.idHotel == idHot);
			if(hotel){
				var habitacion = hotel.rooms.find((r)=>r.codigo == value.CODIGO);
				if(habitacion){
					var lbls = habitacion.labels.find((x)=>x.language == idiom);
					if(!lbls){
						lbls = habitacion.labels.find((x)=>x.language == 'en');
					}
					lbs = lbls;     					
				}
			}
			return lbs;
		}
		$scope.hasPackageVip = function(value){
			var idHot = Number($scope.idhotel);
			var hotel = $scope.habPkgVip.find(x=>x.idHotel == idHot);
			var isVip = false;
			if(hotel){
				hotel.rooms.forEach((room) => {
					if(room.codigo == value.CODIGO){
						isVip = true; 
					}
				});				
			}
			return isVip;
		}
	}
}());


(function() {
	'use strict'
	app.component("fcKeyselling", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder+ "/cmp-fc-keyselling.jsp"; }, 
		bindings : { idhotel:'@', hotel : '@', modulo: '@'},
		controller: ctrlKeysellingHotel
	});
	ctrlKeysellingHotel.$inject = [ '$scope', '$controller'];
	function ctrlKeysellingHotel( $scope, $controller) {
		angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
	}
}());

(function () {
	'use strict'
	app.factory('buscadorUtils', function ($http, $q, riuService, constantes, $cookies) {
		return {
			//Filtro para la ordenación de hoteles. (Deja solo el "nombre")
			removeExtras: function (str) {
				return str.replace("Aparthotel", "").replace("ClubHotel", "").replace("Hotel", "").replace("Riu", "").replace("Palace", "").replace("Plaza", "").trim();
			},
			//Filtro para la ordenación de hoteles. (Quita los acentos y las eñes)
			removeAcentos: function (str) {
				return str.replace(/á/gi, "a").replace(/é/gi, "e").replace(/í/gi, "i").replace(/ó/gi, "o").replace(/ú/gi, "u").replace(/ñ/gi, "n");
			},
			//AB MONETE
			adsBlocked: function (pageType){
	          let cookie = $cookies.get('mt.v'); 
	            var url = "https://api.monetate.net/api/engine/v1/decide/riu.com";
	            let obj = {
	                    "channel": "a-c3db960f/p/riu.com",
	                    "events": [
	                        {
	                            "eventType": "monetate:decision:DecisionRequest",
	                            "requestId": Math.floor((Math.random() * 10000) + 1).toString()
	                        },
	                        {
	                           "eventType": "monetate:context:UserAgent",
	                           "userAgent": navigator.userAgent
	                        },
	                        {
	                            "eventType": "monetate:context:PageView",
	                            "url": window.location.host + window.location.pathname,
	                            "pageType": pageType?pageType:'NORMAL'
	                        }
	                    ]
	                };
	            if(cookie)
	                obj["monetateId"] = cookie;
	            var paramStr =  JSON.stringify(obj);
	            var transform = function(data){
						return $.param(data);
					}
	            return $http.post(url, JSON.stringify(obj));
        	}
		}
	});
	app.controller('ctrlBuscadorHome', ["buscadorUtils", "$location", "$scope", "$filter", "$timeout", "$cookies", "$rootScope", "$interval", "riuService", "riuClassSession", "$q", "constantes", "$window", "ngDialog", "$http,", ctrlBuscadorHome]);
	//Componente Buscador
	app.component("buscador", {
		templateUrl: function (constantes) {
			return "/" + constantes.idioma + constantes.templateFolder + "/cmp-hm-buscador.jsp?request.aspect=desk";
		},
		bindings: {
			tipo: "@", //Donde se encuentra: home, oferta, ficha, hotel, destino
			buscador: "@", //Tipo de buscador (mix, destino, landing, no)
			origen: "@", //Pagina origen de la oferta
			idHotel: "@", //ID de hotel en caso de no tener buscador
			idDestino: "@", //ID de destino en caso de no tener buscador
			idZona: "@", //ID de destino en caso de no tener buscador
			calendario: "@", //Si se muestra el calendario (si, no)
			primerDiaSemana: "@", //1 para Lunes, 0 para Domingo
			formatoFecha: "@", //DD/MM/YYYY o //YYYY
			huespedes: "@", //Si se muestra el numero de huespedes (si, no)
			promocode: "@", //Si se muestra el promocode (codigo promocode, no)
			caducidadCookies: "@", //Cantidad de horas que durará la cookie
			ofertas: "@", //Array de arrays con rangos ofertas
			lh: "@",
			ld: "@",
			lp: "@",
			ocultarpromocode: '@',
			mostrarHoteles: "@" //Array de IDs de hoteles a mostrar
		},
		controller: ctrlBuscadorHome
	});
	//Componente Buscador
	app.component("buscadorDispo", {
		templateUrl: function (constantes) {
			return "/" + constantes.idioma + constantes.templateFolder + "/cmp-hm-buscador.jsp?request.aspect=desk";
		},
		bindings: {
			tipo: "@", //Donde se encuentra: home, oferta, ficha, hotel, destino
			buscador: "@", //Tipo de buscador (mix, destino, landing, no)
			origen: "@", //Pagina origen de la oferta
			idHotel: "@", //ID de hotel en caso de no tener buscador
			idDestino: "@", //ID de destino en caso de no tener buscador
			idZona: "@", //ID de destino en caso de no tener buscador
			calendario: "@", //Si se muestra el calendario (si, no)
			primerDiaSemana: "@", //1 para Lunes, 0 para Domingo
			formatoFecha: "@", //DD/MM/YYYY o //YYYY
			huespedes: "@", //Si se muestra el numero de huespedes (si, no)
			promocode: "@", //Si se muestra el promocode (codigo promocode, no)
			caducidadCookies: "@", //Cantidad de horas que durará la cookie
			ofertas: "@", //Array de arrays con rangos ofertas
			lh: "@",
			ld: "@",
			lp: "@",
			ocultarpromocode: '@',
			mostrarHoteles: "@" //Array de IDs de hoteles a mostrar
		},
		controller: ctrlBuscadorHome
	});
	//Filtro de buscqueda aproximada. Usa fuse.js
	app.filter('aproximado', function () {
		return function (hoteles, input) {
			if (typeof input !== 'undefined') {
				var options = {
					threshold: 0.3,
					location: 0,
					distance: 3,
					tokenize: true,
					matchAllTokens: true,
					findAllMatches: false,
					maxPatternLength: 20,
					minMatchCharLength: 3,
					keys: ['NAME', 'NAME_A', 'DESTINO', 'DESTINO_A', 'PAIS', 'PAIS_A']
				};
				var fuse = new Fuse(hoteles, options);
				var busqueda = input;
				var specialChars = "!@#$^&%*()+=-[]\/{}|:<>?,.";
				for (var i = 0; i < specialChars.length; i++) {
					busqueda = busqueda.replace(new RegExp("\\" + specialChars[i], 'gi'), '');
				}
				var result = fuse.search(busqueda);
				return input === "" ? hoteles : result;
			}
			return hoteles;
		};
	})
	function ctrlBuscadorHome(buscadorUtils, $location, $scope, $filter, $timeout, $cookies, $rootScope, $interval, riuService, riuClassSession, $q, constantes, $window, ngDialog, $http) {
		//global
		$scope.global = $rootScope;
		$rootScope.buscador = (typeof $rootScope.buscador === 'undefined') ? 1 : ++$rootScope.buscador; //Indica el número de buscadores que se están usando en la página
		$scope.buscador = $rootScope.buscador; // nº buscador
		$scope.iPad = navigator.userAgent.match(/iPad/i) != null; // Detecta si estamos en un Ipad
		//recogidas de la directiva
		$scope.Sbuscador = typeof $scope.$ctrl.buscador !== 'undefined' ? $scope.$ctrl.buscador : false;
		$scope.Sorigen = typeof $scope.$ctrl.origen !== 'undefined' ? $scope.$ctrl.origen : false;
		$scope.Stipo = typeof $scope.$ctrl.tipo !== 'undefined' ? $scope.$ctrl.tipo : false;
		$scope.SidHotel = typeof $scope.$ctrl.idHotel !== 'undefined' ? $scope.$ctrl.idHotel : false;
		$scope.SidDestino = typeof $scope.$ctrl.idDestino !== 'undefined' ? $scope.$ctrl.idDestino : false;
		$scope.SidZona = typeof $scope.$ctrl.idZona !== 'undefined' ? $scope.$ctrl.idZona : false;
		$scope.Scalendario = typeof $scope.$ctrl.calendario !== 'undefined' ? $scope.$ctrl.calendario : false;
		$scope.Shuespedes = typeof $scope.$ctrl.huespedes !== 'undefined' ? $scope.$ctrl.huespedes : false;
		$rootScope.Spromocode = typeof $scope.$ctrl.promocode !== 'undefined' ? $scope.$ctrl.promocode : "";
		$scope.SprimerDiaSemana = typeof $scope.$ctrl.primerDiaSemana !== 'undefined' ? $scope.$ctrl.primerDiaSemana : false;
		$scope.SpformatoFecha = typeof $scope.$ctrl.formatoFecha !== 'undefined' ? $scope.$ctrl.formatoFecha : false;
		$scope.Ssubmit = typeof $scope.$ctrl.submit !== 'undefined' ? $scope.$ctrl.submit : false;
		$scope.Sofertas = typeof $scope.$ctrl.ofertas !== 'undefined' ? $scope.$ctrl.ofertas : false;
		$scope.ScaducidadCookies = typeof $scope.$ctrl.caducidadCookies !== 'undefined' ? $scope.$ctrl.caducidadCookies : false;
		$scope.SmostrarHoteles = typeof $scope.$ctrl.mostrarHoteles !== 'undefined' ? $scope.$ctrl.mostrarHoteles : false;
		$scope.ocultar_promocode = $scope.$ctrl.ocultarpromocode == 'true';
		$scope.nb = 0;
		$scope.vtl = "";
		$scope.v1tl = "";
		$scope.sizeMobile = $(window).width() < 768 ? true : false;
		/************** Tratamiento buscador destino/hotel versión movil ***************/
		angular.element($window).bind('resize', function () {
			$scope.$apply(function () {
				$scope.sizeMobile = $(window).width() < 768 ? true : false;
				if (angular.isUndefined(riuClassSession.dateFormat.formato)) {
					$scope.$on('SessionUpdated', function () {
						$scope.inicio();
					});
				} else {
					$scope.inicio();
				}
			});
		});
		$scope.scrollBuscadorModal = function () {
			if (($window.innerHeight < $window.innerWidth) && $scope.sizeMobile) {
				$('html, body').animate({
					scrollTop: $(".form-group.checkIn").offset().top
				}, 1000);
				if ($scope.Stipo === 'mixScroll') {
					$timeout(function () {
						$('.daterangepicker').css('top', '50px');
					}, 0);
				}
			}
		}
		$scope.showDialog = function () {
			$scope.dialog = ngDialog.open({
				template: "/" + constantes.idioma + constantes.templateFolder + "/cmp-dialog-buscador-movil.jsp?request.aspect=desk",
				className: 'ngdialog-theme-default dialog-busc-movil buscador-riu',
				showClose: false,
				scope: $scope
			});
			if ($(window).width() < 768) {
				$timeout(function () {
					$('.mostrar-todos-ext').html('Borrar selección');
				}, 900);
			}
		}
		$scope.hideBox = function ($event) {
			var el = $event.target;
			$('.buscador-mix-box').css('z-index', '-10');
			angular.element(el).parent().parent().parent().parent().css('display', 'none');
			angular.element(el).parent().parent().parent().parent().next().css('display', 'block');
		}
		$scope.borrarSeleccion = function () {
			$('.hoteles').css('display', 'none');
			$('.destinos').css('display', 'none');
			$('.paises').css('display', 'block');
		}
		$scope.closeDialog = function () {
			$scope.dialog.close();
		}
		$scope.hideModalSearcher = function () {
			if ($scope.Stipo === "consulta") {
				angular.element('#busc-movil-modal').modal('toggle');
			}
		}
		/************ Fin tratamiento destino/hotel buscador versión movil ***************/
		/*******************************************************************/
		if ($scope.Stipo == "home") {
			$scope.version = "home";
			$scope.version1 = "home-principal";
		} else if ($scope.Stipo == "mixScroll") {
			$scope.version = "landing";
			$scope.version1 = "landing-scroll";
		} else if ($scope.Stipo == "mixScroll" && $scope.Sorigen == "home") {
			$scope.version = "home";
			$scope.version1 = "home-scroll";
		} else if ($scope.Stipo == "ficha" && $scope.Sbuscador == "destino") {
			$scope.version = "destino";
			$scope.version1 = "destino-principal";
		} else if ($scope.Stipo == "ficha" && $scope.Sbuscador == "no") {
			$scope.version = "hotel";
			$scope.version1 = "hotel-principal";
		} else if ($scope.Stipo == "oferta" && $scope.Sorigen == "home") {
			$scope.version = "home";
			$scope.version1 = "home-oferta";
		} else if ($scope.Stipo == "oferta" && $scope.Sorigen == "destino") {
			$scope.version = "destino";
			$scope.version1 = "destino-oferta";
		} else if ($scope.Stipo == "oferta" && $scope.Sorigen == "hotel") {
			$scope.version = "hotel";
			$scope.version1 = "hotel-oferta";
		} else if ($scope.Stipo == "oferta" && $scope.Sorigen == "destino-hotel") {
			$scope.version = "destino";
			$scope.version1 = "destino-hotel";
		}
		$scope.clickPais = function (pais, event) {
			$scope.global.hotelInput = pais.PAIS;
			$scope.global.paisSelected = pais.PAIS;
			$scope.global.areaSelected = '';
			$scope.global.hotelSelected = '';
			$scope.destinoValido = false;
			$rootScope.filtroPaisSelected = {
				PAIS: pais.PAIS
			};
			$rootScope.cDestinosView = $filter('filter')($rootScope.cDestinos, $rootScope.filtroPaisSelected);
			$rootScope.filtroDestinoSelected = {
				PAIS: pais.PAIS
			};
			$rootScope.cHotelesView = $filter('orderBy')($filter('filter')($rootScope.cHoteles, $rootScope.filtroDestinoSelected), "NAME_F");
			$scope.focusBuscador();
			$scope.addOnClick(event);
		};
		$scope.clickDefault = function (obj) {
			$scope.idPais = obj.PAIS;
			$scope.idDestino = obj.ID_DESTINO;
			$scope.destinoValido = true;
			$scope.global.areaSelected = obj.DESTINO;
			$scope.global.paisSelected = obj.PAIS;
			$rootScope.filtroPaisSelected = {
				PAIS: obj.PAIS
			};
			$rootScope.cDestinosView = $filter('filter')($rootScope.cDestinos, $rootScope.filtroPaisSelected);
			$rootScope.filtroDestinoSelected = {
				DESTINO: obj.DESTINO
			};
			$rootScope.cHotelesView = $filter('orderBy')($filter('filter')($rootScope.cHoteles, $rootScope.filtroDestinoSelected), "NAME_F");
		}
		$scope.clickDestino = function (destino, event) {
			$scope.global.hotelInput = destino.DESTINO;
			$scope.tipoBusqueda = 'TIPO_BUSQUEDA_PAIS_DESTINO';
			$scope.idHotel = -1;
			$scope.global.hotelSelected = '';
			$scope.clickDefault(destino);
			$scope.addOnClick(event);
			$scope.focusBuscador();
		};
		$scope.clickHotel = function (hotel, event) {
			$scope.global.hotelInput = hotel.NAME;
			$scope.tipoBusqueda = 'TIPO_BUSQUEDA_HOTEL';
			$scope.idHotel = hotel.ID_HOTEL;
			$scope.global.hotelSelected = hotel;
			$scope.clickDefault(hotel);
			$scope.focusCalendario();
			$scope.addOnClick(event);
		};
		$scope.clickHotelDestino = function (hotel, event) {
			if (hotel) $scope.global.hotelInput = hotel.DESTINO;
			$scope.global.hotelSelected = '';
			$scope.idHotel = -1;
			$scope.tipoBusqueda = 'TIPO_BUSQUEDA_PAIS_DESTINO';
			if (hotel) $scope.clickDefault(hotel);
			$scope.focusCalendario();
			$scope.addOnClick(event);
		};
		$scope.clickMostrarTodos = function (event) {
			$scope.global.hotelInput = '';
			$scope.global.paisSelected = '';
			$scope.global.areaSelected = '';
			$scope.global.hotelSelected = '';
			$rootScope.filtroDestinoSelected = undefined;
			$rootScope.cHotelesView = $filter('orderBy')($filter('filter')($rootScope.cHoteles, $rootScope.filtroDestinoSelected), "NAME_F");
			$rootScope.filtroPaisSelected = undefined;
			$rootScope.cDestinosView = $filter('filter')($rootScope.cDestinos, $rootScope.filtroPaisSelected);
			$scope.filtroPais = undefined;
			$scope.destinoValido = false;
			$scope.focusBuscador();
			$scope.updateInput("text");
		};
		/*
			Cada vez que se modifica el array hotelesFiltrados volvemos a
			recalcular los arrays de Paises y Destinos
		*/
		$scope.setPaisesDestinos = function (hoteles) {
			$rootScope.cPaises = [];
			$rootScope.cDestinos = [];
			var cD = [];
			var cP = [];
			angular.forEach(hoteles, function (h) {
				//$rootScope.cPaises.push({ 	"ID_PAIS":h.ID_PAIS, "PAIS":h.PAIS, 	"PAIS_A":h.PAIS_A });						
				//$rootScope.cDestinos.push({ "ID_PAIS":h.ID_PAIS, "PAIS":h.PAIS, "ID_DESTINO":h.ID_DESTINO, 	"DESTINO":h.DESTINO, "DESTINO_A":h.DESTINO_A });	
				cP.push({
					"ID_PAIS": h.ID_PAIS,
					"PAIS": h.PAIS,
					"PAIS_A": h.PAIS_A
				});
				cD.push({
					"ID_PAIS": h.ID_PAIS,
					"PAIS": h.PAIS,
					"ID_DESTINO": h.ID_DESTINO,
					"DESTINO": h.DESTINO,
					"DESTINO_A": h.DESTINO_A
				});
			});
			$rootScope.cHoteles = angular.copy(hoteles);
			$scope.resultados = hoteles.length;
			$rootScope.resultados = hoteles.length;
			$rootScope.cPaises = _.uniqBy(cP, "ID_PAIS");
			$rootScope.cDestinos = _.uniqBy(cD, "ID_DESTINO");
			//$rootScope.cPaises = _.uniqBy($rootScope.cPaises, "ID_PAIS");
			//$rootScope.cDestinos = _.uniqBy($rootScope.cDestinos, "ID_DESTINO");
			$rootScope.cPaisesView = _.uniqBy(cP, "ID_PAIS");
			$rootScope.cDestinosView = $filter('filter')($rootScope.cDestinos, $rootScope.filtroPaisSelected);
			$rootScope.cHotelesView = $filter('orderBy')($filter('filter')($rootScope.cHoteles, $rootScope.filtroDestinoSelected), "NAME_F");
		}
		/*******************************************************************/
		// Procesa el parámetro de búsqueda y lo actualiza en la vista
		$scope.loadSearchAB = function (s) {
			if(s.tipoBusqueda == 'TIPO_BUSQUEDA_HOTEL'){
				//var hotelesFiltrados = ($filter('aproximado')($rootScope.hoteles, s.paisDestino.hotel));
				$scope.idHotel = s['paisDestino.hotel'];
                                if(!$rootScope.Spromocode && $scope.moneteInfo && $scope.moneteInfo.variante == 'Experiment'){
					s["codigoPromocional"] = 'NY5'
					$scope.submitGenerico(s,'NY5');
				} else if($rootScope.Spromocode && $rootScope.Spromocode == 'NY5' && $scope.idHotel == '5801'){
					s["codigoPromocional"] = 'NY5'
					$scope.loadSearch(s,'NY5');
				}else{
					$scope.loadSearch(s,'');
				}
			}else{
				$scope.loadSearch(s,'');
			}
		}
		$scope.loadSearch = function (s, promocadeNyc) {
			$rootScope.habitaciones = s["huespedes.numeroHabitaciones"];
			$rootScope.adultos = [null];
			$rootScope.ninos = [null];
			$rootScope.edadNinos = [
				[],
				[],
				[],
				[]
			];
			//variables calendario
			$rootScope.fechaEntrada = s["fechas.fechaEntradaAsString"];
			$rootScope.fechaSalida = s["fechas.fechaSalidaAsString"];
			$rootScope.paisSelected = s["paisDestino.pais"];
			$rootScope.areaSelected = s["paisDestino.destino_name"];
			$scope.buscarHotel = s["paisDestino.hotel_name"];
			$scope.buscarDestino = s["paisDestino.destino"];
			for (var i = 0; i < s["huespedes.numeroHabitaciones"]; i++) {
				$rootScope.adultos.push(s["huespedes.habitaciones[" + i + "].numeroAdultos"]);
				$rootScope.ninos.push(s["huespedes.habitaciones[" + i + "].numeroNinos"]);
				for (var j = 0; j < s["huespedes.habitaciones[" + i + "].numeroNinos"]; j++) {
					$rootScope.edadNinos[i + 1][j + 1] = s["huespedes.habitaciones[" + i + "].edades[" + j + "].value"];
				}
			}
			if ($scope.Stipo === 'home') {
				$rootScope.hotelInput = s.tipoBusqueda == 'TIPO_BUSQUEDA_HOTEL' ? s.hotel : s["paisDestino.destino"];
				$scope.tipoBusqueda = s.tipoBusqueda;
				$scope.destinoValido = true;
			} else {
				$rootScope.Spromocode = promocadeNyc?promocadeNyc:s["codigoPromocional"] == 'NY5'? '':s["codigoPromocional"];
			}
			var picker = $scope.cal.data("daterangepicker");
			if (picker) {
				//picker.startDate = moment(s["fechaEntradaMs"]);
				//picker.endDate = moment(s["fechaSalidaMs"]);
				if (s["dateFormat.formato"]) {
					if (s["dateFormat.formato"] == $scope.dateFormat.formato) {
						picker.startDate = moment(s["fechas.fechaEntradaAsString"], $scope.dateFormat.formato, true);
						picker.endDate = moment(s["fechas.fechaSalidaAsString"], $scope.dateFormat.formato, true);
						$scope.formatFechas(picker.startDate, picker.endDate, false);
					} else {
						var m1 = moment(s["fechas.fechaEntradaAsString"], s["dateFormat.formato"], true);
						var m2 = moment(s["fechas.fechaSalidaAsString"], s["dateFormat.formato"], true);
						picker.startDate = moment(m1.format($scope.dateFormat.formato), $scope.dateFormat.formato, true);
						picker.endDate = moment(m2.format($scope.dateFormat.formato), $scope.dateFormat.formato, true);
						$scope.formatFechas(picker.startDate, picker.endDate, false);
					}
				} else {
					//picker.startDate = null;
					//picker.endDate = null;
					$scope.formatFechas(null, null, false)
				}
			}
			if ($scope.Stipo === 'home' || $scope.Stipo === "consulta") {
				var destino = _.find($rootScope.hoteles, {
					'ID_DESTINO': s["paisDestino.destino"]
				})
				if (angular.isDefined(destino)) {
					$rootScope.filtroPaisSelected = {
						PAIS: destino.PAIS
					};
					$rootScope.filtroDestinoSelected = {
						DESTINO: destino.DESTINO
					};
					$rootScope.cHotelesView = $filter('orderBy')($filter('filter')($rootScope.cHoteles, $rootScope.filtroDestinoSelected), "NAME_F");
					s["paisDestino.pais"] = destino.PAIS;
					s["paisDestino.destino"] = destino.DESTINO;
					$rootScope.paisSelected = s["paisDestino.pais"];
					$rootScope.areaSelected = s["paisDestino.destino"];
					$scope.global.paisSelected = s["paisDestino.pais"];
					$scope.global.areaSelected = s["paisDestino.destino"];
					$rootScope.hotelInput = s.tipoBusqueda == 'TIPO_BUSQUEDA_HOTEL' ? s["paisDestino.hotel_name"] : s["paisDestino.destino"];
					$scope.hoteles = ($filter('aproximado')($rootScope.hoteles, $rootScope.hotelInput));
					$rootScope.cDestinosView = $filter('filter')($rootScope.cDestinos, {
						PAIS: destino.PAIS
					});
					$rootScope.cHotelesView = $filter('orderBy')($filter('filter')($rootScope.cHoteles, {
						DESTINO: destino.DESTINO
					}), "NAME_F");
					//$scope.setPaisesDestinos($rootScope.hoteles);
				}
			}
			$rootScope.hotelSelected = _.find($rootScope.hoteles, {
				'ID_HOTEL': s["paisDestino.hotel"]
			})
		}
		if ($cookies.get('ultimabusqueda'))
			$cookies.remove('ultimabusqueda', {
				path: '/'
			});
		//Recogida de las cookies
		var ultimaBusqueda = $cookies.get('ub') ? JSON.parse($cookies.get('ub')) : false;
		if ($scope.Stipo == "consulta" && $location.search().search) {
			ultimaBusqueda = JSON.parse($location.search().search)
			$rootScope.$on('$locationChangeSuccess', function () {
				$scope.loadSearchAB(JSON.parse($location.search().search));
			});
		}
		//variables huespedes
		//$scope.hoteles 			= $rootScope.hoteles ? $rootScope.hoteles 				 : [];
		//$scope.setPaisesDestinos($scope.hoteles);
		//-----------------------------------------
		// INIT VALUES
		//-----------------------------------------
		$scope.huespedes = [1, 2, 3, 4];
		$scope.mninos = [1, 2, 3, 4];
		$scope.maxEdadNinosA = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16];
		$scope.maxHabitaciones = 3;
		$scope.maxAdultos = 4;
		$scope.maxNinos = 3;
		$scope.maxEdadNinos = 16;
		$rootScope.habitaciones = 1;
		$rootScope.adultos = [null, 2, 2, 2, 2];
		$rootScope.ninos = [null, 0, 0, 0];
		$rootScope.edadNinos = [null, null, null, null];
		//variables calendario
		$rootScope.fechaEntrada = $location.$$search.dateIn ? $location.$$search.dateIn : '';
		$rootScope.fechaSalida = $location.$$search.dateOut ? $location.$$search.dateOut : '';
		$scope.fechaValida = false;
		$scope.fechaVacia = true;
		$scope.noHotelSelected = true;
		$rootScope.paisSelected = '';
		$rootScope.areaSelected = '';
		$scope.buscarHotel = '';
		$scope.buscarDestino = '';
		$scope.advanced = $scope.Stipo === 'home' ? true : false;
		$scope.ptooltip = $scope.Stipo === 'mixScroll' ? 'bottom' : 'top'
		$scope.advancedClick = function () {
			$('.buscador-home').toggleClass('advanced');
		};
		$scope.clickado = false;
		$scope.destinoValido = false;
		$scope.tipoUsrSes;
		$scope.moneteInfo;
		$scope.strBusAge;
		//funciones huespedes
		$scope.addHabitacion = function (x) {
			$rootScope.habitaciones = $rootScope.habitaciones < $scope.maxHabitaciones ? 1 * $rootScope.habitaciones + 1 : $rootScope.habitaciones;
		};
		$scope.restHabitacion = function (x) {
			$rootScope.habitaciones = 1 * $rootScope.habitaciones - 1 >= 1 ? 1 * $rootScope.habitaciones - 1 : $rootScope.habitaciones;
		};
		$scope.addAdulto = function (x) {
			$rootScope.adultos[x] = $rootScope.adultos[x] < $scope.maxAdultos ? 1 * $rootScope.adultos[x] + 1 : $rootScope.adultos[x];
		};
		$scope.restAdulto = function (x) {
			$rootScope.adultos[x] = $rootScope.adultos[x] > 1 ? 1 * $rootScope.adultos[x] - 1 : $rootScope.adultos[x];
		};
		$scope.addNino = function (x) {
			$rootScope.ninos[x] = $rootScope.ninos[x] < $scope.maxNinos ? 1 * $rootScope.ninos[x] + 1 : $rootScope.ninos[x];
		};
		$scope.restNino = function (x) {
			$rootScope.ninos[x] = 1 * $rootScope.ninos[x] - 1 >= 0 ? 1 * $rootScope.ninos[x] - 1 : $rootScope.ninos[x];
		};
		$scope.addEdadNino = function (x, y) {
			if ($rootScope.edadNinos[x][y] === '<2') {
				$rootScope.edadNinos[x][y] = 2;
			} else {
				$rootScope.edadNinos[x][y] = $rootScope.edadNinos[x][y] < $scope.maxEdadNinos ? 1 * $rootScope.edadNinos[x][y] + 1 : $rootScope.edadNinos[x][y];
			}
		};
		$scope.restEdadNino = function (x, y) {
			if ($rootScope.edadNinos[x][y] - 1 === 1) {
				$rootScope.edadNinos[x][y] = '<2';
			} else {
				$rootScope.edadNinos[x][y] = $rootScope.edadNinos[x][y] !== '<2' ? 1 * $rootScope.edadNinos[x][y] - 1 : $rootScope.edadNinos[x][y];
			}
		};
		$scope.mostrarSelectorHuespedes = function () {
			window.mostrarSelectorHuespedes($scope.buscador);
		};
		$scope.adultosTotal = function () {
			var total = 0;
			for (var i = 1; i <= $rootScope.habitaciones; i++) {
				total += $rootScope.adultos[i] * 1;
			}
			return total = isNaN(total) ? 0 : total;
		};
		$scope.ninosTotal = function () {
			var total = 0;
			for (var i = 1; i <= $rootScope.habitaciones; i++) {
				total += $rootScope.ninos[i] * 1;
			}
			return total = isNaN(total) ? 0 : total;
		};
		$scope.huespedesTotal = function () {
			return $rootScope.adultosTotal() + $rootScope.ninosTotal();
		};
		$scope.focusBuscador = function () {
			$timeout(function () {
				$("#buscador" + $scope.buscador + " input[name='hotelinput']").focus();
			})
		};
		$scope.clickBuscador = function () {
			$timeout(function () {
				$("#buscador" + $scope.buscador + " input[name='hotelinput']").click();
			})
		};
		$scope.focusCalendario = function () {
			$timeout(function () {
				$("#calendario" + $scope.buscador + " input[name='datefilter']").click();
				$(".buscador-mix-box").removeClass('open');
			})
		};
		$scope.focusHuespedes = function () {
			$timeout(function () {
				$("#buscador" + $scope.buscador + " .guest").click();
			})
		};
		//----------------------------------------------------------------------------------------------------------------------------
		//Se dispara al hacer click en el input
		$scope.addOnClick = function (event) {
			if (event.target.type == "text") {
				event.target.select();
			}
			//Hace scroll hasta el titulo si no es iPad
			if ($scope.Stipo === "home" && !$scope.iPad) {
				$('html, body').animate({
					scrollTop: $(".cover-content h2").offset().top
				}, 1000);
			}
			//actualiza el filtro
			$rootScope.hotelInput = $rootScope.hotelInput ? $rootScope.hotelInput : "";
			$scope.tipoHotel = '';
			$scope.updateInput('click');
			//Abre el menú según condiciones: Se ha hecho click a la derecha o hay 3 letras escritas al menos
			if ((event.target.offsetWidth - event.offsetX) < 45 ||
				$rootScope.hotelInput.length >= 2 ||
				$(".buscador-mix-box").hasClass('open') ||
				$scope.Sbuscador === 'destino' ||
				$scope.Sbuscador === 'landing' ||
				$scope.iPad) {
				if ($scope.iPad) {
					$('#buscador' + $scope.buscador + ' .buscador-mix-box').addClass('open');
				} else {
					$(".buscador-mix-box").addClass('open');
				}
			} else {
				if ($scope.iPad) {
					$('#buscador' + $scope.buscador + ' .buscador-mix-box').removeClass('open');
				} else {
					$(".buscador-mix-box").removeClass('open');
				}
			}
			//Scroll del interior de las listas
			$timeout(function () {
				if (typeof $('.paises-list .selected').position() != 'undefined') {
					$('.paises-list').animate({
						scrollTop: '+=' + ($('.paises-list .selected').position().top - 60) + 'px'
					}, 100);
				} else {
					$('.paises-list').animate({
						scrollTop: '-1000px'
					}, 100);
				}
				if (typeof $('.destinos-list .selected').position() != 'undefined') {
					$('.destinos-list').animate({
						scrollTop: '+=' + ($('.destinos-list .selected').position().top - 60) + 'px'
					}, 100);
				} else {
					$('.destinos-list').animate({
						scrollTop: '-1000px'
					}, 100);
				}
				if (typeof $('.hoteles-list .selected').position() != 'undefined') {
					$('.hoteles-list').animate({
						scrollTop: '+=' + ($('.hoteles-list .selected').position().top - 60) + 'px'
					}, 100);
				} else {
					$('.hoteles-list').animate({
						scrollTop: '-1000px'
					}, 100);
				}
			}, 500);
		}
		//----------------------------------------------------------------------------------------------------------------------------
		var keyDownValue = "";
		var keyUpValue = "";
		$scope.addOnWriteDown = function (event) {
			if (event.keyCode == 13) {
				$scope.dobleIntro = typeof $scope.introPulsado == 'undefined' ? false : true;
				$scope.introPulsado = true;
			} else {
				$scope.introPulsado = undefined;
			}
			keyDownValue = event.target.value;
		}
		//----------------------------------------------------------------------------------------------------------------------------
		//Se dispara al escribir en el input 
		$scope.addOnWrite = function (event) {
			keyUpValue = event.target.value;
			if (keyUpValue === keyDownValue) return true;
			$rootScope.filtroDestinoSelected = undefined;
			$rootScope.cHotelesView = $filter('orderBy')($filter('filter')($rootScope.cHoteles, $rootScope.filtroDestinoSelected), "NAME_F");
			$rootScope.filtroPaisSelected = undefined;
			$rootScope.cDestinosView = $filter('filter')($rootScope.cDestinos, $rootScope.filtroPaisSelected);
			$rootScope.paisSelected = '';
			$rootScope.areaSelected = '';
			$rootScope.hotelInput = keyUpValue;
			switch (true) {
				case ($rootScope.hotelInput.toUpperCase().indexOf('PLAZ') > -1):
					$scope.tipoHotel = 'Plaza';
					$scope.updateInput('tipo');
					break;
				case ($rootScope.hotelInput.toUpperCase().indexOf('CLUBHOTE') > -1):
					$scope.tipoHotel = 'ClubHotel';
					$scope.updateInput('tipo');
					break;
				case ($rootScope.hotelInput.toUpperCase().indexOf('PALAC') > -1):
					$scope.tipoHotel = 'Palace';
					$scope.updateInput('tipo');
					break;
				default:
					$scope.tipoHotel = '';
					$scope.updateInput('text');
			}
			if ($rootScope.hotelInput.length >= 2 || $(".buscador-mix-box").hasClass('open')) {
				if ($scope.iPad) {
					$('#buscador' + $scope.buscador + ' .buscador-mix-box').addClass('open');
				} else {
					$(".buscador-mix-box").addClass('open');
				}
			} else {
				$(".buscador-mix-box").removeClass('open');
			}
		}
		//----------------------------------------------------------------------------------------------------------------------------
		//actualiza el filtro para el buscador e indica si hay resultados
		$scope.updateInput = function (tipo) {
			if (tipo != 'click') {
				if (tipo != 'tipo') {
					$scope.hoteles = tipo === 'click' ? $rootScope.hoteles : ($filter('aproximado')($rootScope.hoteles, $rootScope.hotelInput));
				} else if (tipo == 'tipo') {
					$scope.hoteles = $filter('filter')($rootScope.hoteles, {
						NAME: $scope.tipoHotel
					});
				}
				$scope.setPaisesDestinos($scope.hoteles);
			}
		}
		//----------------------------------------------------------------------------------------------------------------------------
		//filtros
		$scope.byRange = function (maxValue) {
			if (maxValue === undefined) maxValue = Number.MAX_VALUE;
			return function predicateFunc(item) {
				return item <= maxValue;
			};
		};
		//----------------------------------------------------------------------------------------------------------------------------
		// SUBMIT
		//----------------------------------------------------------------------------------------------------------------------------
		$scope.submitGenerico = function (e, promocadeNyc){
			//Validación
			//$scope.validador		= false;
			//setInterval(function() {
			$scope.validador = true;
			//        $scope.$apply() 
			//}, 20);
			var cal = $('#buscador' + $scope.buscador + ' [name="datefilter"]'),
				picker = cal.data("daterangepicker"),
				startDateCopy = angular.copy(picker.startDate);
			$scope.fechaValida = picker.endDate.isSameOrBefore(startDateCopy.add(30, 'days'), 'day') && picker.startDate !== picker.endDate ? false : true;
			$scope.fechaValida = $scope.fechaValida || $scope.dateError;
			$scope.fechaVacia = picker.startDate.isSame(picker.endDate, 'day') ? true : false;
			var hotelesFiltrados = ($filter('aproximado')($rootScope.hoteles, $rootScope.hotelInput))
			if (hotelesFiltrados.length === 1 || (hotelesFiltrados.length >= 1 && $rootScope.hotelInput === hotelesFiltrados[0].NAME)) {
				$rootScope.hotelInput = hotelesFiltrados[0].NAME;
				if ($scope.Stipo === 'home' || ($scope.Stipo == "mixScroll" && $scope.Sorigen == "home")) {
					if ($scope.global.hotelSelected == '' && hotelesFiltrados.length === 1) {
						$scope.noHotelSelected = true;
						$rootScope.hotelInput = $scope.global.areaSelected;
						$scope.destinoValido = true; //false;
					} else {
						$scope.noHotelSelected = false;
						$scope.destinoValido = true;
					}
				} else {
					$scope.destinoValido = true;
				}
				$scope.tipoBusqueda = 'TIPO_BUSQUEDA_HOTEL';
				$rootScope.paisSelected = hotelesFiltrados[0].PAIS;
				$scope.idPais = hotelesFiltrados[0].PAIS;
				$rootScope.areaSelected = hotelesFiltrados[0].DESTINO;
				$scope.idDestino = hotelesFiltrados[0].ID_DESTINO;
				$rootScope.hotelSelected = hotelesFiltrados[0];
				$scope.idHotel = hotelesFiltrados[0].ID_HOTEL;
			} else {
				if ($scope.Stipo === 'home') {
					if ($scope.global.hotelSelected == '') {
						$scope.noHotelSelected = true;
						$rootScope.hotelInput = $scope.global.areaSelected;
					} else {
						$scope.noHotelSelected = false;
					}
				}
				var destinoPrevio = 1,
					paisPrevio = 1,
					lastDestino,
					destinosVarios = false,
					paisesVarios = false;
				angular.forEach(hotelesFiltrados, function (hotel) {
					if (destinoPrevio !== 1 && destinoPrevio !== hotel.DESTINO) {
						destinosVarios = true;
					}
					destinoPrevio = hotel.DESTINO;
					lastDestino = hotel;
					if (paisPrevio !== 1 && paisPrevio !== hotel.PAIS) {
						paisesVarios = true;
					}
					paisPrevio = hotel.PAIS;
					lastDestino = hotel;
				});
				if (!destinosVarios && destinoPrevio !== 1) {
					$rootScope.hotelInput = destinoPrevio;
					$scope.tipoBusqueda = 'TIPO_BUSQUEDA_PAIS_DESTINO';
					$rootScope.paisSelected = lastDestino.PAIS;
					$scope.idPais = lastDestino.PAIS;
					$rootScope.areaSelected = lastDestino.DESTINO;
					$scope.idDestino = lastDestino.ID_DESTINO;
					$rootScope.hotelSelected = lastDestino;
					$scope.idHotel = lastDestino.ID_HOTEL;
					$scope.destinoValido = true;
				} else if (!paisesVarios && paisPrevio !== 1) {
					$rootScope.hotelInput = paisPrevio;
					$scope.destinoValido = false;
				} else {
					$scope.destinoValido = false;
				}
				if ($scope.Stipo === 'oferta') {
					$scope.tipoBusqueda = 'TIPO_BUSQUEDA_HOTEL';
				}
			}
			if ($scope.introPulsado && !$scope.dobleIntro) {
				$scope.introPulsado = false;
				e.preventDefault();
				return false;
			}
			switch ($scope.Stipo) {
				case "home":
					if (!$scope.noHotelSelected && $scope.fechaVacia) {
						riuService.getDestinosHoteles().then(function (data) {
							angular.forEach(data.PAIS, function (pais) {
								angular.forEach(pais.DESTINO, function (destino) {
									angular.forEach(destino.HOTEL, function (hotel) {
										if ($rootScope.hotelInput === hotel.NOMBRE) {
											$window.location.href = hotel.URL_HOTEL;
										}
									});
								});
							});
						});
					}
				case "consulta":
				case "mixScroll":
					if ($scope.Sorigen === 'home' && !$scope.noHotelSelected && $scope.fechaVacia) {
						riuService.getDestinosHoteles().then(function (data) {
							angular.forEach(data.PAIS, function (pais) {
								angular.forEach(pais.DESTINO, function (destino) {
									angular.forEach(destino.HOTEL, function (hotel) {
										if ($rootScope.hotelInput === hotel.NOMBRE) {
											$window.location.href = hotel.URL_HOTEL;
										}
									});
								});
							});
						});
					}
					if ($scope.fechaValida || !$scope.destinoValido) {
						if (!$scope.destinoValido) {
							if ($scope.introPulsado) {
								$scope.clickBuscador();
							} else {
								$scope.focusBuscador();
							}
						} else {
							$scope.focusCalendario();
							if ($scope.Stipo != 'home' && ($scope.Sbuscador != 'mix' && $scope.Sorigen === 'home')) {
								$scope.fechaVacia = false;
							}
						}
						e.preventDefault();
						return false;
					}
					break;
				case "oferta":
				case "ficha":
				case "hotel":
					$scope.fechaVacia = false;
					if ($scope.fechaValida || (!$scope.destinoValido && $scope.Sbuscador === 'destino')) {
						if (!$scope.destinoValido) {
							if ($scope.introPulsado) {
								$scope.clickBuscador();
							} else {
								$scope.focusBuscador();
							}
						} else {
							$scope.focusCalendario()
						}
						e.preventDefault();
						return false;
					}
					$scope.tipoBusqueda = $scope.tipoBusqueda ? $scope.tipoBusqueda : 'TIPO_BUSQUEDA_HOTEL';
					$scope.idHotel = $scope.SidHotel ? $scope.SidHotel : $scope.idHotel;
					angular.forEach($rootScope.hoteles, function (hotel) {
						if ($scope.SidHotel === hotel.ID_HOTEL) {
							$rootScope.hotelSelected = hotel;
							$scope.idDestino = hotel.ID_DESTINO;
							$scope.idPais = hotel.PAIS;
							$rootScope.hotelinput = hotel.NAME;
							$rootScope.areaSelected = hotel.DESTINO;
						}
					});
					break;
				default:
					e.preventDefault();
					break;
			}
			$(".buscador-mix-box").removeClass('open');
			//Generando el JSON para cookies
			var json = {
				"tipoBusqueda": $scope.tipoBusqueda,
				"paisDestino.pais": $scope.idPais,
				"paisDestino.id_pais": $scope.idPais,
				"paisDestino.destino": $scope.idDestino,
				"paisDestino.destino_name": $rootScope.areaSelected,
				"paisDestino.id_destino": $rootScope.areaSelected,
				"paisDestino.hotel_name": $scope.tipoBusqueda === 'TIPO_BUSQUEDA_PAIS_DESTINO' ? '' : $rootScope.hotelSelected.NAME,
				"paisDestino.hotel": $scope.tipoBusqueda === 'TIPO_BUSQUEDA_PAIS_DESTINO' ? -1 : $scope.idHotel,
				"huespedes.numeroHabitaciones": $rootScope.habitaciones,
				"huespedes.habitaciones": [],
				"numeroAdultosTotal": eval($rootScope.adultos.join("+")),
				"numeroNinosTotal": eval($rootScope.ninos.join("+")),
				"fechas.fechaEntradaAsString": '',
				"fechas.fechaSalidaAsString": '',
				"dateFormat.formato": '',
				"fechaEntradaMs": '',
				"fechaSalidaMs": '',
				"codigoPromocional": promocadeNyc?promocadeNyc:$rootScope.Spromocode == 'NY5'? '':$rootScope.Spromocode
			}
			if(promocadeNyc)
				$rootScope.Spromocode = 'NY5';
			for (var i = 1; i <= $rootScope.habitaciones; i++) {
				json["huespedes.habitaciones"].push({
					"numeroAdultos": $rootScope.adultos[i],
					"numeroNinos": $rootScope.ninos[i],
					"edades": []
				})
				//json["huespedes.habitaciones["+i-1+"]numeroAdultos"] = $rootScope.adultos[i];
				for (var j = 1; j <= json["huespedes.habitaciones"][i - 1].numeroNinos; j++) {
					json["huespedes.habitaciones"][i - 1]["edades"].push({
						"value": $rootScope.edadNinos[i][j]
					});
				}
			}
			//Manipulando calendario si existiera
			if ($scope.Scalendario || $scope.Scalendario !== 'no') {
				var format = $scope.$ctrl.formatoFecha ? $scope.$ctrl.formatoFecha : $scope.dateFormat.formato;
				cal.val(picker.startDate.format(format) + " - " + picker.endDate.format(format));
				$rootScope.fechaEntrada = picker.startDate.format(format);
				$rootScope.fechaSalida = picker.endDate.format(format);
				json["fechas.fechaEntradaAsString"] = $rootScope.fechaEntrada;
				json["fechas.fechaSalidaAsString"] = $rootScope.fechaSalida;
				json["dateFormat.formato"] = format;
				json["fechaEntradaMs"] = moment($rootScope.fechaEntrada, format).valueOf();
				json["fechaSalidaMs"] = moment($rootScope.fechaSalida, format).valueOf();
			}
			if ($scope.RC) {
				json["usarPuntos"] = true;
				json["puntosAGastar"] = $scope.RC.ptosDisponible;
			}
			var parsedData = new jsonToKeyValue(json);
			//Guardando las cookies
			if ($scope.Sbuscador === "mix" ||
				$scope.Stipo === "ficha") {
				var caduca = new Date();
				var horas = $scope.ScaducidadCookies ? $scope.ScaducidadCookies : 24;
				caduca.setHours(caduca.getHours() + horas);
				$cookies.put('ub', angular.toJson(parsedData.result), {
					path: '/',
					expires: caduca
				});
			}
			if ($rootScope.hotelSelected.ID_DESTINO.split("_")[0] != 'z')
				riuService.setDestinoVisto($rootScope.hotelSelected.ID_DESTINO.split("_")[1], $rootScope.hotelSelected.ISO);
			if ($scope.Stipo == "consulta") {
				var locActual = window.location.href;
				if (locActual.indexOf('rooms.jsp') > 0) {
					// Hay búsqueda de resultados en la página actual
					$scope.nb = $scope.nb + 1;
					$scope.vtl = "listado-principal";
					$scope.v1tl = "listado-principal";
					json["nb"] = $scope.nb;
					json["vtl"] = $scope.vtl;
					json["v1tl"] = $scope.v1tl;
					json["codigoPromocional"] = json["codigoPromocional"].replace(/%/g, encodeURIComponent('%'));
                    if(json["codigoPromocional"].toUpperCase().contains("&NTILDE;")) {
                        json["codigoPromocional"] = json["codigoPromocional"].toUpperCase().replace("&NTILDE;", "Ñ");
                    }
					var parsedDataExt = new jsonToKeyValue(json);
					history.pushState('', '', "/" + constantes.idioma + "/rooms.jsp?search=" + angular.toJson(parsedDataExt.result));
					e.preventDefault();
					return false;
				}
				if($scope.tipoUsrSes && $scope.tipoUsrSes.type == 'AGENCIA'){
					if($scope.tipoUsrSes.agency.profile == 'RPC')
						window.location = constantes.serverS + "/riupro/my-agents/reserva-rpc?search=" + angular.toJson(parsedData.result);
					else
						window.location = constantes.serverS + "riupro/my-agents/disponibilidad?search=" + angular.toJson(parsedData.result);
					//event.preventDefault();
				}
				else
					window.location = "/" + constantes.idioma + "/rooms.jsp?search=" + angular.toJson(parsedData.result);
			} else {
				if($scope.tipoUsrSes && $scope.tipoUsrSes.type == 'AGENCIA'){
					if($scope.tipoUsrSes.agency.profile == 'RPC')
						window.location = constantes.serverS + "/riupro/my-agents/reserva-rpc?search=" + angular.toJson(parsedData.result);
					else
						window.location = constantes.serverS + "/riupro/my-agents/disponibilidad?search=" + angular.toJson(parsedData.result);
					//event.preventDefault();
				}else if( window.location.href.indexOf('rooms') > 0){
					//Mostrando el loading
					if ($scope.tipoBusqueda === 'TIPO_BUSQUEDA_HOTEL') {
						riuService.showLoadingBuscador(
							'<p>' + $rootScope.hotelSelected.NAME + '</p>' +
							'<p>' + $rootScope.fechaEntrada + ' - ' + $rootScope.fechaSalida + '</p>'
						);
					} else {
						riuService.showLoadingBuscador(
							'<p>' + $rootScope.paisSelected + ' - ' + $rootScope.areaSelected + '</p>' +
							'<p>' + $rootScope.fechaEntrada + ' - ' + $rootScope.fechaSalida + '</p>'
						);
					}
				}
				else
					window.location.href = "/" + constantes.idioma + "/rooms.jsp?search=" + angular.toJson(parsedData.result);
			}
		}
		//Se dispara al hacer submit
		$scope.submit = function (e) {
			var hotelesFiltrados = ($filter('aproximado')($rootScope.hoteles, $rootScope.hotelInput))
			$scope.idHotel = hotelesFiltrados[0].ID_HOTEL;
			if(!$rootScope.Spromocode && $scope.moneteInfo && $scope.moneteInfo.variante == 'Experiment'){
				$scope.submitGenerico(e,'NY5');
			} else if($rootScope.Spromocode && $rootScope.Spromocode == 'NY5' && $scope.idHotel == '5801'){
				$scope.submitGenerico(e,'NY5');
			}else{
				$scope.submitGenerico(e,'');
			}
		};
		//----------------------------------------------------------------------------------------------------------------------------
		// END SUBMIT
		//----------------------------------------------------------------------------------------------------------------------------
		//Formateo de las fechas
		$scope.formatFechas = function (startDate, endDate, open) {
			var bEndDate = (endDate != null) && (endDate.isValid());
			var bStartDate = (startDate != null) && (startDate.isValid());
			var classSelEnd = (bStartDate && open) ? " class='sel' " : "";
			var classSelStart = (!bStartDate && open) ? " class='sel' " : "";
			$scope.nochesEstancia = (bEndDate && bStartDate) ? endDate.diff(startDate, 'days') : null;
			$scope.dateError = (!bEndDate && !bStartDate);
			if ($scope.Stipo === "oferta") {
				$scope.calendarioOferta = (bStartDate ? startDate.format("D MMM") : "<strong" + classSelStart + ">" + $scope.dateFormat.entrada + "</strong>") + " - " + (bEndDate ? endDate.format("D MMM") : "<strong" + classSelEnd + ">" + $scope.dateFormat.salida + "</strong>");
				$scope.endDate = endDate;
				$scope.startDate = startDate;
			} else {
				$rootScope.calendario = (bStartDate ? startDate.format("ddd, D MMM") : "<strong" + classSelStart + ">" + $scope.dateFormat.entrada + "</strong>") + " - " + (bEndDate ? endDate.format("ddd, D MMM") : "<strong" + classSelEnd + ">" + $scope.dateFormat.salida + "</strong>");
				$rootScope.calendarioCorto = (bStartDate ? startDate.format("D MMM") : "<strong" + classSelStart + ">" + $scope.dateFormat.entrada + "</strong>") + " - " + (bEndDate ? endDate.format("D MMM") : "<strong" + classSelEnd + ">" + $scope.dateFormat.salida + "</strong>");
				$rootScope.endDate = endDate;
				$rootScope.startDate = startDate;
			}
		}
		//Lanza automaticamente el calendar picker en Ficha Hotel versión movil al levantar el modal del buscador
		/*$scope.autoShowPicker = function () {
			var calendarTrigger = document.querySelector('#divCalendario' + $scope.buscador);
			var wrappedCalendarTrigger = angular.element(calendarTrigger);
			$timeout(function () {
				angular.element(wrappedCalendarTrigger).triggerHandler('click');
			}, 2000);
		}*/
		//Montando el calendario
		$scope.initCalendar = function () {
			var defer = $q.defer();
			$scope.RC = riuClassSession.riuclass;
			$scope.dateFormat = riuClassSession.dateFormat;
			$scope.dateFormat.formato = $scope.dateFormat.formato.replace("dd", "DD").replace("mm", "MM").replace("yy", "YYYY");
			$scope.dateFormat.primer = parseInt($scope.dateFormat.primer);
			if ($scope.Scalendario || $scope.Scalendario !== 'no') {
				$timeout(function () {
					//daterangepicker
					var firstDay = $scope.$ctrl.primerDiaSemana ? $scope.$ctrl.primerDiaSemana : $scope.dateFormat.primer;
					var format = $scope.$ctrl.formatoFecha ? $scope.$ctrl.formatoFecha : $scope.dateFormat.formato;
					var formatM = $scope.Stipo !== "mixScroll" ? "ddd, D MMM" : "D MMM";
					$scope.cal = $('#buscador' + $scope.buscador + ' [name="datefilter"]');
					var fechasPrev = $scope.Sofertas ? $scope.Sofertas.replace(/-/g, "/").split(" ") : '';
					var fechas = $scope.Sofertas ? [
						[fechasPrev[0], fechasPrev[1], 'periodo-oferta']
					] : [
						[]
					]; //[[DIA INICIO, DIA FIN, CLASE],[OTRO ARRAY],...]
					moment.updateLocale('en', {
						monthsShort: $scope.dateFormat.mesesCortos3,
						weekdaysShort: $scope.dateFormat.diasCortos3,
						weekdaysMin: $scope.dateFormat.diasCortos3
					});
					var parent = "";
					if ($scope.Stipo == "mixScroll" && $scope.Sbuscador == "mix") parent = $('#buscador' + $scope.buscador);
					if ($scope.Stipo == "ficha" && $scope.Sbuscador == "destino") parent = $('#buscador' + $scope.buscador);
					$scope.cal.daterangepicker({
						autoUpdateInput: false,
						parentEl: parent,
						opens: "center",
						minDate: moment(), //hoy
						autoApply: true,
						drops: $scope.Stipo === "oferta" ? "up" : "down",
						locale: {
							firstDay: firstDay,
							format: formatM,
							daysOfWeek: $scope.dateFormat.diasCortos,
							monthNames: $scope.dateFormat.meses
						},
						//se le llama una vez por cada día, y se le devuelve la clase css a aplicar a ese día
						isCustomDate: function (dia) {
							for (var i = 0; i < fechas.length; i++) {
								if (dia.isBetween(moment(fechas[i][0], 'YYYY/MM/DD'), moment(fechas[i][1], 'YYYY/MM/DD'), 'day', '[]')) return fechas[i][2];
							}
						}
					});
					$scope.cal.on('show.daterangepicker', function (ev, picker) {
						if ($scope.Stipo === 'oferta') {
							var span = document.createElement("span");
							span.className = "legend-info";
							if ($scope.Sofertas)
								span.className = 'legend-info tiene-oferta';
							var txt = document.createTextNode($scope.diasPromo);
							span.appendChild(txt)
							picker.container[0].appendChild(span);
							$scope.formatFechas($scope.startDate, $scope.endDate, true);
							$scope.$apply();
						} else {
							if ($rootScope.startDate != null && $rootScope.startDate.isValid()) {
								picker.setStartDate($rootScope.startDate.clone());
								picker.endDate = null;
							}
							if ($rootScope.endDate != null && $rootScope.endDate.isValid()) picker.setEndDate($rootScope.endDate.clone());
							picker.updateView();
							$scope.formatFechas($rootScope.startDate, $rootScope.endDate, true);
							$scope.$apply();
						}
						if (picker.endDate == null || !picker.endDate.isValid()) {
							picker.setStartDate(picker.startDate.clone());
							picker.endDate = null;
							picker.updateView();
						}
					});
					$scope.cal.on('clickDate.daterangepicker', function (ev, picker) {
						$scope.formatFechas(picker.startDate, picker.endDate, true);
						$scope.$apply();
					});
					$scope.cal.on('hide.daterangepicker', function (ev, picker) {
						//if($scope.validador){
						var startDateCopy = angular.copy(picker.startDate)
						$scope.fechaValida = picker.endDate.isSameOrBefore(startDateCopy.add(30, 'days'), 'day') ? false : true;
						//}
						if ($scope.Stipo === 'oferta') {
							var span = picker.container[0].lastElementChild;
							picker.container[0].removeChild(span);
							$scope.formatFechas($scope.startDate, $scope.endDate, false);
						} else {
							$scope.formatFechas($rootScope.startDate, $rootScope.endDate, false);
						}
						$scope.$apply();
					});
					$scope.cal.on('apply.daterangepicker', function (ev, picker) {
						if (picker.endDate.isSameOrBefore(picker.startDate, 'day')) {
							picker.endDate.add(1, 'days');
						}
						$scope.formatFechas(picker.startDate, picker.endDate, false);
						$scope.$apply();
					});
					defer.resolve($scope.cal.data("daterangepicker"));
				});
			}
			return defer.promise;
		}
		$scope.setValueStr = function(s){
			$scope.strBusAge = s;
		}
		$scope.inicio = function () {
			// Inicio del proceso, creamos el daterangepicker y cargamos los hoteles con venta
			$q.all([$scope.initCalendar(), riuService.getDestinosHotelesSimple()]).then(function (d) {
				console.log("$scope.$ctrl.lh=" + $scope.$ctrl.lh);
				if (typeof $rootScope.hoteles === 'undefined') {
					$rootScope.hoteles = [];
					console.log("No existe $rootScope.hoteles ");
					angular.forEach(d[1].PAIS, function (pais) {
						angular.forEach(pais.DESTINO, function (destino) {
							angular.forEach(destino.HOTEL, function (hotel) {
								var show = (angular.isUndefined($scope.$ctrl.lh) || $scope.$ctrl.lh == "" || _.indexOf($scope.$ctrl.lh.split(','), hotel.ID_RUMBO) > -1);
								if (angular.isDefined($scope.$ctrl.ld)) {
									show = show || (_.indexOf($scope.$ctrl.ld.split(','), destino.ID_UNICO.split('_')[1]) > -1)
								};
								if (angular.isDefined($scope.$ctrl.lp)) {
									show = show || (_.indexOf($scope.$ctrl.lp.split(','), pais.ID_UNICO) > -1)
								};
								if (show) {
									$rootScope.hoteles.push({
										"ID_HOTEL": hotel.ID_RUMBO,
										"NAME": hotel.NOMBRE.replace(" (*)", ""),
										"NAME_F": buscadorUtils.removeExtras(hotel.NOMBRE), //Nombre de hotel filtrado
										"NAME_A": buscadorUtils.removeAcentos(hotel.NOMBRE),
										"ID_PAIS": pais.ID_UNICO,
										"PAIS": pais.NAME,
										"ISO": pais.ISO,
										"PAIS_A": buscadorUtils.removeAcentos(pais.NAME),
										"ID_DESTINO": destino.ID_UNICO,
										"DESTINO": destino.NAME,
										"DESTINO_A": buscadorUtils.removeAcentos(destino.NAME)
									});
								}
							});
						});
					});
					$rootScope.hotelesRandom = $rootScope.hoteles;
				} else {
					console.log("Existe $rootScope.hoteles ");
				}
				$scope.hoteles = $rootScope.hoteles;
				$scope.setPaisesDestinos($scope.hoteles);
				//Filtrado Hoteles en ficha destino
				if (!!$scope.SidDestino || !!$scope.SidZona) {
					$rootScope.hotelesRandom = [];
					angular.forEach($rootScope.hoteles, function (hotel) {
						if ($scope.SidDestino == hotel.ID_DESTINO.substring(2) || $scope.SidZona == hotel.ID_DESTINO.substring(2)) {
							$rootScope.hotelesRandom.push(hotel);
						}
					});
					if ($rootScope.hotelesRandom.length === 1)
						$rootScope.hotelInput = $rootScope.hotelesRandom[0].NAME;
				}
				//Filtrado Hoteles determinados
				if (!!$scope.SmostrarHoteles) {
					$rootScope.hotelesRandom = [];
					angular.forEach(eval($scope.SmostrarHoteles), function (id) {
						angular.forEach($rootScope.hoteles, function (hotel) {
							if (id == hotel.ID_HOTEL)
								$rootScope.hotelesRandom.push(hotel);
						});
					});
				}
				//---------------------------------
				if ($location.$$search.dateIn) {
					var form = "DD/MM/YYYY";
					if ($location.$$search.dateFmt != "es") form = "MM/DD/YYYY";
					var picker = $scope.cal.data("daterangepicker");
					if (picker) {
						if (form == $scope.dateFormat.formato) {
							picker.startDate = moment($location.$$search.dateIn, $scope.dateFormat.formato, true);
							picker.endDate = moment($location.$$search.dateOut, $scope.dateFormat.formato, true);
							$scope.formatFechas(picker.startDate, picker.endDate, false);
						} else {
							var m1 = moment($location.$$search.dateIn, form, true);
							var m2 = moment($location.$$search.dateOut, form, true);
							picker.startDate = moment(m1.format($scope.dateFormat.formato), $scope.dateFormat.formato, true);
							picker.endDate = moment(m2.format($scope.dateFormat.formato), $scope.dateFormat.formato, true);
							$scope.formatFechas(picker.startDate, picker.endDate, false);
						}
					}
				} else {
					if (ultimaBusqueda) $scope.loadSearchAB(ultimaBusqueda);
					else {
						if ($rootScope.fechaEntrada !== "") {
							$scope.formatFechas(moment($rootScope.fechaEntrada, 'DD-MM-YYYY'), moment($rootScope.fechaSalida, 'DD-MM-YYYY'), false);
						} else {
							$scope.formatFechas(null, null, false);
						}
					}
				}
				//---------------------------------
				//busquedas hoteles
				angular.forEach($rootScope.hoteles, function (hotel) {
					if (($scope.Stipo === 'oferta' || $scope.Stipo === 'hotel' || $scope.Stipo === 'ficha') && ($scope.SidHotel == hotel.ID_HOTEL)) {
						$scope.idDestino = hotel.ID_DESTINO;
						$scope.idPais = hotel.ID_PAIS;
						$rootScope.hotelinput = hotel.NAME;
						$scope.tipoBusqueda = 'TIPO_BUSQUEDA_HOTEL';
					}
				});
				//funciones destinos/hoteles random
				if (angular.isDefined($rootScope.hotelesRandom)) {
					if ($rootScope.hotelesRandom.length >= 1) {
						if (!!$scope.SidDestino || !!$scope.SidZona) {
							$rootScope.hotelInput = $rootScope.hotelesRandom[0].DESTINO;
							$scope.tipoBusqueda = 'TIPO_BUSQUEDA_PAIS_DESTINO';
							$scope.destinoValido = true;
						}
					} else {
						console.error("Hoteles no encontrados, Hoteles/Destinos aleatorios no mostrados.");
					}
				}
				if($rootScope.hotelInput) {
                    if($rootScope.hotelInput && $rootScope.hotelInput.contains("+")) {
                        $rootScope.hotelInput = $rootScope.hotelInput.replace(/\+/g, ' ');
                    }
                }
			});
		}
		$scope.SetDatalayerMoneteInfo = function(obj){
			for(var i = 0; i < obj.length; i++){
					var resp = obj[i];
					if(resp.actions && resp.actions.length > 0){
						for(var j = 0; j < resp.actions.length; j++){
							var act = resp.actions[j];
							if(act.json && act.json.swiGA && act.json.swiGA == true){
								window.dataLayer.push({
								'event':'GAEvent',
								'eventCategory':'Monetate',
								'eventAction':act.json.exp,
								'eventLabel': act.json.variante
								});
							}
						}
					}
				}
		}
		var count = 0;
		var myVar = setInterval(()=>{
			count = count +1;
			if(count > 9 || ($rootScope.tipoUsrSesGen && $rootScope.tipoUsrSesGen.type)){
				if($rootScope.tipoUsrSesGen){
					$scope.tipoUsrSes = $rootScope.tipoUsrSesGen;
					if($scope.tipoUsrSes && $scope.tipoUsrSes.type == 'AGENCIA' && $('.busAgenLi').length == 0){
		       			var strEnlace = '/riupro/my-agents/disponibilidad';
		       			if($scope.tipoUsrSes.agency.profile == 'RPC')
							strEnlace = "/riupro/my-agents/reserva-rpc";
		       			$('#ulTabOptBusq').append( " <li role='presentation' class='tab busAgenLi'><a href="+constantes.serverS + strEnlace +">"+$scope.strBusAge+"</a></li>" );
		       			$('#search-form').append( "<div class='vuelo-hotel-box busAgenLi'><a href="+constantes.serverS + strEnlace +" class='vuelo-hotel-link'>"+$scope.strBusAge+"</a></div>"  );
		       			$('body').addClass('usr-log-agents');
	       			}
				}
				clearInterval(myVar);
			}
		}, 1000);
		if (angular.isUndefined(riuClassSession.dateFormat.formato)) {
			$scope.$on('SessionUpdated', function () {
				$scope.inicio();
			});
		} else {
			$scope.inicio();
		}
	}
}());
/**
 * Serialize JSON object to custom object
 * @param {type} raw
 * @returns {object}
 */
var jsonToKeyValue = function (raw) {
	var myself = this;
	this.result = {};
	this.customParser = function (data, tempString) {
		$.each(data, function (key, data) {
			if (key != "$$hashKey") {
				if ((typeof data === 'object') && (!Array.isArray(data))) {
					myself.customParser(data, tempString + key + '.');
				} else if (Array.isArray(data)) {
					$.each(data, function (index, data) {
						myself.customParser(data, tempString + key + '[' + index + '].');
					});
				} else {
					if (!!tempString) {
						myself.result[tempString + key] = data;
					} else {
						myself.result[key] = data;
					}
				}
			}
		});
	};
	//If the user pass data it'll parse it
	if (!!raw) {
		this.customParser(raw, "");
	}
};
function openBuscador() {
    $("#buscador-hoteles-mobile")[0].click();
}


(function() {
	'use strict'
	app.factory('serviceTripAdvisor', function($rootScope, $http, $q, riuService, constantes){
		return  {
			getTripAdvisorJSON: function(idhotel) {
				var defer = $q.defer();
				if (angular.isUndefined($rootScope.TripAdvisorList )) {
					$rootScope.TripAdvisorList = [];
				}
				var servicio = constantes.serverS +  "/json-utils!getInfoTripAdvisor.action?formato=json&params.fulltext=true&params.lang="+constantes.idioma+"&params.idRumboHotel="+idhotel;
				if (angular.isUndefined($rootScope.TripAdvisorList[idhotel])) {
					$http.get(servicio, 
						{withCredentials: true } ).success(function(data)
						{
							$rootScope.TripAdvisorList[idhotel] = data;
							defer.resolve(data);
						}).error(function(data, status, headers, config) 
						{
							defer.resolve(status);
						});
				} else {
						defer.resolve($rootScope.TripAdvisorList[idhotel]);
				}				
				return defer.promise;
			},
			procesaComentarios : function (comentarios) {
				angular.forEach( comentarios, function(r) {
					if (r.text.length > 200)
						r['text_short'] = r.text.substring(0, 190) + '...';
					if (r.owner_response)
					{
						if (r.owner_response.text.length > 200)
							r.owner_response['text_short'] = r.owner_response.text.substring(0, 190) + '...';						
					}
				});	
				return comentarios;
			}
		}
	});
	app.component("tripAdvisor", {
		templateUrl: function(constantes) { return "/"+constantes.idioma + constantes.templateFolder + "/cmp-trip-advisor.jsp?request.aspect=desk"; },
		bindings : { idhotel:'@', rating:'@', reviews:'@', urlratingta:'@', showpopup:'@', modulo : '@'},
		controller: ctrlTripAdvisor
	});
	app.component("fcTripadvisor", {
		templateUrl: function(constantes) { return "/"+constantes.idioma + constantes.templateFolder + "/cmp-fc-tripadvisor.jsp?request.aspect=desk"; },
		bindings : { idhotel:'@', modulo : '@'},
		controller: ctrlTripAdvisor
	});
	app.component("tripAdvisorPopup", {
		templateUrl: function(constantes) { return "/"+constantes.idioma + constantes.templateFolder + "/cmp-trip-advisor.jsp?request.aspect=desk"; },
		bindings : { idhotel:'@'},
		controller: ctrlTripAdvisorPopup
	});	
	ctrlTripAdvisor.$inject = ['constantes', '$rootScope', '$scope', 'riuService', 'serviceTripAdvisor', 'ngDialog', 'riuClassSession', '$controller'];
	function ctrlTripAdvisor(constantes, $rootScope, $scope, riuService, serviceTripAdvisor, ngDialog, riuClassSession, $controller) {
		if ($scope.$ctrl.modulo) {
			angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
			$scope.modulo = this;
		}
		$scope.idhotel = $scope.$ctrl.idhotel;
		$scope.rating = $scope.$ctrl.rating;
		$scope.reviews = $scope.$ctrl.reviews;
		$scope.urlratingta = $scope.$ctrl.urlratingta;
		$scope.showpopup = $scope.$ctrl.showpopup;
		$scope.template_comentarios = "/"+constantes.idioma + constantes.templateFolder + "/cmp-fc-tripadvisor-comentarios.jsp?request.aspect=desk";
		$scope.procesaComentarios = function (comentarios) {
			angular.forEach( comentarios, function(r) {
				if (r.text.length > 200)
					r['text_short'] = r.text.substring(0, 190) + '...';
				if (r.owner_response)
				{
					if (r.owner_response.text.length > 200)
						r.owner_response['text_short'] = r.owner_response.text.substring(0, 190) + '...';						
				}
			});		
		}
		$scope.loadTA = function() {
			$scope.formato = riuClassSession.dateFormat.formato.toLowerCase().replace('mm', 'MM') + ' hh:mm';
			if (angular.isUndefined($rootScope.tripadvisor) || $scope.showpopup)
			{
				serviceTripAdvisor.getTripAdvisorJSON($scope.idhotel).then(function(d) {
					if (angular.isUndefined(d.classNameExceptionJson)) {
						d.reviews = serviceTripAdvisor.procesaComentarios(d.reviews);
						$rootScope.tripadvisor = d;
						$scope.tripadvisor = $rootScope.tripadvisor;
						$scope.tripadvisor['formato'] = $scope.formato;
					}else if ($scope.$ctrl.modulo) {
						if (angular.isDefined($scope.modulo.hide)) $scope.modulo.hide();
					}
				});
			}
			else {
				$scope.tripadvisor = $rootScope.tripadvisor;
				$scope.tripadvisor['formato'] = $scope.formato;
			}
		}
		if ( !$scope.rating ) 
		{
			if (angular.isUndefined(riuClassSession.dateFormat.formato)) {
				$scope.$on('SessionUpdated', function() {			
					$scope.loadTA();
				});
			} else {
				$scope.loadTA();
			}
		}
		$scope.showPopupComentarios = function () {
			serviceTripAdvisor.getTripAdvisorJSON($scope.idhotel).then(function(d) {
				$scope.tripadvisor = d;
				$scope.formato = riuClassSession.dateFormat.formato.toLowerCase().replace('mm', 'MM') + ' hh:mm';
				$scope.procesaComentarios(d.reviews);
				$scope.tripadvisor['formato'] = $scope.formato;
				ngDialog.open({
					template: $scope.template_comentarios, 
					className: 'ngdialog-theme-default', 
					data: $scope.tripadvisor
				});
			});
		}
	}
	ctrlTripAdvisorPopup.$inject = ['constantes', '$rootScope', '$scope', 'riuService', 'serviceTripAdvisor', 'ngDialog', 'riuClassSession'];
	function ctrlTripAdvisorPopup(constantes, $rootScope, $scope, riuService, serviceTripAdvisor, ngDialog, riuClassSession) {
		$scope.idhotel = $scope.$ctrl.idhotel;
		$scope.showpopup = true;
		if (angular.isUndefined($rootScope.tripadvisorList) )
		{
			$rootScope.tripadvisorList = [];
		}
		$scope.template_comentarios = "/"+constantes.idioma + constantes.templateFolder + "/cmp-fc-tripadvisor-comentarios.jsp?request.aspect=desk";
		$scope.loadTA = function() {
			$scope.formato = riuClassSession.dateFormat.formato.toLowerCase().replace('mm', 'MM') + ' hh:mm';
			if (angular.isUndefined($rootScope.tripadvisorList[$scope.idhotel]) || $scope.showpopup)
			{
				serviceTripAdvisor.getTripAdvisorJSON($scope.idhotel).then(function(d) {
					if (angular.isUndefined(d.classNameExceptionJson)) {
						d.reviews = serviceTripAdvisor.procesaComentarios(d.reviews);
						$rootScope.tripadvisorList[$scope.idhotel] = d;
						$scope.tripadvisor = $rootScope.tripadvisorList[$scope.idhotel];
						$scope.tripadvisor['formato'] = $scope.formato;
					}
				});
			}
			else {
				$scope.tripadvisor = $rootScope.tripadvisorList[$scope.idhotel];
				$scope.tripadvisor['formato'] = $scope.formato;
			}
		}
		$scope.showPopupComentarios = function () {
			/*serviceTripAdvisor.getTripAdvisorJSON($scope.idhotel).then(function(d) {
				$scope.tripadvisor = d;
				$scope.formato = riuClassSession.dateFormat.formato.toLowerCase().replace('mm', 'MM') + ' hh:mm';
				$scope.procesaComentarios(d.reviews);
				$scope.tripadvisor['formato'] = $scope.formato;
			*/	
				ngDialog.open({
					template: $scope.template_comentarios, 
					className: 'ngdialog-theme-default', 
					data: $scope.tripadvisor
				});
			//});
		}
		$scope.loadTA();
	}
}());


(function() {
	'use strict'
	app.component("fcAccesibilidad", {
		templateUrl: function(constantes) { return "/"+constantes.idioma + constantes.templateFolder + "/cmp-fc-accesibilidad.jsp?request.aspect=desk"; },
		bindings : { idhotel:'@', modulo : '@', hotel : '@'},
		controller: ctrlAccesibilidad
	});
	ctrlAccesibilidad.$inject = ['constantes', '$rootScope', '$scope', 'riuService', 'ngDialog', 'riuClassSession', '$controller', '$q'];
	function ctrlAccesibilidad(constantes, $rootScope, $scope, riuService, ngDialog, riuClassSession, $controller,$q) {
		var etiquetasBusqueda="RIU2017.ficha-hotel.accesibilidad-intro,RIU2017.ficha-hotel.accesibilidad-instalaciones."+ $scope.$ctrl.idhotel
		+",RIU2017.ficha-hotel.accesibilidad-habitaciones."+$scope.$ctrl.idhotel + ",RIU2017.ficha-hotel.accesibilidad-detalles."+$scope.$ctrl.idhotel;
		$scope.etiquetas = null;
		$scope.template_mas_info = "/"+constantes.idioma + constantes.templateFolder + "/cmp-fc-accesibilidad-info.jsp";
		$scope.idhotel = $scope.$ctrl.idhotel;
		if ($scope.$ctrl.modulo) {
			angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
			$scope.modulo = this;
		}
		if (angular.isUndefined($rootScope.first)) {
			$rootScope.first = false;
			$q.all([riuService.getEtiquetas(etiquetasBusqueda)]).then(function(data){
				$scope.etiquetas = data[0];
				$scope.etiquetas['RIU2017.ficha-hotel.accesibilidad-intro'] = $scope.etiquetas['RIU2017.ficha-hotel.accesibilidad-intro'].replace('#0#', $scope.$ctrl.hotel);
				$scope.etiquetas['RIU2017.ficha-hotel.accesibilidad-instalaciones'] = $scope.etiquetas['RIU2017.ficha-hotel.accesibilidad-instalaciones.'+ $scope.$ctrl.idhotel];
				$scope.etiquetas['RIU2017.ficha-hotel.accesibilidad-habitaciones'] = $scope.etiquetas['RIU2017.ficha-hotel.accesibilidad-habitaciones.'+ $scope.$ctrl.idhotel];
				$scope.etiquetas['RIU2017.ficha-hotel.accesibilidad-mas-info'] = $scope.etiquetas['RIU2017.ficha-hotel.accesibilidad-detalles.'+ $scope.$ctrl.idhotel];
			});
		}
	}
}());


(function() {
	'use strict'
//fc-hotel-faqs
	app.component("fcHotelFaqs", {
		templateUrl: function(constantes) { return "/"+constantes.idioma + constantes.templateFolder + "/cmp-fc-hotel-faqs.jsp"; },
		bindings : { idhotel:'@', modulo : '@', hotel : '@'},
		controller: ctrlHotelFaqs
	});
	ctrlHotelFaqs.$inject = ['constantes', '$rootScope', '$scope', 'riuService', 'ngDialog', 'riuClassSession', '$controller', '$q'];
	function ctrlHotelFaqs(constantes, $rootScope, $scope, riuService, ngDialog, riuClassSession, $controller,$q) {
		$scope.jsonLd = null; 
		if ($scope.$ctrl.modulo) {
			angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
			$scope.modulo = this;			
		}
		setTimeout(()=>{
			//divFaqHide Esta en el coponente de la descripción que hay en tridion
			if($( "#divFaqHide").html())
				$( "#divFaqCmp").html($( "#divFaqHide").html().replace(/hide/gi, ''));
		})
	}
}());


(function() {
	'use strict'
	app.component("fcSkybar", {
		templateUrl: function(constantes) { return "/"+constantes.idioma + constantes.templateFolder + "/cmp-fc-skybar.jsp?request.aspect=desk"; },
		bindings : { idhotel:'@', modulo : '@', hotel : '@'},
		controller: ctrlSkybar
	});
	ctrlSkybar.$inject = ['constantes', '$rootScope', '$scope', 'riuService', 'ngDialog', 'riuClassSession', '$controller', '$q'];
	function ctrlSkybar(constantes, $rootScope, $scope, riuService, ngDialog, riuClassSession, $controller,$q) {
		var etiquetasBusqueda="RIU2017.ficha-hotel.descripcion,RIU2017.ficha-hotel.horario.descripcion";
		$scope.etiquetas = null;
		if ($scope.$ctrl.modulo) {
			angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
			$scope.modulo = this;
		}
		if (angular.isUndefined($rootScope.firstSky)) {
			$rootScope.firstSky = false;
			$q.all([riuService.getEtiquetas(etiquetasBusqueda)]).then(function(data){
				$scope.etiquetas = data[0];
				console.info('$scope.etiquetas');
				console.info($scope.etiquetas);
			});
		}
		$scope.verHorarios = function(){
			ngDialog.open({	template: 'popupHorarios', scope: $scope, className: 'ngdialog-theme-default' });
		}
	}
}());


	app.factory('serviceMapaMacrohotel', function($http, $q, riuService, constantes){
		return  {
		}
	});
	app.component("mapaMacrohoteles", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+constantes.templateFolder+"/cmp-mapa-macrohoteles.jsp"; },
		controller: ctrlMapaMacrohotel
	});
	app.component("mapaMacrohotelesAll", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+constantes.templateFolder+"/cmp-mapa-macrohoteles-all.jsp"; },
		controller: ctrlMapaMacrohotel
	});
	app.component("mapaDestinos", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+constantes.templateFolder+"/cmp-mapa-macrohoteles.jsp"; },
		bindings : { iddestino:'@'},
		controller: ctrlMapaMacrohotel
	});	
	app.component("mapaHotel", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+constantes.templateFolder+"/cmp-mapa-macrohoteles.jsp"; },
		bindings : { idhotel:'@'},
		controller: ctrlMapaMacrohotel
	});		
app.component("mapaGuiaDestino", {
    templateUrl: function (constantes) {
        return "/" + constantes.idioma + constantes.templateFolder + "/cmp-mapa-guia-destino.jsp";
    },
    bindings: {idhotel: '@'},
    controller: ctrlMapaGuiaDestino
});
ctrlMapaGuiaDestino.$inject = ['serviceMapaMacrohotel', '$scope', '$rootScope', '$http', '$interval', 'riuService', '$q', 'constantes', 'ngDialog', 'NgMap', '$timeout'];
function ctrlMapaGuiaDestino(serviceMapaMacrohotel, $scope, $rootScope, $http, $interval, riuService, $q, constantes, ngDialog, NgMap, $timeout) {
     $scope.objMapEquivalencia = [
       {'hot': '3502', 'destino': '80779', 'placeId': '84803'},
       {'hot': '2801', 'destino': '80216', 'placeIAd': '84800'},
       {'hot': '7002', 'destino': '124458', 'placeId': ',84808'},
       {'hot': '2101', 'destino': '35626', 'placeId': '84807'}, 
       {'hot': '1401', 'destino': '40118', 'placeId': '84814'},
       {'hot': '581', 'destino': '9694', 'placeId': '84820'},
       {'hot': '5724', 'destino': '51542', 'placeId': '84813'},
       {'hot': '5801', 'destino': '58902', 'placeId': '84809'},
       {'hot': '4401', 'destino': '101547', 'placeId': '84805'},
       {'hot': '141', 'destino': '24436', 'placeId': '84816'},
       {'hot': '5802', 'destino': '58902', 'placeId': '1002406'}
       ];
    $scope.infoHotel;
    $scope.getDestino = function(){
        for (var i = 0; i < $scope.objMapEquivalencia.length; i++) {
            if($scope.objMapEquivalencia[i].hot == $scope.$ctrl.idhotel)
                return $scope.objMapEquivalencia[i].destino
        }
    }
    $scope.getPlaceId = function(){
        for (var i = 0; i < $scope.objMapEquivalencia.length; i++) {
            if($scope.objMapEquivalencia[i].hot == $scope.$ctrl.idhotel)
                return $scope.objMapEquivalencia[i].placeId;
        }
    }
    $scope.getIdioma = function (){
        return constantes.idioma;
    }
    riuService.getDestinosHotelesAndURIURL().then(function (d) {
        angular.forEach(d[1].PAIS, function (pais) {
            angular.forEach(pais.DESTINO, function (destino) {
                if ($scope.$ctrl.idhotel) {
                    angular.forEach(destino.HOTEL, function (hotel) {
                        if ($scope.$ctrl.idhotel == hotel.ID_RUMBO) {
                            $scope.infoHotel = hotel;
                        }
                    });
                }
            });
        });
    });
}
	ctrlMapaMacrohotel.$inject = ['serviceMapaMacrohotel', '$scope', '$rootScope', '$http', '$interval', 'riuService', '$q', 'constantes', 'ngDialog', 'NgMap', '$timeout'];
	function ctrlMapaMacrohotel(serviceMapaMacrohotel, $scope, $rootScope, $http, $interval, riuService, $q, constantes, ngDialog, NgMap, $timeout) {
		$scope.hoteles = [];
		$scope.iddestino = $scope.$ctrl.iddestino?$scope.$ctrl.iddestino:null;
		$scope.urlMaps = constantes.urlGMapKey;
		$scope.idhotel = $scope.$ctrl.idhotel?$scope.$ctrl.idhotel:null;
		//$scope.urlMaps = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyCTp3sHeGCl5k_BhSnBaL2U0yqvtRvxQOc
/* map styles */
var styles = 	[/*
  {
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#212121"
      }
    ]
  },
  {
    "elementType": "labels.icon",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#757575"
      }
    ]
  },
  {
    "elementType": "labels.text.stroke",
    "stylers": [
      {
        "color": "#212121"
      }
    ]
  },
  {
    "featureType": "administrative",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#2a2b34"
      }
    ]
  },
  {
    "featureType": "administrative.country",
    "elementType": "geometry.stroke",
    "stylers": [
      {
        "color": "#323744"
      },
      {
        "visibility": "on"
      },
      {
        "weight": 2
      }
    ]
  },
  {
    "featureType": "administrative.country",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#d1d1d1"
      }
    ]
  },
  {
    "featureType": "administrative.land_parcel",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "administrative.locality",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#d1d1d1"
      }
    ]
  },
  {
    "featureType": "administrative.neighborhood",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "poi",
    "elementType": "labels.text",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "poi",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#757575"
      }
    ]
  },
  {
    "featureType": "poi.park",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#181818"
      }
    ]
  },
  {
    "featureType": "poi.park",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#616161"
      }
    ]
  },
  {
    "featureType": "poi.park",
    "elementType": "labels.text.stroke",
    "stylers": [
      {
        "color": "#1b1b1b"
      }
    ]
  },
  {
    "featureType": "road",
    "elementType": "geometry.fill",
    "stylers": [
      {
        "color": "#2c2c2c"
      }
    ]
  },
  {
    "featureType": "road",
    "elementType": "labels",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "road",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#8a8a8a"
      }
    ]
  },
  {
    "featureType": "road.arterial",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "road.arterial",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#373737"
      }
    ]
  },
  {
    "featureType": "road.highway",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#3c3c3c"
      }
    ]
  },
  {
    "featureType": "road.highway",
    "elementType": "labels",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "road.highway.controlled_access",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#4e4e4e"
      }
    ]
  },
  {
    "featureType": "road.local",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "road.local",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#616161"
      }
    ]
  },
  {
    "featureType": "transit",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#757575"
      }
    ]
  },
  {
    "featureType": "water",
    "elementType": "geometry",
    "stylers": [
      {
        "color": "#323744"
      }
    ]
  },
  {
    "featureType": "water",
    "elementType": "labels.text",
    "stylers": [
      {
        "visibility": "off"
      }
    ]
  },
  {
    "featureType": "water",
    "elementType": "labels.text.fill",
    "stylers": [
      {
        "color": "#3d3d3d"
      }
    ]
  }
*/];
		$scope.jVector = false;
		$scope.showMap = false;
		$scope.etiquetas = {};
		$scope.obtenerImagen = function(hotel, d){
			var idx = _.findIndex(d[0].HOTEL, {'ID_RUMBO': hotel.ID_RUMBO} );
			if (idx > -1) {
				hotel.IMG = d[0].HOTEL[idx].IMAGEN_503;
			}
		}
		riuService.getDestinosHotelesAndURIURL().then(function(d) {
			angular.forEach(d[1].PAIS, function(pais) {
				angular.forEach(pais.DESTINO, function(destino) {
					if($scope.idhotel){
						angular.forEach(destino.HOTEL, function(hotel) {
							if($scope.idhotel == hotel.ID_RUMBO){
								$scope.obtenerImagen(hotel, d);
								$scope.hoteles.push( hotel );
							}
						});	
					}else if($scope.iddestino){
						if($scope.iddestino == destino.ID_UNICO){
							angular.forEach(destino.HOTEL, function(hotel) {
								$scope.obtenerImagen(hotel, d);
								$scope.hoteles.push( hotel );
							});	
						}
					}else{
						angular.forEach(destino.HOTEL, function(hotel) {
							$scope.obtenerImagen(hotel, d);
							$scope.hoteles.push( hotel );
						});	
					}
				});
			});
			riuService.setPrecioDesde($scope.hoteles); 
			$scope.createMarkerForCity = function (hotel) {
				var marker = new google.maps.Marker({
					position: new google.maps.LatLng(hotel.GPS.split(",")[0], hotel.GPS.split(",")[1]),
					icon: '/fcs_images/riu2017/marker-single.png',
					title: hotel.NOMBRE
				});
				google.maps.event.addListener(marker, 'click', function () {
					$scope.selHotel = hotel;
					$scope.map.showInfoWindow('idinfo', this);
				});
				return marker;
			}
			$scope.showMap = true;
			NgMap.getMap().then(function(map) {
				$scope.map = map;
				$scope.map.setOptions({styles: styles});
				if($scope.$ctrl.idhotel){
					var pt = new google.maps.LatLng($scope.hoteles[0].GPS.split(",")[0], $scope.hoteles[0].GPS.split(",")[1]);
					map.setCenter(pt);
					if ($scope.hoteles[0].CIUDAD=="Si") {map.setZoom(14);} else {map.setZoom(12);}
				}
				else if($scope.$ctrl.iddestino){
					var pt = new google.maps.LatLng($scope.hoteles[0].GPS.split(",")[0], $scope.hoteles[0].GPS.split(",")[1]);
					map.setCenter(pt);
					if ($scope.hoteles[0].CIUDAD=="Si") {map.setZoom(14);} else {map.setZoom(9);}
				}
				var markers = $scope.hoteles.map(function (hotel) {
					return $scope.createMarkerForCity(hotel);
				});
				var mcOptions = { styles: [{
					height: 53,
					url: "/fcs_images/riu2017/cluster-1.png",
					width: 53,
					textColor: '#ffffff'
					},
					{
					height: 56,
					url: "/fcs_images/riu2017/cluster-2.png",
					width: 56,
					textColor: '#ffffff'
					},
					{
					height: 66,
					url: "/fcs_images/riu2017/cluster-3.png",
					width: 66,
					textColor: '#ffffff'
					},
					{
					height: 78,
					url: "/fcs_images/riu2017/cluster-4.png",
					width: 78,
					textColor: '#ffffff'
					},
					{
					height: 90,
					url: "/fcs_images/riu2017/cluster-5.png",
					width: 90,
					textColor: '#ffffff'
					}], 
					maxZoom : 10, zoomOnClick : true, gridSize : 20, averageCenter : false };
				new MarkerClusterer($scope.map, markers, mcOptions);
				if($scope.$ctrl.idhotel){
					$scope.selHotel = $scope.hoteles[0]	;			
					$timeout(function() {
                                             map.showInfoWindow('idinfo', markers[0]);
                                        }, 3000);	
				}	
			});
	   	});
            $scope.isMobileDevice = false;
        function showMapBox(hoteles) {
            let canvas = document.createElement("canvas");
            let gl = canvas.getContext("webgl");
            if (hoteles && gl != null) {
                let GPS = $scope.hoteles[0].GPS;
                let GPSJSON = JSON.parse("[" + GPS + "]");
                moveArray(GPSJSON, 1, 0);
                mapboxgl.accessToken = 'pk.eyJ1IjoiaWxhY29zdGEiLCJhIjoiY2o5cGVnNXBzNWt5MDMzcXFldXZsMndpZSJ9.oRZQbW2R_5tZ7o6C_GCAEg';
                var map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/ilacosta/cjmvxk5np48h12sl7w8aqwfgo',
                    zoom: 15,
                    center: GPSJSON
                });
                map.on("load", function () {
                    /* Aqui se añade la imagen */
                    map.loadImage("/fcs_images/riu2017/marker-single.png", function(error, image) {
                        if (error) throw error;
                        map.addImage("custom-marker", image);
                        /* Estilo del Layer: relaciona el layer con la datasource */
                        map.addLayer({
                            id: "markers",
                            type: "symbol",
                            /* DataSource de donde se pone el marker */
                            source: {
                                type: "geojson",
                                data: {
                                    type: "FeatureCollection",
                                    features:[{
                                        "type":"Feature",
                                        "properties": {
                                          "description": "Riu Hotels" +
                                              "",
                                        },
                                        "geometry":{
                                            "type":"Point",
                                            "coordinates": GPSJSON}}]}
                            },
                            layout: {
                                "icon-image": "custom-marker",
                            }
                        });
                    });
                })
                // PopUp Section
                if ($scope.hoteles[0].precio != undefined) {
                    var popup = new mapboxgl.Popup({ offset: [0, -23] })
                        .setHTML(
                            '<div class="info-hotel">'+
                       '<div class="info-hotel_image">'+
                         '<img src="' + hotels.features[0].properties.img + '">'+
                       '</div>'+
                       '<div class="info-hotel_content">'+
                         '<h4 class="hotel-name"> ' + hotels.features[0].properties.nombre + ' </h4>'+
                         '<div class="hotel-extra-info">'+
                           '<p> ' + hotels.features[0].properties.direccion + '</p>'+
                           '<p> ' + hotels.features[0].properties.telf + '</p>'+
                         '</div>'+
                       '</div>'+
                     '</div>'
                        );
                } else {
                    var popup = new mapboxgl.Popup({ offset: [0, -23] })
                        .setHTML(
                            '<div class="info-hotel">'+
                       '<div class="info-hotel_image">'+
                         '<img src="' + hotels.features[0].properties.img + '">'+
                       '</div>'+
                       '<div class="info-hotel_content">'+
                         '<h4 class="hotel-name"> ' + hotels.features[0].properties.nombre + ' </h4>'+
                         '<div class="hotel-extra-info">'+
                           '<p> ' + hotels.features[0].properties.direccion + '</p>'+
                           '<p> ' + hotels.features[0].properties.telf + '</p>'+
                         '</div>'+
                       '</div>'+
                     '</div>'
                        );
                }
                var element = document.createElement('div');
                element.id = 'marker';
                var lngLat = GPSJSON;
                new mapboxgl.Marker(element)
                    .setLngLat(lngLat)
                    .setPopup(popup) // sets a popup on this marker
                    .addTo(map);
                // Configs
                map.scrollZoom.disable();
                map.addControl(new mapboxgl.NavigationControl());
            } else {
                $.getScript(constantes.serverS + '/' +constantes.idioma  + "/_JS/riu2017/jquery-jvectormap-world-mill.js").then(function() {
                    generarVectorMap();
                    console.log("Your browser does not support WEBGL2");
                });
            }
        };
        function showMapboxAll(hoteles) {
            if (!('remove' in Element.prototype)) {
                Element.prototype.remove = function () {
                    if (this.parentNode) {
                        this.parentNode.removeChild(this);
                    }
                };
            }
var listaEtiquetasBusqueda = 'RIU2017.mapa.ir-hotel';
        riuService.getEtiquetas(listaEtiquetasBusqueda).then(function(d){
            $scope.etiquetas = d;
        });
            let GPS = $scope.hoteles[0].GPS;
            let GPSJSON = JSON.parse("[" + GPS + "]");
            moveArray(GPSJSON, 1, 0);
            if ($scope.hoteles.length > 20) {
                mapboxgl.accessToken = 'pk.eyJ1IjoiaWxhY29zdGEiLCJhIjoiY2o5cGVnNXBzNWt5MDMzcXFldXZsMndpZSJ9.oRZQbW2R_5tZ7o6C_GCAEg';
                var map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/ilacosta/cjmvxk5np48h12sl7w8aqwfgo',
                    center: GPSJSON,
                    center: [-4.925907, 23.617589],
                    zoom: 1.25,
                    scrollZoom: false
                });
            } else {
                mapboxgl.accessToken = 'pk.eyJ1IjoiaWxhY29zdGEiLCJhIjoiY2o5cGVnNXBzNWt5MDMzcXFldXZsMndpZSJ9.oRZQbW2R_5tZ7o6C_GCAEg';
                var map = new mapboxgl.Map({
                    container: 'map',
                    style: 'mapbox://styles/ilacosta/cjmvxk5np48h12sl7w8aqwfgo',
                    center: GPSJSON,
                    zoom: 11,
                    scrollZoom: false
                });
            }
            // Mapa de calor
            map.on('load', function () {
                map.addSource("hotels", {
                    type: "geojson",
                    data: hotels,
                    cluster: true,
                    clusterMaxZoom: 18,
                    clusterRadius: 50
                });
                map.addLayer({
                    id: "clusters",
                    type: "circle",
                    source: "hotels",
                    filter: ["has", "point_count"],
                    paint: {
                        "circle-color": [
                            "step",
                            ["get", "point_count"],
                            "#ff8a8a",
                            20,
                            "#de5a5a",
                            35,
                            "#ce2727"
                        ],
                        "circle-radius": [
                            "step",
                            ["get", "point_count"],
                            20,
                            20,
                            25,
                            35,
                            35
                        ]
                    }
                });
                map.addLayer({
                    id: "cluster-count",
                    type: "symbol",
                    source: "hotels",
                    filter: ["has", "point_count"],
                    layout: {
                        "text-field": "{point_count_abbreviated}",
                        "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
                        "text-size": 12
                    }
                });
                map.loadImage("/fcs_images/riu2017/marker-single.png", function(error, image) {
                    if (error) throw error;
                    map.addImage("custom-marker", image);
                    /* Estilo del Layer: relaciona el layer con la datasource */
                    map.addLayer({
                        id: "unclustered-point",
                        type: "symbol",
                        source: "hotels",
                        filter: ["!", ["has", "point_count"]],
                        layout: {
                            "icon-image": "custom-marker",
                        }
                    });
                });
                // inspect a cluster on click
                map.on('click', 'clusters', function (e) {
                    var features = map.queryRenderedFeatures(e.point, {layers: ['clusters']});
                    var clusterId = features[0].properties.cluster_id;
                    map.getSource('hotels').getClusterExpansionZoom(clusterId, function (err, zoom) {
                        if (err)
                            return;
                        map.easeTo({
                            center: features[0].geometry.coordinates,
                            zoom: zoom
                        });
                    });
                });
                map.on('mouseenter', 'clusters', function () {
                    map.getCanvas().style.cursor = 'pointer';
                });
                map.on('mouseleave', 'clusters', function () {
                    map.getCanvas().style.cursor = '';
                });
            });
            // Fin mapa de calor
            // Eventos y Pop Ups
var preciosChecked = {}
            map.on('click', function(e) {
                var features = map.queryRenderedFeatures(e.point, {
                    layers: ['unclustered-point'] // replace this with the name of the layer
                });
                if (!features.length) {
                    return;
                }
                var feature = features[0];
               if (feature.properties.id in preciosChecked == false) {
                  /* riuService.getPrecioDesdePorHotel(feature.properties.id).then(function (d) {
                    if (!jQuery.isEmptyObject(d) && d != undefined) {
                        preciosChecked[feature.properties.id] = d;
                        var popup = new mapboxgl.Popup({offset: [0, -23]})
                            .setHTML(
                                '<div class="info-hotel">'+
                         '<div class="info-hotel_image">'+
                           '<img src="' + feature.properties.img + '">'+
                         '</div>'+
                         '<div class="info-hotel_content">'+
                           '<h4 class="hotel-name"> ' + feature.properties.nombre + ' </h4>'+
                           '<div class="hotel-extra-info">'+
                             '<p> ' + feature.properties.direccion + '</p>'+
                             '<p> ' + feature.properties.telf + '</p>'+
                             '<label><span class="desde">' + $scope.etiquetas["caja_ofertas.desde"] + '</span> <span class="price">' + " " + parseFloat(d["precioDesde"].importe).toFixed(2) + d.precioDesde.moneda + '</span>' + " " + $scope.etiquetas["caja_ofertas.persona_por_noche"] + '</label>'+
                             '<a href="' + feature.properties.url + '">' + $scope.etiquetas["RIU2017.mapa.ir-hotel"] + '</a>'+
                           '</div>'+
                         '</div>'+
                       '</div>'
                            )
                            .setLngLat(feature.geometry.coordinates)
                            .addTo(map);
                    } else {*/
                        var popup = new mapboxgl.Popup({offset: [0, -23]})
                            .setHTML(
                               '<div class="info-hotel">'+
                         '<div class="info-hotel_image">' +
                           '<img src="' + feature.properties.img + '">'+
                         '</div>' +
                         '<div class="info-hotel_content">'+
                          ' <h4 class="hotel-name">'  + feature.properties.nombre + ' </h4>'+
                           '<div class="hotel-extra-info">'+
                             '<p> ' + feature.properties.direccion + '</p>'+
                             '<p> ' + feature.properties.telf + '</p>'+
                             '<a href="' + feature.properties.url + '">' + $scope.etiquetas["RIU2017.mapa.ir-hotel"] + '</a>'+
                           '</div>'+
                         '</div>'+
                       '</div>`'
                            )
                            .setLngLat(feature.geometry.coordinates)
                            .addTo(map);
                    //}
                    map.flyTo({
                        center: feature.geometry.coordinates
                    });
               // })
            } else  if (preciosChecked[feature.properties.id].importe && feature.properties.id in preciosChecked){
                var popup = new mapboxgl.Popup({offset: [0, -23]})
                    .setHTML(
                        '<div class="info-hotel">'+
                         '<div class="info-hotel_image">'+
                           '<img src="'+ feature.properties.img + '">'+
                        ' </div>'+
                        ' <div class="info-hotel_content">'+
                           '<h4 class="hotel-name">  '+ feature.properties.nombre + ' </h4>'+
                           '<div class="hotel-extra-info">'+
                             '<p>' + feature.properties.direccion + '</p>'+
                             '<p>' + feature.properties.telf + '</p>'+
                             '<label><span class="desde">' + $scope.etiquetas["caja_ofertas.desde"] + '</span> <span class="price">' + " " +
                        parseFloat(preciosChecked[feature.properties.id].precioDesde.importe).toFixed(2)
                        + preciosChecked[feature.properties.id].precioDesde.moneda + '</span>'
                        + " " + $scope.etiquetas["caja_ofertas.persona_por_noche"] + '</label>'+
                             '<a href="' + feature.properties.url + '">' + $scope.etiquetas["RIU2017.mapa.ir-hotel"] + '</a>'+
                           '</div>'+
                         '</div>'+
                       '</div>'
                    )
                    .setLngLat(feature.geometry.coordinates)
                    .addTo(map);
            } else {
                var popup = new mapboxgl.Popup({offset: [0, -23]})
                    .setHTML(
                        '<div class="info-hotel">'+
                         '<div class="info-hotel_image">' +
                           '<img src="' + feature.properties.img + '">'+
                         '</div>' +
                         '<div class="info-hotel_content">'+
                          ' <h4 class="hotel-name">'  + feature.properties.nombre + ' </h4>'+
                           '<div class="hotel-extra-info">'+
                             '<p> ' + feature.properties.direccion + '</p>'+
                             '<p> ' + feature.properties.telf + '</p>'+
                             '<a href="' + feature.properties.url + '">' + $scope.etiquetas["RIU2017.mapa.ir-hotel"] + '</a>'+
                           '</div>'+
                         '</div>'+
                       '</div>`'
                    )
                    .setLngLat(feature.geometry.coordinates)
                    .addTo(map);
            }
                map.flyTo({center: feature.geometry.coordinates
                });
            });
            // Utilities
            function flyToHotels(currentFeature) {
                map.flyTo({
                    center: currentFeature.geometry.coordinates
                });
            }
            // Configs
            map.scrollZoom.disable();
            map.addControl(new mapboxgl.NavigationControl());
            // Center the map on the coordinates of any clicked symbol from the 'symbols' layer.
            map.on('click', 'symbols', function (e) {
                map.flyTo({center: e.features[0].geometry.coordinates});
            });
        };
        function changeLayerVisibility(display) {
                var layers = document.getElementsByClassName("marker");
                for (var i = 0; i < layers.length; i++){
                    layers[i].style.display = display;
                }
            }
        function moveArray(arr, oldIndex, newIndex) {
            if (newIndex >= arr.length) {
                var k = newIndex - arr.length + 1;
                while (k--) {
                    arr.push(undefined);
                }
            }
            arr.splice(newIndex, 0, arr.splice(oldIndex, 1)[0]);
        };
        var hotels = {"type" : "FeatureCollection",
            "features" : []};
        function createGeoJson(hoteles) {
            for (var i = 0; i < hoteles.length;i++ ) {
                let GPSJSON = JSON.parse("[" + hoteles[i].GPS + "]");
                moveArray(GPSJSON, 1, 0);
                hotels["features"].push({
                    "type" : "Feature",
                    "geometry" : {
                        "type" : "Point",
                        "coordinates" : GPSJSON
                    },
                    "properties" : {
                        "nombre" : hoteles[i].NOMBRE,
                        "telf": hoteles[i].TELEFONO,
                        "direccion": hoteles[i].CALLE,
                        "ciudad": hoteles[i].POBLACION,
                        "codigoPostal": hoteles[i].CP,
                        "img": hoteles[i].IMG,
                        "pais": hoteles[i].pais,
                        "url": hoteles[i].URL_HOTEL
                    }
                });
            }
        }
        generarVectorMap = function(){
            $scope.jVector = true;
            let GPS = $scope.hoteles[0].GPS;
            let GPSJSON = JSON.parse("[" + GPS + "]");
            let markers = [{latLng: GPSJSON, name: $scope.hoteles[0].NOMBRE, id : $scope.hoteles[0].ID_RUMBO}]
            $('#map').vectorMap({
                map: 'europe_mill',
                scaleColors: ['#C8EEFF', '#0071A4'],
                normalizeFunction: 'polynomial',
                zoomOnScroll: false,
                zoomMax: 10,
                hoverOpacity: 1,
                hoverColor: false,
                regionsSelectable: false,
                regionStyle : {
                    initial: {
                        fill: '#f3f1ed',
                        "fill-opacity": 1,
                        stroke: 'none',
                        "stroke-width": 0,
                        "stroke-opacity": 1
                    },
                    hover: {
                        "fill-opacity": .7,
                        cursor: 'default'
                    },
                },
                regionLabelStyle: {
                    initial: {
                        "fill-opacity": 0
                    },
                    hover: {
                        "fill-opacity": 0,
                    },
                },
                markerStyle: {
                    initial: {
                        fill: '#8A4043',
                        stroke: '#ca5c5c',
                        "stroke-width": 2,
                    },
                    hover: {
                        stroke: '#ffffff'
                    }
                },
                //backgroundColor: '#31333e',
                backgroundColor: 'transparent',
                markers: markers,
                onRegionLabelShow: function(e, el, code){
                    e.preventDefault();
                },
                onMarkerClick: function(event, index) {
                    $scope.showinfoHotel(markers[index].id);
                    // $scope.setFocusMapCenter(markers[index]);
                }
            }).ready(function() {
                $scope.setFocusMapCenter(markers[0]);
                // $scope.obtenerFotos(0);
            });
        }
        $('#close-box-info').click(function(){
            $('.box-info-hotel-location').toggleClass('open');
        });
        $scope.setFocusMapCenter = function(mark) {
            var mapObj = $('#map').vectorMap('get', 'mapObject'),
                center = mapObj.pointToLatLng(mapObj.width / 2, mapObj.height / 2);
            var config = {
                animate: true,
                lat: mark.latLng[0],
                lng: mark.latLng[1],
                scale: 4
            }
            mapObj.setFocus(config);
            if((parseFloat(center.lng)+3) < parseFloat(mark.latLng[1]) && ($rootScope.rootPais.ISO == 'ES' || $rootScope.rootPais.ID_REGION == 'EU'))
                $('.box-info-hotel-location').css('right', '70%').css('left', 'inherit').css('margin-left', '0px');
        }
        $scope.showinfoHotel = function(id) {
            // alert('La id del hotel seleccionado es '+id);
            // $('.box-info-hotel-location').addClass('open');
            if ( $('.box-info-hotel-location').hasClass( "open" ) ) {
                $('.box-info-hotel-location').removeClass('open');
            } else {
                $('.box-info-hotel-location').addClass('open');
            }
        };
        $timeout(function () {
            $scope.showModal;
        }, 3000);
        $timeout(function() {
            createGeoJson($scope.hoteles);
            if(document.getElementById("map") && $scope.hoteles.length == 1) {
                showMapBox($scope.hoteles);
            } else {
                showMapboxAll($scope.hoteles);
            }
          }, 3000);
	}


(function() {
    app.component("enlaceVerMapa", {
        template:  '<a href="" id="{{idBtnMap}}" ng-dialog="{{templateDetalle}}" ng-click="initialize()" ng-dialog-data="[{{hotel}},{{pais}},{{servicios}}]" '
            + 'ng-dialog-class="ngdialog-theme-default" ng-dialog-scope="$scope"'
            +'ng-dialog-show-close="false"class="btn btn-secondary btn-outline view-map">'
            +'<span ng-show="!tipoShowIcon">{{lblbtn}}</span>'
            +'<span ng-show="tipoShowIcon" class="icn-location">{{lblbtn}}</span>'
            +'</a>',
        bindings : { hotel : '@', pais : '@', servicios : '@', lblbtn : '@', tipo : '@', vermapa : '@'},
        controller: tempVerMapaController
    });
    tempVerMapaController.$inject = [ '$scope', 'constantes', '$rootScope'];
    function tempVerMapaController ($scope, constantes, $rootScope) {
        $scope.hotel = JSON.parse($scope.$ctrl.hotel);
        $scope.pais = $scope.$ctrl.pais?JSON.parse($scope.$ctrl.pais):'[]';
        $scope.servicios = $scope.$ctrl.servicios?JSON.parse($scope.$ctrl.servicios):'[]';
        $scope.lblbtn = $scope.$ctrl.lblbtn;
        $scope.tipoShowIcon = $scope.$ctrl.tipo;
        $scope.idBtnMap = "";
        if(!$rootScope.cargarMapa)
            $rootScope.cargarMapa = $scope.$ctrl.vermapa;
        $scope.templateDetalle = "/"+constantes.idioma+ constantes.templateFolder+"/cmp-fc-popup-mapa.jsp";
        if(document.getElementById('verMapCab')){
            $scope.idBtnMap = "idBtnMap";
            $('#verMapCab').on('click', function(e) {
                $('#idBtnMap').click();
            });
        }
    };
}());
app.controller('googleMapController', function ($scope, constantes, $rootScope,$q, $http) {
    $scope.getDatosJSON = function(url){
        var defer = $q.defer();
        $http.get(url, {withCredentials: true, headers: {"Content-Type": "application/json"} } )
            .success(function(data){ defer.resolve(data); })
            .error(function(data, status, headers, config){ defer.resolve(status); });
        return defer.promise;
    }
    $scope.getServiciosJSON = function(idHotel) {
        var url = constantes.serverS +  "/destinos-hoteles!temporada.action?idRumboHotel="+idHotel+"&formato=json&v=web2017&idioma="+constantes.idioma;
        var defer = $q.defer();
        $http.get(url, {withCredentials: true} )
            .success(function(data){ defer.resolve(data); })
            .error(function(data, status, headers, config){ defer.resolve(status); });
        return defer.promise;
    }
    $scope.btnAmpliarMapa = false;
    $scope.btnVerMapa = true;
    $scope.ampliarMapa = function(){
        if(!$scope.btnAmpliarMapa)
            $scope.btnAmpliarMapa = true;
        else
            $scope.btnAmpliarMapa = false;
        setTimeout(function(){google.maps.event.trigger($scope.map, 'resize');}, 500);
    }
    $scope.verMapa = function(){
        if(!$scope.btnVerMapa) {
            $scope.btnVerMapa = true;
            $scope.directionsDisplay.setMap(null);
        }
        else {
            $scope.btnVerMapa = false;
            $scope.directionsDisplay.setMap($scope.map);
            $scope.directionsDisplay.setPanel($("#directions2")[0]);
            $scope.trata();
        }
    }
    $scope.infoHot = $scope.ngDialogData[0];
    $scope.infoPai = $scope.ngDialogData[1];
    $scope.servHot = $scope.ngDialogData[2];
    if ($scope.servHot && $scope.servHot.SITUACION)
        $scope.infoHot.SITUACION = $scope.servHot.SITUACION;
    else{
        $q.all([ $scope.getServiciosJSON($scope.infoHot.ID) ] ).then(function(config) {
            $scope.servHot = config[0];
            $scope.infoHot.SITUACION = $scope.servHot.SITUACION;
        });
    }
    $scope.configMap = null;
    $scope.fMapIni = function (){
        $scope.swiMobile = false;
        if($scope.detectmob()) {
            $scope.swiMobile = true;
        }
        let GPS;
        let canvas = document.createElement("canvas");
        let gl = canvas.getContext("webgl");
        if ($scope.configMap == null){
            GPS = $scope.infoHot.GPS;
        } else {
            GPS = $scope.configMap.gpsHotel;
        }
        let GPSJSON = JSON.parse("[" + GPS + "]");
        moveArray(GPSJSON, 1, 0);
        if (gl != null) {
            mapboxgl.accessToken = 'pk.eyJ1IjoiaWxhY29zdGEiLCJhIjoiY2o5cGVnNXBzNWt5MDMzcXFldXZsMndpZSJ9.oRZQbW2R_5tZ7o6C_GCAEg';
            var map = new mapboxgl.Map({
                container: 'mapPopUp',
                style: 'mapbox://styles/ilacosta/cjmvxk5np48h12sl7w8aqwfgo',
                zoom: 15,
                center: GPSJSON
            });
            map.on("load", function () {
                /* Aqui se añade la imagen */
                map.loadImage("/fcs_images/riu2017/marker-single.png", function(error, image) {
                    if (error) throw error;
                    map.addImage("custom-marker", image);
                    /* Estilo del Layer: relaciona el layer con la datasource */
                    map.addLayer({
                        id: "markers",
                        type: "symbol",
                        /* DataSource de donde se pone el marker */
                        source: {
                            type: "geojson",
                            data: {
                                type: "FeatureCollection",
                                features:[{
                                    "type":"Feature",
                                    "properties": {
                                        "description": "Riu Hotels" +
                                            "",
                                    },
                                    "geometry":{
                                        "type":"Point",
                                        "coordinates": GPSJSON}}]}
                        },
                        layout: {
                            "icon-image": "custom-marker",
                        }
                    });
                });
                var mapaFull = false;
                $('#resizeMap').click(function () {
                    if (mapaFull == false) {
                        document.getElementById("info-mapa").style.display = "none";
                        map.resize();
                        mapaFull = true;
                    } else {
                        document.getElementById("info-mapa").style.display = "table-cell";
                        map.resize();
                        mapaFull = false;
                    }
                });
            })
            // PopUp Section
            if ($scope.hoteles[0].precio != undefined) {
                var popup = new mapboxgl.Popup({ offset: [0, -23] })
                    .setHTML(
                        '<div class="info-hotel">'+
                           '<div class="info-hotel_image">'+
                             '<img src="'+ $scope.infoHot.IMG + '">'+
                           '</div>'+
                           '<div class="info-hotel_content">'+
                             '<h4 class="hotel-name"> ' +  $scope.infoHot.NOMBRE + ' </h4>'+
                             '<div class="hotel-extra-info">'+
                               '<p> ' + $scope.infoHot.CALLE + '</p>'+
                               '<p> ' +  $scope.infoHot.TELEFONO + '</p>'+
                             '</div>'+
                           '</div>'+
                         '</div>'
                    );
            } else {
                var popup = new mapboxgl.Popup({ offset: [0, -23] })
                    .setHTML(
                         '<div class="info-hotel">'+
                           '<div class="info-hotel_image">'+
                             '<img src="'+ $scope.infoHot.IMG + '">'+
                           '</div>'+
                           '<div class="info-hotel_content">'+
                             '<h4 class="hotel-name"> ' +  $scope.infoHot.NOMBRE + ' </h4>'+
                             '<div class="hotel-extra-info">'+
                               '<p> ' + $scope.infoHot.CALLE + '</p>'+
                               '<p> ' +  $scope.infoHot.TELEFONO + '</p>'+
                             '</div>'+
                           '</div>'+
                         '</div>'
                    );
            }
            var element = document.createElement('div');
            element.id = 'marker';
            var lngLat = GPSJSON;
            new mapboxgl.Marker(element)
                .setLngLat(lngLat)
                .setPopup(popup) // sets a popup on this marker
                .addTo(map);
            // Configs
            if ($scope.detectmob()) {
                $("#mapPopUp").on('touchstart', function (e) {
                    if (e.originalEvent.touches.length > 1) {
                        map.dragPan.enable();
                    } else {
                        map.dragPan.disable();
                    }
                });
            }
            map.scrollZoom.disable();
            var nav = new mapboxgl.NavigationControl();
            map.addControl(nav, 'top-left');
        } else {
            $.getScript(constantes.serverS + '/' +constantes.idioma  + "/_JS/riu2017/jquery-jvectormap-europe-mill.js").then(function() {
                if ($(".jvectormap-container").length > 0) {
                    $("#resizeMap").hide();
                }
                $scope.generarVectorMapPopUp();
                console.log("Your browser does not support WEBGL2");
            });
        }
    }
    $scope.initialize = function(){
        if($rootScope.cargarMapa && $rootScope.cargarMapa == 'SI'){
            $rootScope.cargarMapa = 'NO';
            $.getScript(constantes.urlGMapKey).then(function() {
                $scope.getDatosJSON($scope.infoHot.URL_HOTEL.replace('index.jsp','') + 'infoMapa.json').then(function(d) {
                    $scope.configMap = d && d[0]?d[0]:null;
                    $scope.fMapIni();
                });
            });
        }else{
            $scope.getDatosJSON($scope.infoHot.URL_HOTEL.replace('index.jsp','') + 'infoMapa.json').then(function(d) {
                $scope.configMap = d && d[0]?d[0]:null;
                $scope.fMapIni();
            });
        }
    };
    $scope.initialize();
    $scope.detectmob = function(){
        if( navigator.userAgent.match(/Android/i)
            || navigator.userAgent.match(/webOS/i)
            || navigator.userAgent.match(/iPhone/i)
            || navigator.userAgent.match(/iPad/i)
            || navigator.userAgent.match(/iPod/i)
            || navigator.userAgent.match(/BlackBerry/i)
            || navigator.userAgent.match(/Windows Phone/i)
        ){
            return true;
        } else {
            return false;
        }
    }
    $scope.generarVectorMapPopUp = function(){
        let GPSJSON = JSON.parse("[" + $scope.infoHot.GPS + "]");
        let markers = [{latLng: GPSJSON, name: $scope.infoHot.NOMBRE, id : $scope.infoHot.ID_RUMBO}]
        $('#mapPopUp').vectorMap({
            map: 'europe_mill',
            scaleColors: ['#C8EEFF', '#0071A4'],
            normalizeFunction: 'polynomial',
            zoomOnScroll: false,
            zoomMax: 10,
            hoverOpacity: 1,
            hoverColor: false,
            regionsSelectable: false,
            regionStyle : {
                initial: {
                    fill: '#f3f1ed',
                    "fill-opacity": 1,
                    stroke: 'none',
                    "stroke-width": 0,
                    "stroke-opacity": 1
                },
                hover: {
                    "fill-opacity": .7,
                    cursor: 'default'
                },
            },
            regionLabelStyle: {
                initial: {
                    "fill-opacity": 0
                },
                hover: {
                    "fill-opacity": 0,
                },
            },
            markerStyle: {
                initial: {
                    fill: '#8A4043',
                    stroke: '#ca5c5c',
                    "stroke-width": 2,
                },
                hover: {
                    stroke: '#ffffff'
                }
            },
            //backgroundColor: '#31333e',
            backgroundColor: 'transparent',
            markers: markers,
            onRegionLabelShow: function(e, el, code){
                e.preventDefault();
            },
            onMarkerClick: function(event, index) {
                $scope.showinfoHotel(markers[index].id);
                $scope.setFocusMapCenter(markers[index]);
                // alter the weburl
            }
        }).ready(function() {
            $scope.setFocusMapCenter(markers[0]);
            // $scope.obtenerFotos(0);
        });
    }
    $scope.setFocusMapCenter = function(mark) {
        var mapObj = $('#mapPopUp').vectorMap('get', 'mapObject'),
            center = mapObj.pointToLatLng(mapObj.width / 2, mapObj.height / 2);
        var config = {
            animate: true,
            lat: mark.latLng[0],
            lng: mark.latLng[1],
            scale: 4
        }
        mapObj.setFocus(config);
    }
    $scope.showinfoHotel = function() {};
});
function moveArray(arr, oldIndex, newIndex) {
    if (newIndex >= arr.length) {
        var k = newIndex - arr.length + 1;
        while (k--) {
            arr.push(undefined);
        }
    }
    arr.splice(newIndex, 0, arr.splice(oldIndex, 1)[0]);
};


(function() {
    'use strict';
	app.component("hotelIconServices", {
		templateUrl: 	function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder + "/cmp-icon-services.jsp?request.aspect=desk"; },
		bindings: { idrumbo : '@', clase : '@', showkeyselling : '@' },
		controller: ctrlHotelIconServices
	});
	ctrlHotelIconServices.$inject = ['$filter', '$scope', '$rootScope', '$sce', '$q', 'riuService', 'constantes'];
	function ctrlHotelIconServices($filter, $scope, $rootScope, $sce, $q, riuService, constantes) {
		riuService.getDestinosHoteles().then(function(data) {
			$scope.paises = data;
                        $scope.numKeySelling = 0;
			angular.forEach($scope.paises.PAIS, function(pais){
				angular.forEach(pais.DESTINO, function(destino){
					angular.forEach(destino.HOTEL, function(hotel){
						if (hotel.ID_RUMBO === $scope.$ctrl.idrumbo) {
							$scope.is24h = $filter('is24h')( hotel);
							$scope.isAI = $filter('isAI')( hotel) && !$scope.is24h;
							$scope.isAO = $filter('isAO')( hotel);
							$scope.isWifiFree = $filter('isWifiFree')( hotel );
							$scope.isPoolParty = $filter('isPoolParty')( hotel );
							$scope.isWifi = $filter('isWifi')( hotel) && !$scope.isWifiFree;
							$scope.isFun4All = $filter('isFun4All')(hotel);
							$scope.infoHotel = true;
                                                        if (hotel.CIUDAD=='Si' && $scope.$ctrl.showkeyselling) {
								$scope.hotel = hotel;
								$scope.numKeySelling = 3 - _.sumBy([$scope.is24h, $scope.isAI, $scope.isAO, $scope.isWifiFree, $scope.isWifi, $scope.isPoolParty], function(o) { return o; });
							}
						}
					});
				});
			});
		});
	}
})();


(function() {
    'use strict';
	app.component("sideNotification", {
		templateUrl: 	function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder + "/cmp-side-notification.jsp"; },
		bindings : 		{ idhotel : '@', iddestino : '@' },
		controller: 	ctrlSideNotification
	});
	ctrlSideNotification.$inject = ['$scope', '$rootScope', 'constantes', '$timeout', '$q', '$http', '$controller', 'riuService'];
	function ctrlSideNotification($scope, $rootScope, constantes, $timeout, $q, $http, $controller, riuService) {
		angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
		$scope.modulo = this;
		$scope.notificationClosed = true;
		$scope.description = "";
		$scope.incluirReservas = true;
                $scope.iconoReserva = true;
                $scope.showReservar = false;
		$scope.esHotel = angular.isDefined($scope.$ctrl.idhotel);
		$scope.esDestino = angular.isDefined($scope.$ctrl.iddestino)&&(!$scope.esHotel);
		$scope.id = $scope.$ctrl.idhotel;
                $scope.etiquetaHotel = null;
		$scope.imageNotification = false;
		$scope.srcImage = '';
		$scope.hrefImage = '';
                $scope.sizeMobile = $(window).width() < 768 ? true : false;
		if ($scope.esDestino) {
			$scope.$ctrl.tipo = "SEC-destino-rsv";
			$scope.id = $scope.$ctrl.iddestino;
		}
		if($scope.esHotel) $scope.$ctrl.tipo = "SEC-hotel-rsv";
		var etiquetaBusqueda = "RIU2017.side-notification." + $scope.id + ",RIU2017.side-notification." + $scope.id + ".image-content" + ",RIU2017.side-notification." + $scope.id + ".custom-message";
		$scope.closeNotification = function() {
			$scope.notificationClosed = true;
		}
		$scope.openCalendar = function() {
                       if($scope.sizeMobile) {
				angular.element('#busc-movil-modal').modal('toggle');
			}
			else {
				$timeout(function() { // $timeout fuerza un $apply al ciclo
	                              angular.element('#divCalendario1').trigger('click');
	                        }, 100);
			}
			$scope.notificationClosed = true;
                 }
        $scope.manageNotification = function(data) { // solo mostrará la notificación para mas de 1 visitantes en el momento actual o 1 reservas en las últimas X horas
			if(data.hits > 1){
				$scope.description = data.desc;
				$scope.notificationClosed = false;
			}
        }
        function getNotificationData (id,tipo,reservas) {
			if(reservas){
				if($scope.$ctrl.tipo == "SEC-destino-rsv"){
					var url = constantes.serverS + "/json-utils!ghcb.action?formato=json&params.i="+id+"&idioma="+constantes.idioma+"&params.t="+tipo+"&params.md=formatted&params.ett=v2.incentivo-compra.texto-reservas-hechas-destino&params.eth=v2.incentivo-compra.intervalo-horas-reservas";
				}
				else {
					var url = constantes.serverS + "/json-utils!ghcb.action?formato=json&params.i="+id+"&idioma="+constantes.idioma+"&params.t="+tipo+"&params.md=formatted&params.ett=v2.incentivo-compra.texto-reservas-hechas&params.eth=v2.incentivo-compra.intervalo-horas-reservas";
				}
			}
			else {
                                $scope.iconoReserva = false;
				if($scope.$ctrl.tipo == "destino"){
					var url = constantes.serverS + "/json-utils!ghcb.action?formato=json&params.i="+id+"&idioma="+constantes.idioma+"&params.t="+tipo+"&params.md=formatted&params.ett=v2.incentivo-compra.texto-personas-viendo-destino&params.etm=v2.incentivo-compra.intervalo-minutos-personas-viendo";
				}
				else {
					var url = constantes.serverS + "/json-utils!ghcb.action?formato=json&params.i="+id+"&idioma="+constantes.idioma+"&params.t="+tipo+"&params.md=formatted";
				}
			}
			var defer = $q.defer();
			$http.get(url, {withCredentials: true}).success(function(data)
			    {
			    defer.resolve(data);
			    	}).error(function(data, status, headers, config)
			    {
			    });
			return defer.promise;
		}
		riuService.getEtiquetas(etiquetaBusqueda).then(function(data){
			for (var key in data) {
			   if (key.contains('image-content') || key.contains('custom-message')) {
			   		if (key.contains('image-content')) {
			   			$scope.etiquetaSideImage = data[key];
			   		}
			   		if (key.contains('custom-message')) {
				   		$scope.etiquetaCustomMessage = data[key];
			   		}
			   }else {
			   		$scope.etiquetaHotel = data[key];
			   }
			}
			$timeout(function() {
                                if($scope.etiquetaSideImage && $scope.etiquetaSideImage.split('')[1] !== '?'&& !$scope.sizeMobile) {
					$scope.sideImageContent = $scope.etiquetaSideImage;
					$scope.srcImage = $scope.sideImageContent.split(' | ')[0];
					$scope.hrefImage = $scope.sideImageContent.split(' | ')[1];
					$scope.imageNotification = true;
					$scope.iconoReserva = false;
					$scope.description = '';
					$scope.showReservar = false;
					$scope.notificationClosed = false;
				}
				else if($scope.etiquetaCustomMessage && $scope.etiquetaCustomMessage.split('')[1] !== '?'&& !$scope.sizeMobile) {
					$scope.customMessageContent = $scope.etiquetaCustomMessage;
					$scope.description = $scope.customMessageContent.split(' | ')[0];
					$scope.hrefUrl = $scope.customMessageContent.split(' | ')[1];
					$scope.imageNotification = false;
					$scope.customNotification = true;
					$scope.iconoReserva = false;
					$scope.showReservar = false;
					$scope.notificationClosed = false;
				}
				else {
					$scope.showReservar = ($scope.esHotel && ($rootScope.rootHotel.RESERVAS!='No') ) || ($scope.esDestino && ($rootScope.rootDestino.RESERVAS!='No'));
				        if($scope.etiquetaHotel.split('')[0] && $scope.etiquetaHotel.split('')[1] !== '?') {
					       $scope.description = '<strong>' + $scope.etiquetaHotel + '</strong>';
					       $scope.notificationClosed = false;
				         }
				         else {
					        if($scope.incluirReservas) {
						        getNotificationData($scope.id, $scope.$ctrl.tipo, true).then(function(data) {
							        if(data.hits > 2){
								       $scope.manageNotification(data); // pinta las reservas
							        }
							        else {
								       // aunque configuremos "incluir reservas" pinta notificación con visitas para los casos en los que haya menos de 3 reservas
								       if($scope.esHotel) $scope.$ctrl.tipo = "hotel";
								       if($scope.esDestino) $scope.$ctrl.tipo = "destino";
								       getNotificationData($scope.id, $scope.$ctrl.tipo).then(function(data) {
									     $scope.manageNotification(data);
								       });
							       }
						        });
					        }
				                else {
				    	              if($scope.esHotel) $scope.$ctrl.tipo = "hotel";
				    	              if($scope.esDestino) $scope.$ctrl.tipo = "destino";
				    	              getNotificationData($scope.id, $scope.$ctrl.tipo).then(function(data) {
							     if(data.hits > 2){
								    $scope.manageNotification(data);
							     }
						      });
				                }
				         }
                                 }
			}, 5000);
		});
	}
})();	


(function() {
    'use strict';
	app.component("rewardsSw", {
		templateUrl: 	function(constantes) { return "/"+constantes.idioma+ constantes.templateFolder + "/cmp-rewards-stay-wanderful.jsp"; },
		controller: 	ctrlRewardsSW
	});
	ctrlRewardsSW.$inject = ['$scope', 'constantes', '$controller'];
	function ctrlRewardsSW( $scope, constantes, $controller) {
		angular.extend(this, $controller('ctrlModulo', {$scope: $scope}));
		$scope.modulo = this;
		$scope.frontInfo = true;
		$scope.showFrontInfo = function () {
			$scope.frontInfo = !$scope.frontInfo;
		}
	}
})();	


(function() {
	'use strict'
	app.component("condicionesOfertas", {
		templateUrl: function(constantes) { return "/"+constantes.idioma+constantes.templateFolder+"/cmp-condiciones-ofertas.jsp?request.aspect=desk"; },
		bindings : { geoip:'@'},
		controller: ctrlCondicionesOfertas
	});
	ctrlCondicionesOfertas.$inject = ['$scope', 'riuService', 'ngDialog'];
	function ctrlCondicionesOfertas($scope, riuService, ngDialog) {
		$scope.showInfo = function(){
			ngDialog.open({	template: 'popupcondiciones', scope: $scope, className: 'ngdialog-theme-default' });
		}
	}
}());


