	app.controller("ctrlReservas", ["$scope", "$http", "$window", "riuClassSession", "riuService", "$rootScope", ctrlReservas])
	app.controller("ctrlPopupLoginRC", ["$scope", "$http", "constantes", "riuclassService", "$rootScope", "$window", "ngDialog", "$location", ctrlPopupLoginRC])
app.directive('onLast', function() {
	return function(scope, element, attrs) {
		if (scope.$last){
			scope.cargando = false;			
			$('#load_screen').remove();
			console.log('Entra en el onlast');
		} ;
	};
});
app.directive('toggle', function(){
  return {
    restrict: 'A',
    link: function(scope, element, attrs){
      if (attrs.toggle=="tooltip"){
        $(element).tooltip();
      }
      if (attrs.toggle=="popover"){
        $(element).popover();
      }
    }
  };
})
app.factory('riuclassService',function($q, $http , ngDialog, constantes, riuService, $window, $location, $rootScope, localStorageService) {
		return {
				setLogoutRC: function() {
					var urlLogin = riuService.getServer() + "/logout.jsp";
					var defer = $q.defer();
					$http.get(urlLogin, {
						withCredentials: true
					}).success(function(data) {
						if (localStorageService.isSupported) {
							localStorageService.remove('pu');
							//sessionStorage.removeItem('pu');
						}
						defer.resolve(data);
					}).error(function(data, status, headers, config) {
					});
					return defer.promise;
				},
				showPoliticaPrivacidad : function() {
					var url = constantes.idioma + "/json/politicas_privacidad_rc.json";
					var servicio = constantes.serverS + "/json-utils!getUrl.action?formato=json&v=web2017&params.url=/" + url;
					$http.get(servicio, {
						withCredentials: true
					}).success(function(json) {
						ngDialog.open({
								template: '<div class="condiciones-cancelacion-wrap"><h3 ng-bind="ngDialogData.msg.titulo"></h3><div class="condiciones-cancelacion"><p ng-bind-html="ngDialogData.msg.descripcion"></p></div></div>',
								plain : true,
								data: {msg : json}
						});
					}).error(function(data, status, headers, config) {
					});
				},
				setLoginRC: function(usr, psw) {
					var defer = $q.defer();
					var m = this.showLoadingMsg("loading...");		 
					var transform = function(data){
						return $.param(data);
					}			 
					var urlLogin = constantes.serverS + "/login.jsp";
					$http.post( urlLogin, {v: "web", 
							 idioma: constantes.idioma, 
							 metodo: "json",
							 j_username: usr,
							 j_password: psw},
							{withCredentials: true, headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'} ,
							transformRequest: transform
							,transformResponse: function (data, headersGetter) {
								var res = data;
								try {
									console.info('transformResponse');
									res = JSON.parse(data)
								}
								catch (ex) {
								}
								return res
							}
							})
						.success(function(data)
						{
							defer.resolve(data);
							m.close();
						})
						.error(function(data, status, headers, config) 
						{
							m.close();
						});
					return defer.promise;
				},
				isSessionRC : function() {
					if ($window.session != null ){
						if (!$window.session) {
							this.showPopupLogin($location.absUrl());
						}
						else {
							return true;
						}
					} else {
						this.showPopupLogin($location.absUrl());
					}
					return false;
				},
		     	getEtiquetas : function(listaEtiquetasBusqueda) {
						var url = constantes.serverS +"/json-utils!getEtiqueta.action?formato=json&v=web&tipo=mapa&listEtiquetas="
								+ listaEtiquetasBusqueda;
						var defer = $q.defer();
						$http.get(url).success(function(data) {
							defer.resolve(data);
						}).error(function(data, status, headers, config) {
						});
						return defer.promise;
		        },
				showInfoMsg : function(msg, func) {
					return ngDialog.open({ 
							template: '<div class="alert alert-info " role="alert"><div ng-bind="msg"></div><div ng-bind-html="ngDialogData.msg"></div></div>', 
							plain: true,
							data: {msg : msg},
							preCloseCallback: function(value) {
								func();
							}
					});
				},
				showSuccess : function(msg, func) {
					return ngDialog.open({ 
							template: '<div class="alert alert-success " role="alert"><div ng-bind="msg"></div><div ng-bind-html="ngDialogData.msg"></div></div>', 
							plain: true,
							data: {msg : msg},
							preCloseCallback: function(value) {
								func();
							}
					});
				},
			   	showLoadingMsg : function(msg) {
					return ngDialog.open({ 
							template: '<div class="spinner" ><div class="rect1"></div> <div class="rect2"></div> <div class="rect3"></div> <div class="rect4"></div> <div class="rect5"></div> </div>',
						    showClose: false,
							closeByDocument: false,
							closeByEscape: false,
							plain: true,
							className: 'ngdialog-theme-loading',
							data: {msg : msg}
					});
				},
			   	showMsgDatosIncompletos : function(url, evitarReload) {
			   		var url2 = this.urlMisDatos();
					this.getEtiquetas( 'v2.altaRapida.msgAviso,consultas.modificar_datos' ).then(function(etiquetas) {		   		
			   			return ngDialog.open({ 
				   				template: '<div class="alert" role="alert"><div><p>'+etiquetas['v2.altaRapida.msgAviso']+'</p></div><div class="col-12"><button  class="btn-cta btn-primary btn-lg pull-right"><a href="'+ url2 +'" style="color: white">'+etiquetas['consultas.modificar_datos']+'</a></button></div></div>', 
								plain: true,
								preCloseCallback: function(value) {
									if(!evitarReload){
										$rootScope.$broadcast("ReloadSession", {
						                			reload: true, url : url
										});	
								}
							}
						});
					});
				},
			   	validaDatosIncompletos : function( user, functionClose ) {
			   		var url2 = this.urlMisDatos();
			   		if (user.callBack)
			   			url2 = url2 + '&callBack=' + user.callBack;
			   		if(user.codEstadoDir	&& (user.codEstadoDir == 'E' || user.codEstadoDir == 'I' || user.codEstadoDir == 'P')){
						this.getEtiquetas( 'v2.altaRapida.msgAviso,consultas.modificar_datos,alta-expres.validar,alta-expres.seguir-navegando' ).then(function(etiquetas) {		   		
			   				ngDialog.open({ 
				   				template: '<div class="alert" role="alert"><div><p>'+etiquetas['v2.altaRapida.msgAviso']+'</p></div><div class="col-12"><button  class="btn btn-primary btn-lg pull-right"><a href="'+ url2 +'" style="color: white">'+etiquetas['alta-expres.validar']+'</a></button></div><div class="col-12"><button  class="btn btn-secondary btn-lg pull-right" ng-click="closeThisDialog(0)"><a style="color: white">'+etiquetas['alta-expres.seguir-navegando']+'</a></button></div></div>', 
								plain: true,
								preCloseCallback: function(value) {
									functionClose();
								}
							});
							return false;
						});
			   		}
					else {
						functionClose();
						return true;
					}
				},
				showPopupLogin : function(url, ambito) {
					//$rootScope.FormUsr.url = url;
					console.info(url);
					ngDialog.open({ template: '/'+constantes.idioma+'/'+ constantes.publicFolder +'/templates/tmp-popup-login.jsp', 
									data: {url : url},
									className: 'ngdialog-theme-default ngdialog-theme-login login-rc',
									//controller:"ctrlPopupLoginRC",
									preCloseCallback: function(value) {
										/** si no se defini� el ambito se tratar� como si fuese privado 
										 * Valores: Privado = private; Publico = public*/
										if(!ambito || ambito == 'private')
											riuService.sendHomeRedirect();
									}
					});
				},
				setSolicitarDuplicadoTarjeta: function(escapedData) {
					//var url = constantes.serverS + "/riuclass-utils!asignarVisitaACuenta.action?formato=json&inputJSON="+escapedData;
					var url = constantes.serverS + "/riuclass-utils!solicitarDuplicadoTarjeta.action";
					var defer = $q.defer();
					var m = this.showLoadingMsg("loading...");
					console.log(escapedData);
					$http.post(url, escapedData, {withCredentials: true, headers: { 'Content-Type': 'application/x-www-form-urlencoded;'} }).success(function(data)
					{
						defer.resolve(data);
						m.close();
			    	}).error(function(data, status, headers, config) 
					{
						m.close();
					});
					return defer.promise;
			    },
				setTransferirPtosRc: function(escapedData) {
					var url = constantes.serverS + "/riuclass-utils!transferirPtosRc.action?formato=json&inputJSON="+escapedData;
					var url = constantes.serverS + "/riuclass-utils!transferirPtosRc.action";
					var defer = $q.defer();
					var m = this.showLoadingMsg("loading...");
					console.log(m);
					$http.post(url, escapedData, {withCredentials: true, headers: { 'Content-Type': 'application/x-www-form-urlencoded;'} }).success(function(data)
					{
						defer.resolve(data);
						m.close();
			    	}).error(function(data, status, headers, config) 
					{
						m.close();
					});
					return defer.promise;
			    },	 
				getSolicitarDuplicadoTarjeta: function() {
					var url = constantes.serverS + "/riuclass-utils!showSolicitarDuplicadoTarjeta.action?formato=json&v=web&idioma="+constantes.idioma+"&request.aspect=desk";
					var defer = $q.defer();
					$http.get(url, {withCredentials: true}).success(function(data)
					{
							defer.resolve(data);
			    	}).error(function(data, status, headers, config) 
					{
					});
					return defer.promise;
			    },
				getRedirectParams : function(params, tag) {
					if(!angular.isUndefined(params) && params != "") {
						params = tag + params;
					} else params = "";
					return params;
				},
				getPrivatePath : function() {
					return constantes.serverS + "/" + constantes.idioma +'/'+ constantes.publicFolder + '/' + constantes.privateFolder;
				},
				getPublicPath : function() {
					return constantes.serverS + "/" + constantes.idioma +'/'+ constantes.publicFolder;
				},
				sendHomeRedirectRC: function() {
					window.location.href = constantes.serverS + "/" + constantes.idioma + "/" + constantes.publicFolder + "/index.jsp";	
				},		
				sendReservasRedirectRC: function(params) {
					window.location.href =  this.getPrivatePath() + "/mis-reservas/index.jsp" + this.getRedirectParams(params,"?");	
				},
				sendMisPuntosRedirectRC: function(params) {
					window.location.href = this.getPrivatePath()  + "/mis-puntos/index.jsp" + this.getRedirectParams(params,"?");	
				},
				getMisPuntosURL: function(params) {
					return this.getPrivatePath()  + "/mis-puntos/index.jsp" + this.getRedirectParams(params,"?");	
				},				
				sendExtractoRedirectRC: function(params) {
					window.location.href = this.getPrivatePath() + "/mis-puntos/index.jsp?tab=extracto" + this.getRedirectParams(params,"&");	
				},
				sendConsultasRedirectRC: function(params) {
					window.location.href = this.getPrivatePath() + "/mis-consultas/index.jsp?tab=consultas" + this.getRedirectParams(params,"&");	
				},
				sendGestionesRedirectRC: function(params) {
					window.location.href = this.getPrivatePath() +  "/mis-consultas/index.jsp" + this.getRedirectParams(params,"?");	
				},	
				sendAsociarReservaRedirectRC: function(params) {				
					window.location.href = this.getPrivatePath() +  "/asignar-reserva/asignar-reserva.jsp" + this.getRedirectParams(params,"?");	
				},	
				sendPrecheckinRedirectRC: function(params) {				
					window.location.href = this.getPrivatePath() +  "/asignar-reserva/asignar-reserva.jsp?tab=precheckin" + this.getRedirectParams(params,"?");	
				},	
				sendTransferPointsRedirectRC: function(params) {				
					window.location.href = this.getPrivatePath() +  "/mis-puntos/index.jsp?modal=transfer-points" + this.getRedirectParams(params,"?");	
				},
				sendInvitarAmigoRedirectRC: function(params) {				
					window.location.href = this.getPrivatePath() +  "/mis-puntos/index.jsp?tab=invitar" + this.getRedirectParams(params,"?");	
				},			
				sendBeneficiariosRedirectRC: function(params) {				
					window.location.href = this.getPrivatePath() + "/mis-datos/index.jsp?tab=beneficiarios" + this.getRedirectParams(params,"?");	
				},
				sendSolicitarDuplicadoRedirectRC: function(params) {
					window.location.href = this.getPrivatePath() + "/wallet.jsp" + this.getRedirectParams(params,"?");	
				},
				sendMisDatosRedirectRC: function(params) {
					window.location.href = this.getPrivatePath() + "/mis-datos/index.jsp?tab=datos"  + this.getRedirectParams(params,"?");	
				},	
				urlMisDatos: function(params) {
					return this.getPrivatePath() + "/mis-datos/index.jsp?tab=datos"  + this.getRedirectParams(params,"?");	
				},
				sendContrasenaRedirectRC: function(params) {
					window.location.href = this.getPublicPath() + "/contrasena/contrasena.jsp" + this.getRedirectParams(params,"?");	
				},	
				sendFAQSRedirectRC: function(params) {
					window.location.href = this.getPublicPath() + "/consultas/index.jsp" + this.getRedirectParams(params,"?");	
				},
				sendAltaRC: function() {
					window.location.href = this.getPublicPath() + "/alta/alta.jsp";	
				},
				sendMacroReservasRC: function(ideHot) {
					window.location.href = constantes.serverS + "/idHotelInicio/"+ideHot+"/consultar-disponibilidad/";
				},
				sendMacroOfertas: function() {
					window.location.href =constantes.serverS + "/" + constantes.idioma +"/ofertas/home.jsp"; 
				},
				sendVentajas: function(tab) {
					window.location.href =constantes.serverS + "/" +  constantes.idioma + "/riu-class/ventajas/index.jsp?tab="+tab; 
				},
			wsError :  function( result, text ){
					var err = false;
					var msg = "";
					var service = this;
					if( typeof(result.classNameExceptionJson) != "undefined")
					{
						err  = true;
						var msg = "ws error";
						if (text!="")
						{
							riuService.showErrorMsg(text);
							return true;
						}
						if (typeof( result.keyTr ) !== "undefined" && result.keyTr != null)
						{
							msg = result.keyTr;
							riuService.showErrorMsg(msg);
						}
						else if (typeof( result.exception.key ) !== "undefined")
						{
							msg = result.exception.key;
							// $.when(this.getEtiquetas(result.exception.key)).done(function
							// (result) {
							this.getEtiquetas( result.exception.key ).then(function(result) {
								msg  = result[msg];
								riuService.showErrorMsg(msg);
							});
						}
						// errUserSession();
					}
					else if( typeof(result.errorID) != "undefined") {
						var errList = result.errorID.replace("error_ws.", "").split(":");
						var etq = "";
						angular.forEach(errList, function(err) { 
							etq = "error_ws."+err+"," + etq;
						});
						//etq = etq.replace("error_ws.error_ws.", "error_ws.");
						err  = true;
						var mensajeError = "";
						this.getEtiquetas( etq ).then(function(etiquetas) {
						//$.when(this.getEtiquetas(etq)).done(function (res) {
							angular.forEach(errList, function(err) { 
								var r = etiquetas[ "error_ws." + err];
								if (r && !r.match( "error_ws." + err)) {
									text = text + "<br>" + r;
									mensajeError  = mensajeError + "<br>" + r;
								}
							});
							mensajeError  = mensajeError != "" ? mensajeError  :text;
							if (result.errorID == "00000") {
								// Sesion RC caducada, recargamos los datos de
								// la sesion (B2C)
								//$rootScope.$broadcast("ReloadSession");
								//alert("Sessión caducada. Hay que decidir dónde ir");
								console.log(service.getPrivatePath());
								service.showPopupLogin(service.getMisPuntosURL());
							}
							else if (result.errorID == "00020" || result.errorID == "error.login_incorrecto") {
								// No autorizado, error login/pass
								riuService.showErrorMsg(text);
							}
							else if (result.errorID.match("CO") || result.errorID.match("US") || result.errorID.match("RP") || result.errorID.match("SG") ) {
								riuService.showErrorMsg("[" + result.errorID + "] " + mensajeError );
							}
							else {
								if( typeof(result.mensajeError) != "undefined") {
									riuService.showErrorMsg("[" + result.errorID + "] " + result.mensajeError);
								} else 	if( typeof(result.errorMensaje) != "undefined") {
									riuService.showErrorMsg("[" + result.errorID + "] " + result.errorMensaje );
								}
								else {
									riuService.showErrorMsg("[" + result.errorID + "] Connection refused" /*, function(){ riuService.sendHomeRedirect() }*/ );
								}
							}
	// else {
	// showInfoMsg("[" + result.errorID + "] Connection refused", function(){
	// riuService.sendHomeRedirect() } );
	// //riuclassService.showInfoMsg("[" + result.errorID + "] " + result.errorMensaje,
	// function(){ riuService.sendHomeRedirect() } );
	// }
						});
					}
					else if( typeof(result.error) != "undefined" && (!result.estado || result.estado == 'OK')){
						riuService.showErrorMsg(result.error);
					}
					return err ;
		},
		peticionAjax : function(urlLlamada) {
			var defer = $q.defer();
			$http.get(urlLlamada).success(function(data) {
				defer.resolve(data);
			}).error(function(data, status, headers, config) {
			});
			return defer.promise;
		},
		submitPost : function(urlLlamada, datos) {
			var defer = $q.defer();
			$http(
					{
						method : 'POST',
						url : urlLlamada,
						data : datos,
						headers : {
							'Content-Type' : 'application/x-www-form-urlencoded'
						}
					}).success(
					function(data, status, headers, config) {
						defer.resolve(data);
					}).error(
					function(data, status, headers, config) {
						console.log("Error :: "+data);
					});
			return defer.promise;
		},
		setAsignarReservaJSON: function(escapedData) {
			// var url = constantes.serverS +
			// "/riuclass-utils!asignarVisitaACuenta.action?formato=json&inputJSON="+escapedData;
			var url = constantes.serverS + "/riuclass-utils!asignarVisitaACuenta.action";
			var defer = $q.defer();
			var m = this.showLoadingMsg("loading...");
			console.log(escapedData);
			$http.post(url, escapedData, {withCredentials: true, headers: { 'Content-Type': 'application/x-www-form-urlencoded;'} }).success(function(data)
			{
				defer.resolve(data);
				m.close();
	    	}).error(function(data, status, headers, config) 
			{
				m.close();
			});
			return defer.promise;
	    },	 
		setAsignarReserva: function(form) {
			var m = this.showLoadingMsg("loading...");
			var url = constantes.serverS + "/riuclass-utils!asignarVisitaACuenta.action";
			var defer = $q.defer();
			var parameter;
			parameter = {
						 v: "web", 
						 idioma: constantes.idioma, 
						 "formato" : "json",
						 "tl.codCuenta" : form.codCuenta,
						 "asignarVisitaForm.bono" : form.bono,
						 "asignarVisitaForm.fechaEntradaAsString" : form.fechaEntradaAsString,
						 "asignarVisitaForm.fechaSalidaAsString" : form.fechaSalidaAsString,
						 "asignarVisitaForm.hotel" : form.hotel.ID,
						 "asignarVisitaForm.locres" : form.locres,
						 "asignarVisitaForm.numeroHab" : form.numeroHab
						 };
			var transform = function(data){
				return $.param(data);
			}			 
			$http.post( url, parameter,
					{withCredentials: true, headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'}, 
					transformRequest: transform
					})
			.success(function(data)
			{
				defer.resolve(data);
				m.close();
			})
			.error(function(data, status, headers, config) 
			{
				m.close();
			});	
			return defer.promise;
	    },
		setCambioPassword : function(form) {
			var m = this.showLoadingMsg("loading...");
			var defer = $q.defer();
			var parameter;
			url = constantes.serverS + "/riuclass-utils!cambioPassword.action";
			parameter = {
						 v: "web", 
						 idioma: constantes.idioma, 
						 "request.aspect" : "desk",
						 "formato" : "json",
						 "modificarPassRcForm.oldPwd": form.oldPwd,
						 "modificarPassRcForm.pwd": form.pwd,
						 "modificarPassRcForm.pwdRepetido": form.pwdRepetido};
			var transform = function(data){
				return $.param(data);
			}			 
			$http.post( url, parameter,
					{withCredentials: true, headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'}, 
					transformRequest: transform
					})
			.success(function(data)
			{
				defer.resolve(data);
				m.close();
			})
			.error(function(data, status, headers, config) 
			{
				m.close();
			});	
			return defer.promise;
		},
	    getEtiquetas: function(etiquetas) {
			var url = constantes.serverS + "/riuclass-utils!getEtiquetaByViewPublico.action?formato=json&tipo=mapa&listEtiquetas="+etiquetas+ "&idioma="+constantes.idioma+"&request.aspect=desk";
			var defer = $q.defer();
			$http.get(url, {withCredentials: true}).success(function(data)
			{
				defer.resolve(data);
	    	}).error(function(data, status, headers, config) 
			{
			});
			return defer.promise;
		},
		getListadoIdiomas: function() {
			var url = "/riuclass-utils!idiomasList.action?formato=json&idioma="+constantes.idioma+"&request.aspect=desk";
			var defer = $q.defer();
			$http.get(url, {withCredentials: true}).success(function(data)
			{
				defer.resolve(data);
	    	}).error(function(data, status, headers, config) 
			{
			});
			return defer.promise;
	    },
		setCasoSugarPublico: function(parameter) {
			var m = this.showLoadingMsg("loading...");
			var url = constantes.serverS + "/riuclass-utils!altaCasoSugarPublico.action";
			var defer = $q.defer();
			var transform = function(data){
				return $.param(data);
			}			 
			$http.post( url, parameter,
					{
						withCredentials: true, headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'}, 
						transformRequest: transform
					})
			.success(function(data)
			{
				defer.resolve(data);
				m.close();
			})
			.error(function(data, status, headers, config) 
			{
				m.close();
			});	
			return defer.promise;
	    },
	 	setCasoSugar: function(parameter) {
			var m = this.showLoadingMsg("loading...");
			var url = constantes.serverS + "/riuclass-utils!casosSugar.action";
			var defer = $q.defer();
			var transform = function(data){
				return $.param(data);
			}			 
			$http.post( url, parameter,
					{
						withCredentials: true, headers: {'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'}, 
						transformRequest: transform
					})
			.success(function(data)
			{
				defer.resolve(data);
				m.close();
			})
			.error(function(data, status, headers, config) 
			{
				m.close();
			});	
			return defer.promise;
	    }
	};
	});
/* Controller Template PARA ELIMINAR */
function ctrlPopupLoginRC($scope, $http, constantes, riuclassService, $rootScope, $window, ngDialog, $location) {
	$scope.usr = "";
	$scope.psw = "";
	$rootScope.FormUsr={usr:'', psw:'', url:''};
	$scope.login = function() {
	    if ($scope.frm.$valid) {
			//console.log($rootScope.FormUsr);
			//console.log($scope.ngDialogData);
			riuclassService.setLoginRC($rootScope.FormUsr.usr, $rootScope.FormUsr.psw).then(function(d) {
				console.log(d);
				riuclassService.getEtiquetas( 'error.login_incorrecto' ).then(function(etiquetas) {
					var msg = etiquetas["error.login_incorrecto"];
					var url = riuclassService.getMisPuntosURL();
					if (!riuclassService.wsError(d, msg))
					{
						//url = "";
						if ($scope.ngDialogData!=null)
						{
						//$scope.ngDialogData.url = window.location.href;
						console.log($location.hash());
						console.log($location.path());
						console.log($location.url());
						console.log($scope.ngDialogData.url);
						var iTag = $scope.ngDialogData.url.indexOf("#/");
						if (iTag > 0)
							$scope.ngDialogData.url = $scope.ngDialogData.url.substring(0, iTag);
						console.log($scope.ngDialogData.url);	
						//if (window.location.href == $scope.ngDialogData.url) 
						//	window.location.reload();
						//else
							//window.location.href = $scope.ngDialogData.url;
							url = $scope.ngDialogData.url;
						//	window.location.href = $scope.ngDialogData.url;
						 //$location.url( $scope.ngDialogData.url.replace("#" + $location.path(), "") );
						//}
						}
/*
						if(d.user && d.user.usuario && d.user.usuario.codEstadoDir 
								&& (d.user.usuario.codEstadoDir == 'E' || d.user.usuario.codEstadoDir == 'I' || d.user.usuario.codEstadoDir == 'P')){
							riuclassService.showMsgDatosIncompletos(url);
						}else{
							$rootScope.$broadcast("ReloadSession", {
				                		reload: true, url : url
				                	});
						}
*/
						riuclassService.validaDatosIncompletos( d.user.usuario , function(){	$rootScope.$broadcast("ReloadSession", {reload: true, url : url});} ) ;
					}
				});
			});
		}
  	}
	$scope.sendContrasenaRedirectRC = function() {
		riuclassService.sendContrasenaRedirectRC();
	}
	$scope.sendHeOlvidadoRedirectRC = function() {
		riuclassService.sendFAQSRedirectRC("id=002_002_053");
	}
	$scope.sendAltatRC = function() {
		riuclassService.sendAltaRC();
	}
}
function ctrlReservas($scope, $http, $window, riuClassSession, riuService, $rootScope) {
	$scope.loaded=null;
	$scope.$on('SessionUpdated', function(event, args) {
		$scope.RC = riuClassSession.riuclass;
		$scope.loaded=true;
	});
}


$(document).ready(function() {
	app.controller("ctrlSession", ["$scope", "$rootScope", "$http", "riuclassService", "riuService", "$q", "$window", "ngDialog", "constantes", "riuClassSession", "localStorageService", ctrlSession])
	app.controller("ctrlSession_ficha_login", ["$q", "$scope", "$http", "$window", "ngTableParams", "riuclassService", "riuService", "constantes", "riuClassSession", ctrlSession_ficha_login])
});
app.factory('riuClassSession', function($q, $http, riuclassService, riuService, constantes, ngDialog, $sce, $rootScope, $window, localStorageService ){
	var service = {};
	 service.riuclass = "";
	service.config = [];
	service.dateFormat = [];
	$rootScope.config = $window.config_rc;
	service.setSession = function(rc, config, dateFormat) {
		this.riuclass = null;
		if (angular.isUndefined(rc.errorID)) {
			this.riuclass = rc;
		}
		this.config = config;
		this.dateFormat = dateFormat;
		$rootScope.$broadcast("SessionUpdated");
	}	
	return service;
});
/* Controller principal */
function ctrlSession($scope, $rootScope, $http, riuclassService, riuService, $q, $window, ngDialog, constantes, riuClassSession, localStorageService) {
	$scope.riuClassDatosSession = {}; 
	$scope.recalcularDastosSession = true;
/*RIUPRO ENLACE*/
$rootScope.tipoUsrSesGen;
	$scope.setInfoUsuario = function(){
		var urlOfe = constantes.serverS + "/json-utils!user.action?formato=json";
        var defer = $q.defer();
        $http.get(urlOfe, {withCredentials: true}).success(function (data) {
            defer.resolve(data);
        }).error(function (data, status, headers, config) {
        });
        return defer.promise;
	}
	if(!$rootScope.tipoUsrSesGen){
		$rootScope.tipoUsrSesGen = 1;
		$scope.setInfoUsuario().then(d => {
	   		$rootScope.tipoUsrSesGen = d;
	   		if($rootScope.tipoUsrSesGen.agency &&  $rootScope.tipoUsrSesGen.agency.profile != 'RPC')
	   			$("#riuclass").addClass('hide');
	  	});
	}
/*RIUPRO ENLACE*/
	$scope.getUserSessionData = function() {
		var urUS= constantes.serverS + "/destinos-hoteles!datosUserWebMov.action?formato=json&v=web&idioma="+constantes.idioma+"&request.aspect=desk";
		var defer = $q.defer();
		$http.get(urUS, {withCredentials: true}).success(function(data)
		{
			defer.resolve(data);
		}).error(function(data, status, headers, config) 
		{
		});
		return defer.promise;
	}
	$scope.getPuntosUsuarios = function(forceReload) {
		var defer = $q.defer();
		var cache = {"date" : "", "data" : "" };
		var d = new Date();
		var reload = false;
		if (localStorageService.isSupported && !forceReload) {
			cache = localStorageService.get('pu');
			//cache = $.parseJSON( sessionStorage.getItem("pu") );
			if (cache == null) {
				reload = true;
			}
			else{
				var dcache = new Date();
				dcache.setTime( cache.date + 60000 );
				if (dcache < d.getTime()){
					// cache caducada
					reload = true;
				}else{
					// recuperamos los datos de la cache
					//riuClassSession.setSession(cache.data);
					//$scope.riuClassDatosSession = cache.data;
					defer.resolve(cache.data);
				}
			}
		}
		else  
			reload = true; 
		reload = true; 
		if (reload){
			var url = constantes.serverS + "/riuclass-utils!puntosUsuario.action?v=web&contexto=RC&formato=json&idioma="+constantes.idioma+"&request.aspect=desk";
			var defer = $q.defer();
			$http.get(url, {withCredentials: true}).success(function(data)
			{
				defer.resolve(data);
				cache = {"date" : "", "data" : "" };
				cache["date"] = d.getTime();
				cache["data"] = data;
				if (localStorageService.isSupported) {
					localStorageService.remove('pu');
					//sessionStorage.removeItem('pu');
					//if (data.codCuenta) 
					localStorageService.set('pu', cache);
					//sessionStorage.setItem('pu', JSON.stringify(cache));
				}
				//riuClassSession.setSession(data);
				//$scope.riuClassDatosSession = data;
				//console.info(data);
	    	}).error(function(data, status, headers, config) 
			{
			});
		}
		return defer.promise;
	}
	$q.all([$scope.getPuntosUsuarios(), $scope.getUserSessionData(), riuService.getDateTimeConfig() ]).then(function(d){
		$scope.riuClassDatosSession = d[0];
		$scope.config = d[1];
		riuClassSession.setSession(d[0], d[1], d[2]);
	});
	$scope.$on('ReloadSession', function(event, args) {
		var m = riuclassService.showLoadingMsg("");
		$scope.getPuntosUsuarios(true).then(function(d) {
        		$scope.riuClassDatosSession = d;
			if (args && args.url=="") {
				var h = window.location.href.replace("http:", "https:");
                                if(h.indexOf('valorar-reserva') > 0){
					window.history.back();
				}else if (window.location.href == h) {
					window.location.reload();
				}
				else {
					window.location.href = h;
				}
			}
			else if(args)
				window.location.href = args.url;
			m.close();
		});
    });
}
function ctrlSession_ficha_login($q, $scope, $http, $window,ngTableParams, riuclassService, riuService, constantes, riuClassSession) {
	$scope.RC = riuClassSession.riuclass;
	$scope.$on('SessionUpdated', function() {
        $scope.riuClassDatosSession = riuClassSession.riuclass;
	//	console.log($scope.RC);
	});
	$scope.logout = function() {
        riuclassService.setLogoutRC().then(function(d) {
			if(window.location.href.indexOf(constantes.privateFolder) > -1) {
				// Pagina privada
				$window.location = "/";
			}
			else {
				// Pagina publica
				$window.location.reload();
			}
        });
    }
	$scope.sendOpcionesMenuRC = function(p){
		if(p == 'MR')
			riuclassService.sendReservasRedirectRC();
		if(p == 'MP')
			riuclassService.sendMisPuntosRedirectRC();
		if(p == 'MC')
			riuclassService.sendConsultasRedirectRC();
		if(p == 'MD')
			riuclassService.sendMisDatosRedirectRC();
	}
	$scope.$on('SessionUpdated', function() {
        $scope.RC = riuClassSession.riuclass;
	});
}


